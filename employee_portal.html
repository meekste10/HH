<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HH Employee Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f7;
      margin: 0;
      padding: 32px 16px 48px;
      color: #333;
    }
    .max { max-width: 1080px; margin: 0 auto; }
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      margin: 0 0 24px 0;
    }
    h2 { margin-top: 0; font-size: 22px; font-weight: 600; }
    h3 { margin-top: 0; font-size: 18px; font-weight: 600; }

    label {
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px 12px;
      margin: 4px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
      background: #fff;
      font-family: inherit;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    button {
      padding: 10px 16px;
      background: #2d5be3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #224bc4; }

    #loginCard { max-width: 420px; margin: 0 auto 32px auto; }
    #dashboard { display: none; }

    .welcome { font-size: 20px; margin-bottom: 4px; font-weight: 600; color: #222; }
    .sub { font-size: 14px; color: #666; margin-bottom: 12px; }
    #loginError, #loadErrorDetails { font-size: 13px; margin-top: 6px; }
    #loginError { color: #c62828; display: none; }
    #loadErrorDetails { color: #888; display: none; }

    .tagline { font-size: 13px; color: #777; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .metric-label { color: #555; }
    .metric-value { font-weight: 600; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th { background: #fafafa; font-weight: 600; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: #eef1ff;
      color: #2444aa;
      margin-left: 4px;
    }
    .pill.vacation { background:#e8f5e9; color:#1b5e20; }
    .pill.sick { background:#fff3e0; color:#e65100; }
    .pill.unpaid { background:#f3e5f5; color:#6a1b9a; }
    .pill.hot { background:#ffebee; color:#b71c1c; }
    .pill.event { background:#e3f2fd; color:#0d47a1; }

    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    .tile {
      border-radius: 10px;
      padding: 12px 14px;
      border: 1px solid #e0e3f0;
      background: linear-gradient(135deg, #f9fafc, #f1f4ff);
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      color: #222;
      display: block;
      transition: transform 0.05s ease, box-shadow 0.05s ease, border-color 0.05s ease;
    }
    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      border-color: #c0c7ff;
    }
    .tile-title { font-weight: 600; margin-bottom: 4px; font-size: 13px; }
    .tile-sub  { font-size: 12px; color: #666; }

    .small-note { font-size: 11px; color: #999; margin-top: 6px; }
    .muted     { color: #777; font-size: 13px; }

    /* Contacts visual */
    .contacts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }
    .contact-card {
      border-radius: 10px;
      border: 1px solid #e3e5f0;
      padding: 10px 12px;
      background: #fafbff;
    }
    .contact-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .contact-role {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .contact-meta {
      font-size: 12px;
      color: #555;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .contact-meta a {
      color: #2d5be3;
      text-decoration: none;
    }
    .contact-meta a:hover {
      text-decoration: underline;
    }
    .contacts-footer {
      margin-top: 10px;
    }
    .contacts-link.tile {
      background: linear-gradient(135deg, #2d5be3, #1c3ea4);
      border-color: transparent;
      color: #fff;
    }
    .contacts-link .tile-title {
      color: #fff;
    }
    .contacts-link .tile-sub {
      color: #e0e6ff;
    }

    /* Outlook heat cells */
    .heat-cell {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
      display: inline-block;
    }
    .heat-cell.dept-low { background:#e8f5e9; color:#1b5e20; }
    .heat-cell.dept-med { background:#c8e6c9; color:#1b5e20; }
    .heat-cell.dept-high { background:#a5d6a7; color:#1b5e20; }
    .heat-cell.co-low { background:#e3f2fd; color:#0d47a1; }
    .heat-cell.co-med { background:#bbdefb; color:#0d47a1; }
    .heat-cell.co-high { background:#90caf9; color:#0d47a1; }

    @media (max-width: 640px) {
      body { padding: 24px 12px 40px; }
    }
  </style>
</head>

<body>
<div class="max">

  <!-- Login Card -->
  <div class="card" id="loginCard">
    <h2>Employee Login</h2>

    <label for="empSelect">Select your name</label>
    <select id="empSelect">
      <option value="">Loading employees...</option>
    </select>

    <label for="passcodeInput">Enter your 4-digit passcode</label>
    <input id="passcodeInput" type="password" maxlength="4" placeholder="0000" />

    <button id="loginBtn" type="button" style="width:100%; margin-top:8px;">Log In</button>

    <p id="loginError"></p>
    <p id="loadErrorDetails"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <!-- Header -->
    <div class="card">
      <div class="welcome" id="welcomeName"></div>
      <div class="sub" id="welcomeDept"></div>
      <p class="tagline">
        Prototype HH employee portal · Data here is a snapshot for exploration and planning, not a live HR system.
      </p>
    </div>

    <!-- Main grid: PTO + Simulator + Outlook -->
    <div class="grid">
      <!-- PTO Snapshot -->
      <div class="card" id="ptoCard">
        <h3>Your PTO Snapshot</h3>
        <div id="ptoSummary">
          <p class="muted">Loading PTO info...</p>
        </div>
      </div>

      <!-- PTO Request Simulator -->
      <div class="card" id="simCard">
        <h3>PTO Request Simulator <span class="pill">Demo</span></h3>
        <form id="simForm">
          <label for="simType">PTO Type</label>
          <select id="simType">
            <option value="vacation">Vacation</option>
            <option value="sick">Sick</option>
            <option value="unpaid">Unpaid</option>
          </select>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
            <div style="flex:1 1 150px;">
              <label for="simStart">Start date</label>
              <input type="date" id="simStart" />
            </div>
            <div style="flex:1 1 120px;">
              <label for="simStartHalf">Start</label>
              <select id="simStartHalf">
                <option value="AM">Full day (AM–PM)</option>
                <option value="PM">PM only (half-day)</option>
              </select>
            </div>
          </div>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
            <div style="flex:1 1 150px;">
              <label for="simEnd">End date</label>
              <input type="date" id="simEnd" />
            </div>
            <div style="flex:1 1 120px;">
              <label for="simEndHalf">End</label>
              <select id="simEndHalf">
                <option value="PM">Full day (AM–PM)</option>
                <option value="AM">AM only (half-day)</option>
              </select>
            </div>
          </div>

          <button type="button" id="simPreviewBtn" style="width:100%; margin-top:4px;">
            Preview PTO impact
          </button>
        </form>

        <div id="simResult" style="margin-top:12px; font-size:13px; color:#444;"></div>
        <p class="small-note">
          This simulator doesn’t submit real PTO requests. It’s a sandbox to see how a request would impact your balances.
        </p>
      </div>

      <!-- Team PTO Outlook -->
      <div class="card" id="outlookCard">
        <h3>Team PTO Outlook (Next 30 Days)</h3>
        <div id="outlookSummary">
          <p class="muted">Loading team PTO...</p>
        </div>
      </div>
    </div>

    <!-- Policies + Contacts -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>Policies & Resources</h3>
        <p class="muted" style="margin-bottom:10px;">
          Links can point to HTML versions of your existing Word/PDF docs.
        </p>
        <div class="tiles">
          <a class="tile" href="policy_pto.html">
            <div class="tile-title">PTO &amp; Time Off</div>
            <div class="tile-sub">How PTO accrues, how to request it, and key guardrails.</div>
          </a>
          <a class="tile" href="policy_benefits.html">
            <div class="tile-title">Health &amp; Benefits</div>
            <div class="tile-sub">Medical, dental, vision, and 401(k) snapshot.</div>
          </a>
          <a class="tile" href="policy_handbook.html">
            <div class="tile-title">Employee Handbook</div>
            <div class="tile-sub">Core expectations, values, and general policies.</div>
          </a>
          <a class="tile" href="policy_travel.html">
            <div class="tile-title">Travel &amp; Reimbursement</div>
            <div class="tile-sub">Per diem, mileage, and what’s reimbursable.</div>
          </a>
          <a class="tile" href="policy_holidays.html">
            <div class="tile-title">Holidays &amp; Office Closures</div>
            <div class="tile-sub">Observed holidays and standard closure dates.</div>
          </a>
        </div>
      </div>

      <div class="card" id="contactsCard">
        <h3>Your Team Contacts</h3>
        <div id="contactsSummary">
          <p class="muted">Loading team contacts...</p>
        </div>
        <div class="contacts-footer">
          <a class="tile contacts-link" href="contacts_dashboard.html">
            <div class="tile-title">Open Full Contacts Dashboard</div>
            <div class="tile-sub">View all departments, regions, and models in one place.</div>
          </a>
        </div>
      </div>
    </div>

    <!-- TMC Snapshot -->
    <div class="card" id="tmcCard">
      <h3>TMC Use Only – PTO Snapshot</h3>

      <div id="tmcBalances" style="margin-bottom:12px;"></div>
      <div id="tmcDates"></div>

      <p class="small-note">
        Mirrors the bottom box of the 2025 "Request for Time Off" form:
        beginning balances, days used YTD, future days approved, remaining balances,
        and the used / previously approved dates by PTO type and all types combined.
      </p>
    </div>

    <!-- PTO Request Form (Demo) -->
    <div class="card" id="ptoFormCard">
      <h3>PTO Request Form (Demo)</h3>
      <p class="muted" style="margin-top:0;">
        This mirrors the handwritten form. It pulls your current balances
        from the PTO snapshot and shows how a new request would affect them.
      </p>

      <div style="display:flex; flex-wrap:wrap; gap:12px;">
        <div style="flex:1 1 220px;">
          <label>Employee Name</label>
          <input type="text" id="formEmpName" readonly />
        </div>
        <div style="flex:1 1 180px;">
          <label>Department</label>
          <input type="text" id="formDept" readonly />
        </div>
        <div style="flex:1 1 220px;">
          <label>Supervisor</label>
          <input type="text" id="formSupervisor" readonly />
        </div>
      </div>

      <label for="formType">PTO Type</label>
      <select id="formType">
        <option value="vacation">Vacation</option>
        <option value="sick">Sick</option>
        <option value="unpaid">Unpaid</option>
      </select>

      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <div style="flex:1 1 150px;">
          <label for="formStart">Start date</label>
          <input type="date" id="formStart" />
        </div>
        <div style="flex:1 1 120px;">
          <label for="formStartHalf">Start</label>
          <select id="formStartHalf">
            <option value="AM">Full day (AM–PM)</option>
            <option value="PM">PM only (half-day)</option>
          </select>
        </div>
        <div style="flex:1 1 150px;">
          <label for="formEnd">End date</label>
          <input type="date" id="formEnd" />
        </div>
        <div style="flex:1 1 120px;">
          <label for="formEndHalf">End</label>
          <select id="formEndHalf">
            <option value="PM">Full day (AM–PM)</option>
            <option value="AM">AM only (half-day)</option>
          </select>
        </div>
      </div>

      <label for="formReason">Reason / Notes (optional)</label>
      <textarea id="formReason" placeholder="Family trip, appointment, etc."></textarea>

      <button type="button" id="formPreviewBtn" style="margin-top:4px;">
        Refresh request summary
      </button>

      <div id="formSummary" style="margin-top:12px; font-size:13px;"></div>
      <p class="small-note">
        This is a demo only: it does not submit or store actual PTO requests. It is
        meant to sit next to the paper form or a future e-signature flow.
      </p>
    </div>

  </div> <!-- /dashboard -->

</div> <!-- /max -->

<script>
  let employees = [];
  let ptoInfo = [];
  let contacts = [];
  let ptoRequests = [];
  let currentUser = null;

  // Key events for hotspots (edit these dates/names for real HH events)
  const keyEvents = [
    // { date: '2025-12-15', name: 'Q4 All-Staff Meeting' },
    // { date: '2026-01-10', name: 'Monthly All-Staff' },
    // { date: '2026-03-20', name: 'Annual HH Retreat' },
  ];

  // ---------- Load JSON data ----------
  async function loadAllData() {
    const loginError = document.getElementById('loginError');
    const loadErrorDetails = document.getElementById('loadErrorDetails');
    const empSelect = document.getElementById('empSelect');

    try {
      const [empRes, ptoRes, contactsRes, reqRes] = await Promise.all([
        fetch('employees.json'),
        fetch('pto_employee_info.json'),
        fetch('contacts.json'),
        fetch('pto_requests.json')
      ]);

      if (!empRes.ok) throw new Error('employees.json HTTP ' + empRes.status);
      if (!ptoRes.ok) throw new Error('pto_employee_info.json HTTP ' + ptoRes.status);

      employees = await empRes.json();
      ptoInfo   = await ptoRes.json();
      contacts  = contactsRes.ok ? await contactsRes.json() : [];
      ptoRequests = reqRes.ok ? await reqRes.json() : [];

      if (!Array.isArray(employees) || employees.length === 0) {
        throw new Error('employees.json is empty or not an array');
      }

      empSelect.innerHTML = '<option value="">Select your name...</option>';
      employees.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      employees.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.empId;
        opt.textContent = emp.name + (emp.department ? ' – ' + emp.department : '');
        empSelect.appendChild(opt);
      });

      loginError.style.display = 'none';
      loginError.textContent = '';
      loadErrorDetails.style.display = 'none';
      loadErrorDetails.textContent = '';

    } catch (err) {
      console.error('Error loading JSON data:', err);
      empSelect.innerHTML = '<option value="">Could not load employees</option>';
      loginError.textContent = 'Could not load portal data. Check JSON files and how this page is being served.';
      loginError.style.display = 'block';
      loadErrorDetails.textContent = String(err.message || err);
      loadErrorDetails.style.display = 'block';
    }
  }

  // ---------- Login ----------
  function setupLogin() {
    const loginBtn = document.getElementById('loginBtn');
    const dropdown = document.getElementById('empSelect');
    const passcodeInput = document.getElementById('passcodeInput');
    const loginError = document.getElementById('loginError');

    loginBtn.addEventListener('click', () => {
      loginError.style.display = 'none';
      loginError.textContent = '';

      const selectedId = dropdown.value;
      const passcode = passcodeInput.value.trim();

      if (!selectedId || !passcode) {
        loginError.textContent = 'Please select your name and enter your passcode.';
        loginError.style.display = 'block';
        return;
      }

      const user = employees.find(e => e.empId === selectedId);
      if (!user || (user.passcode && user.passcode !== passcode)) {
        loginError.textContent = 'Incorrect passcode. Please try again.';
        loginError.style.display = 'block';
        return;
      }

      currentUser = user;
      showDashboard();
    });

    passcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });
  }

  // ---------- Helpers ----------
  function findPtoRecord(empId) {
    if (!Array.isArray(ptoInfo)) return null;
    return ptoInfo.find(r => r.empId === empId || r.name?.includes(empId));
  }

  function getBalances() {
    const record = findPtoRecord(currentUser.empId);
    if (!record) return {
      vacationAvailable: 0,
      sickAvailable: 0,
      unpaidAvailable: 0,
      vacationBeginning: 0,
      sickBeginning: 0,
      unpaidBeginning: 0,
      vacationUsed: 0,
      sickUsed: 0,
      unpaidUsed: 0,
      futureVacationApproved: 0,
      futureSickDays: 0,
      futureUnpaidDays: 0
    };
    const b = record.balances || {};
    return {
      vacationAvailable: Number(b.vacationAvailable ?? 0),
      sickAvailable: Number(b.sickAvailable ?? 0),
      unpaidAvailable: Number(b.unpaidAvailable ?? 0),
      vacationBeginning: Number(b.vacationBeginning ?? 0),
      sickBeginning: Number(b.sickBeginning ?? 0),
      unpaidBeginning: Number(b.unpaidBeginning ?? 0),
      vacationUsed: Number(b.vacationUsed ?? 0),
      sickUsed: Number(b.sickUsed ?? 0),
      unpaidUsed: Number(b.unpaidUsed ?? 0),
      futureVacationApproved: Number(b.futureVacationApproved ?? 0),
      futureSickDays: Number(b.futureSickDays ?? 0),
      futureUnpaidDays: Number(b.futureUnpaidDays ?? 0)
    };
  }

  function parseDate(mdyString) {
    if (!mdyString) return null;
    const parts = mdyString.split('/');
    if (parts.length < 3) return null;
    let [m, d, y] = parts.map(p => p.trim());
    m = Number(m); d = Number(d); y = Number(y);
    if (y < 100) y = 2000 + y;
    const dt = new Date(y, m - 1, d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function toISODate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function diffDaysInclusive(start, end) {
    const msPerDay = 24 * 60 * 60 * 1000;
    const diff = (end - start) / msPerDay;
    return diff >= 0 ? diff + 1 : 0;
  }

  function formatISOForDisplay(dateStr) {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  }

  // ---------- PTO Summary ----------
  function renderPtoSummary() {
    const container = document.getElementById('ptoSummary');
    const record = findPtoRecord(currentUser.empId);

    if (!record) {
      container.innerHTML = '<p class="muted">No PTO data found for your profile.</p>';
      return;
    }

    const b = record.balances || {};
    container.innerHTML = `
      <div class="metric-row">
        <span class="metric-label">Vacation Available</span>
        <span class="metric-value">${(b.vacationAvailable ?? 0).toFixed(2)} days</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Sick Available</span>
        <span class="metric-value">${(b.sickAvailable ?? 0).toFixed(2)} days</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Unpaid Available</span>
        <span class="metric-value">${(b.unpaidAvailable ?? 0).toFixed(2)} days</span>
      </div>
      <hr style="border:none; border-top:1px solid #eee; margin:12px 0;">
      <p class="small-note">
        Totals shown here reflect the last PTO snapshot loaded into this portal.
      </p>
    `;
  }

  // ---------- PTO Simulator ----------
  function setupSimulator() {
    const btn = document.getElementById('simPreviewBtn');
    const result = document.getElementById('simResult');

    btn.addEventListener('click', () => {
      if (!currentUser) return;

      const type = document.getElementById('simType').value;
      const startStr = document.getElementById('simStart').value;
      const endStr = document.getElementById('simEnd').value;
      const startHalf = document.getElementById('simStartHalf').value;
      const endHalf = document.getElementById('simEndHalf').value;

      if (!startStr || !endStr) {
        result.innerHTML = `<span style="color:#c62828;">Select both a start and end date.</span>`;
        return;
      }

      const start = new Date(startStr);
      const end = new Date(endStr);
      if (isNaN(start.getTime()) || isNaN(end.getTime()) || end < start) {
        result.innerHTML = `<span style="color:#c62828;">End date must be the same or after the start date.</span>`;
        return;
      }

      let days = diffDaysInclusive(start, end);
      if (startHalf === 'PM') days -= 0.5;
      if (endHalf === 'AM') days -= 0.5;
      if (days < 0) days = 0;

      const b = getBalances();
      let available = 0;
      let label = '';

      if (type === 'vacation') { available = b.vacationAvailable; label = 'Vacation'; }
      else if (type === 'sick') { available = b.sickAvailable; label = 'Sick'; }
      else { available = b.unpaidAvailable; label = 'Unpaid'; }

      const remaining = available - days;
      const pillClass = type === 'vacation' ? 'vacation' : type === 'sick' ? 'sick' : 'unpaid';

      result.innerHTML = `
        <p style="margin:0 0 6px 0;">
          Requesting <strong>${days.toFixed(2)} days</strong> of
          <strong>${label}</strong> PTO
          <span class="pill ${pillClass}">${label}</span>
        </p>
        <p style="margin:0;">
          Available now: <strong>${available.toFixed(2)} days</strong><br/>
          After this request: <strong>${remaining.toFixed(2)} days</strong>
          ${remaining < 0 ? '<br/><span style="color:#c62828;">(This would exceed your current available balance.)</span>' : ''}
        </p>
      `;
    });
  }

  // ---------- Team PTO Outlook (Next 30 days, dept + company + hotspots) ----------
  function renderOutlook() {
    const container = document.getElementById('outlookSummary');

    if (!Array.isArray(ptoRequests) || ptoRequests.length === 0) {
      container.innerHTML = '<p class="muted">No PTO requests loaded yet.</p>';
      return;
    }

    const dept = currentUser.department;
    const msPerDay = 24 * 60 * 60 * 1000;
    const today = new Date();
    const windowStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const windowDays = 30;
    const windowEnd = new Date(windowStart.getTime() + (windowDays - 1) * msPerDay);

    const keyEventMap = {};
    keyEvents.forEach(ev => {
      if (!ev.date) return;
      if (!keyEventMap[ev.date]) keyEventMap[ev.date] = [];
      keyEventMap[ev.date].push(ev.name);
    });

    // Aggregate by day
    const bucket = {}; // dateStr -> { deptCount, companyCount, events[] }

    function ensureBucket(dateStr) {
      if (!bucket[dateStr]) {
        bucket[dateStr] = { deptCount: 0, companyCount: 0, events: keyEventMap[dateStr] ? [...keyEventMap[dateStr]] : [] };
      }
      return bucket[dateStr];
    }

    const upcomingForUser = [];

    ptoRequests.forEach(r => {
      const rawStart = r.startDate || r["PTO Request Start Date"];
      const rawEnd   = r.endDate || r["PTO Request End Date"] || rawStart;
      if (!rawStart) return;

      // Parse from M/D/YY style first; fall back to Date()
      let start = parseDate(rawStart);
      let end   = parseDate(rawEnd);
      if (!start) start = new Date(rawStart);
      if (!end)   end   = new Date(rawEnd);
      if (isNaN(start.getTime()) || isNaN(end.getTime())) return;

      // Normalize order
      if (end < start) {
        const tmp = start;
        start = end;
        end = tmp;
      }

      // Skip if outside window
      if (end < windowStart || start > windowEnd) return;

      const clampedStart = start < windowStart ? windowStart : start;
      const clampedEnd   = end > windowEnd ? windowEnd : end;

      // Track if this belongs to current user
      const id = (r.empId || "").toString().toLowerCase();
      const currentId = currentUser.empId.toString().toLowerCase();
      if (id === currentId) {
        upcomingForUser.push({
          startStr: rawStart,
          endStr: rawEnd,
          type: r.type || r["PTO Request Type"] || '',
          totalDays: Number(r.totalDays ?? r["PTO Request Total Days"] ?? 0)
        });
      }

      // Walk each day in the window
      for (
        let d = new Date(clampedStart.getTime());
        d <= clampedEnd;
        d = new Date(d.getTime() + msPerDay)
      ) {
        const dateKey = toISODate(d);
        const b = ensureBucket(dateKey);
        b.companyCount += 1;
        if ((r.department || '').toString() === dept) {
          b.deptCount += 1;
        }
      }
    });

    const days = Object.keys(bucket)
      .sort()
      .map(dateStr => ({ dateStr, ...bucket[dateStr] }));

    if (days.length === 0) {
      container.innerHTML = `
        <p class="muted">
          No PTO scheduled for your department or the company in the next 30 days
          (based on the loaded PTO Requests snapshot).
        </p>
      `;
      return;
    }

    // Determine thresholds for "hot" days
    const deptCounts = days.map(d => d.deptCount);
    const companyCounts = days.map(d => d.companyCount);
    const deptMax = Math.max(...deptCounts);
    const companyMax = Math.max(...companyCounts);

    const deptHotThreshold = Math.max(2, Math.ceil(deptMax * 0.5));      // dept "busy"
    const companyHotThreshold = Math.max(4, Math.ceil(companyMax * 0.4)); // company "busy"

    function deptHeatClass(count) {
      if (!count) return '';
      if (count >= deptHotThreshold) return 'dept-high';
      if (count >= 2) return 'dept-med';
      return 'dept-low';
    }

    function coHeatClass(count) {
      if (!count) return '';
      if (count >= companyHotThreshold) return 'co-high';
      if (count >= 3) return 'co-med';
      return 'co-low';
    }

    // Sort days by importance (hotspots first, then chronological)
    const scoredDays = days.map(d => {
      const flags = [];
      if (d.deptCount >= deptHotThreshold) flags.push('Dept hotspot');
      if (d.companyCount >= companyHotThreshold) flags.push('Company hotspot');
      if (d.events && d.events.length && d.companyCount > 0) flags.push('Key event + PTO');
      const score = d.deptCount * 2 + d.companyCount + (flags.length * 2);
      return { ...d, flags, score };
    }).sort((a, b) => b.score - a.score || (a.dateStr.localeCompare(b.dateStr)));

    const topImportant = scoredDays.slice(0, 10).sort((a,b) => a.dateStr.localeCompare(b.dateStr));

    const overviewRows = topImportant.map(d => {
      const deptClass = deptHeatClass(d.deptCount);
      const coClass   = coHeatClass(d.companyCount);
      const deptCell = d.deptCount
        ? `<span class="heat-cell ${deptClass}">${d.deptCount}</span>`
        : '<span class="muted">0</span>';
      const coCell = d.companyCount
        ? `<span class="heat-cell ${coClass}">${d.companyCount}</span>`
        : '<span class="muted">0</span>';

      const flagsPieces = [];
      if (d.deptCount >= deptHotThreshold) {
        flagsPieces.push('<span class="pill hot">Dept hotspot</span>');
      }
      if (d.companyCount >= companyHotThreshold) {
        flagsPieces.push('<span class="pill hot">Company hotspot</span>');
      }
      if (d.events && d.events.length) {
        flagsPieces.push('<span class="pill event">Key event</span>');
      }

      const flagsHtml = flagsPieces.join(' ');

      const eventNames = (d.events && d.events.length)
        ? `<div class="small-note">Events: ${d.events.join(', ')}</div>`
        : '';

      return `
        <tr>
          <td>
            ${formatISOForDisplay(d.dateStr)}
            ${eventNames}
          </td>
          <td>${deptCell}</td>
          <td>${coCell}</td>
          <td>${flagsHtml || '<span class="muted">—</span>'}</td>
        </tr>
      `;
    }).join('');

    // My upcoming PTO list (within the same 30-day window)
    upcomingForUser.sort((a, b) => {
      const pa = parseDate(a.startStr) || new Date(a.startStr);
      const pb = parseDate(b.startStr) || new Date(b.startStr);
      return pa - pb;
    });
    const myRows = upcomingForUser.slice(0, 5).map(r => `
      <tr>
        <td>${r.startStr}${(r.endStr && r.endStr !== r.startStr) ? ' – ' + r.endStr : ''}</td>
        <td>${(r.totalDays || 0).toFixed(2)}</td>
        <td>${r.type}</td>
      </tr>
    `).join('');

    container.innerHTML = `
      <h4 style="margin:0 0 6px 0; font-size:15px;">At a glance – days to watch</h4>
      <table>
        <thead>
          <tr>
            <th style="width:36%;">Date</th>
            <th style="width:18%;">Dept Out</th>
            <th style="width:18%;">Company Out</th>
            <th style="width:28%;">Flags</th>
          </tr>
        </thead>
        <tbody>
          ${overviewRows}
        </tbody>
      </table>
      <p class="small-note">
        Hotspots are based on the next 30 days of PTO requests. Thresholds scale with how busy your department
        and the company actually are in the loaded data.
      </p>

      <hr style="border:none; border-top:1px solid #eee; margin:10px 0;">

      <h4 style="margin:0 0 6px 0; font-size:15px;">Your upcoming PTO (from snapshot)</h4>
      ${upcomingForUser.length === 0
        ? '<p class="muted">No upcoming PTO found for you in this 30-day window.</p>'
        : `
            <table>
              <thead>
                <tr>
                  <th>Dates</th>
                  <th>Days</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>${myRows}</tbody>
            </table>
          `
      }
    `;
  }

  // ---------- Contacts (sleeker visual + dashboard tile) ----------
  function renderContacts() {
    const container = document.getElementById('contactsSummary');

    if (!Array.isArray(contacts) || contacts.length === 0) {
      container.innerHTML = '<p class="muted">Team contact directory coming soon.</p>';
      return;
    }

    const dept = currentUser.department;
    const team = contacts.filter(c => c.department === dept);

    if (team.length === 0) {
      container.innerHTML = '<p class="muted">No contact records found for your department yet.</p>';
      return;
    }

    const cards = team.map(c => {
      const name = c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim();
      const region = c.region || '';
      const deptLabel = c.department || '';
      const metaLine = [deptLabel, region].filter(Boolean).join(' · ');

      return `
        <div class="contact-card">
          <div class="contact-name">${name}</div>
          <div class="contact-role">${metaLine || '&nbsp;'}</div>
          <div class="contact-meta">
            ${c.email ? `<a href="mailto:${c.email}">${c.email}</a>` : ''}
            ${c.workNumber ? `<span>${c.workNumber}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = `
      <div class="contacts-grid">
        ${cards}
      </div>
      <p class="small-note">
        This view is scoped to your department. Use the Contacts Dashboard to explore across the whole company.
      </p>
    `;
  }

  // ---------- TMC snapshot helpers ----------
  function splitRequestsByTiming() {
    if (!Array.isArray(ptoRequests)) return { past: [], future: [] };

    const now = new Date();
    const myReqs = ptoRequests.filter(r => {
      const id = (r.empId || "").toString().toLowerCase();
      return id === currentUser.empId.toString().toLowerCase();
    });

    const past = [];
    const future = [];

    myReqs.forEach(r => {
      const startStr = r.startDate || r["PTO Request Start Date"];
      const endStr = r.endDate || r["PTO Request End Date"] || startStr;

      const start = parseDate(startStr) || new Date(startStr);
      const end = parseDate(endStr) || new Date(endStr);
      if (!start || isNaN(start.getTime())) return;

      const type = (r.type || r["PTO Request Type"] || "").toLowerCase();
      const totalDays = Number(r.totalDays ?? r["PTO Request Total Days"] ?? 0);
      const obj = { type, startStr, endStr, totalDays };

      if (end < now) past.push(obj); else future.push(obj);
    });

    return { past, future };
  }

  function formatDateRange(r) {
    if (!r) return "";
    if (!r.endStr || r.endStr === r.startStr) return r.startStr || "";
    return `${r.startStr}–${r.endStr}`;
  }

  function renderTmcSnapshot() {
    const balancesDiv = document.getElementById('tmcBalances');
    const datesDiv = document.getElementById('tmcDates');

    const rec = findPtoRecord(currentUser.empId);
    if (!rec) {
      balancesDiv.innerHTML = '<p class="muted">No PTO balance data found for this employee.</p>';
      datesDiv.innerHTML = '';
      return;
    }

    const b = getBalances();
    const { past, future } = splitRequestsByTiming();

    const pastVacation = past.filter(r => r.type === 'vacation');
    const pastSick     = past.filter(r => r.type === 'sick');
    const pastUnpaid   = past.filter(r => r.type === 'unpaid');

    const futureVacation = future.filter(r => r.type === 'vacation');
    const futureSick     = future.filter(r => r.type === 'sick');
    const futureUnpaid   = future.filter(r => r.type === 'unpaid');

    const joinRanges = (arr) => arr.map(formatDateRange).filter(Boolean).join(', ');

    const allPast   = [...pastVacation, ...pastSick, ...pastUnpaid];
    const allFuture = [...futureVacation, ...futureSick, ...futureUnpaid];

    balancesDiv.innerHTML = `
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Vacation</th>
            <th>Sick</th>
            <th>Unpaid</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>2025 Beginning Balances</strong></td>
            <td>${b.vacationBeginning.toFixed(2)}</td>
            <td>${b.sickBeginning.toFixed(2)}</td>
            <td>${b.unpaidBeginning.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Days Used YTD</strong></td>
            <td>${b.vacationUsed.toFixed(2)}</td>
            <td>${b.sickUsed.toFixed(2)}</td>
            <td>${b.unpaidUsed.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Future Days Approved</strong></td>
            <td>${b.futureVacationApproved.toFixed(2)}</td>
            <td>${b.futureSickDays.toFixed(2)}</td>
            <td>${b.futureUnpaidDays.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>2025 Remaining Balances</strong></td>
            <td>${b.vacationAvailable.toFixed(2)}</td>
            <td>${b.sickAvailable.toFixed(2)}</td>
            <td>${b.unpaidAvailable.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
    `;

    datesDiv.innerHTML = `
      <div style="margin-top:10px; font-size:13px;">
        <p><strong>Vacation Dates Used:</strong> ${joinRanges(pastVacation) || '<span class="muted">None recorded</span>'}</p>
        <p><strong>Vacation Dates Previously Approved (Future):</strong> ${joinRanges(futureVacation) || '<span class="muted">None recorded</span>'}</p>

        <p><strong>Sick Dates Used:</strong> ${joinRanges(pastSick) || '<span class="muted">None recorded</span>'}</p>
        <p><strong>Sick Dates Previously Approved (Future):</strong> ${joinRanges(futureSick) || '<span class="muted">None recorded</span>'}</p>

        <p><strong>Unpaid Dates Used:</strong> ${joinRanges(pastUnpaid) || '<span class="muted">None recorded</span>'}</p>
        <p><strong>Unpaid Dates Previously Approved (Future):</strong> ${joinRanges(futureUnpaid) || '<span class="muted">None recorded</span>'}</p>

        <hr style="border:none; border-top:1px solid #eee; margin:10px 0;">

        <p><strong>All Dates Used (All Types):</strong> ${joinRanges(allPast) || '<span class="muted">None recorded</span>'}</p>
        <p><strong>All Dates Previously Approved (All Types):</strong> ${joinRanges(allFuture) || '<span class="muted">None recorded</span>'}</p>
      </div>
    `;
  }

  // ---------- PTO Request Form (demo) ----------
  function setupPtoForm() {
    const nameInput = document.getElementById('formEmpName');
    const deptInput = document.getElementById('formDept');
    const supInput  = document.getElementById('formSupervisor');

    nameInput.value = currentUser.name || '';
    deptInput.value = currentUser.department || '';
    supInput.value  = currentUser.directReport || '';

    ['formType','formStart','formEnd','formStartHalf','formEndHalf','formReason'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', renderPtoFormSummary);
      el.addEventListener('input', renderPtoFormSummary);
    });

    document.getElementById('formPreviewBtn')
      .addEventListener('click', renderPtoFormSummary);

    renderPtoFormSummary();
  }

  function renderPtoFormSummary() {
    const container = document.getElementById('formSummary');
    const type = document.getElementById('formType').value;
    const startStr = document.getElementById('formStart').value;
    const endStr   = document.getElementById('formEnd').value;
    const startHalf = document.getElementById('formStartHalf').value;
    const endHalf   = document.getElementById('formEndHalf').value;

    if (!startStr || !endStr) {
      container.innerHTML = '<span class="muted">Choose a start and end date to see request details.</span>';
      return;
    }

    const start = new Date(startStr);
    const end   = new Date(endStr);
    if (isNaN(start.getTime()) || isNaN(end.getTime()) || end < start) {
      container.innerHTML = '<span style="color:#c62828;">End date must be the same or after the start date.</span>';
      return;
    }

    let days = diffDaysInclusive(start, end);
    if (startHalf === 'PM') days -= 0.5;
    if (endHalf === 'AM')   days -= 0.5;
    if (days < 0) days = 0;

    const b = getBalances();

    let label, begin, used, futureApproved, available;
    if (type === 'vacation') {
      label = 'Vacation';
      begin = b.vacationBeginning;
      used  = b.vacationUsed;
      futureApproved = b.futureVacationApproved;
      available = b.vacationAvailable;
    } else if (type === 'sick') {
      label = 'Sick';
      begin = b.sickBeginning;
      used  = b.sickUsed;
      futureApproved = b.futureSickDays;
      available = b.sickAvailable;
    } else {
      label = 'Unpaid';
      begin = b.unpaidBeginning;
      used  = b.unpaidUsed;
      futureApproved = b.futureUnpaidDays;
      available = b.unpaidAvailable;
    }

    const newUsed = used + days;
    const newFutureApproved = futureApproved + days;
    const remainingIfApproved = available - days;

    const warning = remainingIfApproved < 0
      ? `<p style="color:#c62828; margin:6px 0 0 0;">
           This request would exceed your current available ${label.toLowerCase()} balance
           by ${Math.abs(remainingIfApproved).toFixed(2)} days.
         </p>`
      : '';

    container.innerHTML = `
      <p style="margin:0 0 6px 0;">
        Requesting <strong>${days.toFixed(2)}</strong> day(s) of <strong>${label}</strong> PTO.
      </p>
      <p style="margin:0 0 10px 0; font-size:13px;">
        Dates out: <strong>${startStr}</strong>${endStr && endStr !== startStr ? ' – <strong>' + endStr + '</strong>' : ''}
        <br/>
        This would be added to your 2025 ${label.toLowerCase()} usage and "previously approved" totals.
      </p>

      <table>
        <thead>
          <tr>
            <th></th>
            <th>${label}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>2025 Beginning Balance</strong></td>
            <td>${begin.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Days Used YTD (before this request)</strong></td>
            <td>${used.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Days Used YTD (including this request)</strong></td>
            <td>${newUsed.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Future Days Previously Approved</strong></td>
            <td>${futureApproved.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Future Days Approved (if this is signed)</strong></td>
            <td>${newFutureApproved.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Available Balance Today</strong></td>
            <td>${available.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Balance If Approved</strong></td>
            <td>${remainingIfApproved.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
      ${warning}
    `;
  }

  // ---------- Show dashboard ----------
  function showDashboard() {
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    const welcomeName = document.getElementById('welcomeName');
    const welcomeDept = document.getElementById('welcomeDept');

    welcomeName.textContent = `Welcome, ${currentUser.name}`;
    const dept = currentUser.department || '';
    const dr   = currentUser.directReport || '';
    welcomeDept.textContent = dept ? (dr ? `${dept} · Reports to ${dr}` : dept) : '';

    renderPtoSummary();
    renderOutlook();
    renderContacts();
    renderTmcSnapshot();
    setupPtoForm();
  }

  // ---------- Boot ----------
  document.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    setupLogin();
    setupSimulator();
  });
</script>

</body>
</html>
