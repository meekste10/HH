<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HH Employee Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f7;
      margin: 0;
      padding: 32px 16px 48px;
      color: #333;
    }
    .max { max-width: 1080px; margin: 0 auto; }
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      margin: 0 0 24px 0;
    }
    h2 { margin-top: 0; font-size: 22px; font-weight: 600; }
    h3 { margin-top: 0; font-size: 18px; font-weight: 600; }
    h4 { margin: 0 0 6px 0; font-size: 15px; font-weight: 600; }

    label {
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px 12px;
      margin: 4px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
      background: #fff;
      font-family: inherit;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    button {
      padding: 10px 16px;
      background: #2d5be3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #224bc4; }

    #loginCard { max-width: 420px; margin: 0 auto 32px auto; }
    #dashboard { display: none; }

    .welcome { font-size: 20px; margin-bottom: 4px; font-weight: 600; color: #222; }
    .sub { font-size: 14px; color: #666; margin-bottom: 12px; }

    #loginError, #loadErrorDetails {
      font-size: 13px;
      margin-top: 6px;
    }
    #loginError { color: #c62828; display: none; }
    #loadErrorDetails { color: #888; display: none; }

    .tagline { font-size: 13px; color: #777; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .metric-label { color: #555; }
    .metric-value { font-weight: 600; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }
    th { background: #fafafa; font-weight: 600; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: #eef1ff;
      color: #2444aa;
      margin-left: 4px;
    }
    .pill.vacation { background:#e8f5e9; color:#1b5e20; }
    .pill.sick     { background:#fff3e0; color:#e65100; }
    .pill.unpaid   { background:#f3e5f5; color:#6a1b9a; }
    .pill.hot      { background:#ffebee; color:#b71c1c; }
    .pill.event    { background:#e3f2fd; color:#0d47a1; }

    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    .tile {
      border-radius: 10px;
      padding: 12px 14px;
      border: 1px solid #e0e3f0;
      background: linear-gradient(135deg, #f9fafc, #f1f4ff);
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      color: #222;
      display: block;
      transition: transform 0.05s ease, box-shadow 0.05s ease, border-color 0.05s ease;
    }
    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      border-color: #c0c7ff;
    }
    .tile-title { font-weight: 600; margin-bottom: 4px; font-size: 13px; }
    .tile-sub  { font-size: 12px; color: #666; }

    .small-note { font-size: 11px; color: #999; margin-top: 6px; }
    .muted     { color: #777; font-size: 13px; }

    /* Contacts visual */
    .contacts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }
    .contact-card {
      border-radius: 10px;
      border: 1px solid #e3e5f0;
      padding: 10px 12px;
      background: #fafbff;
    }
    .contact-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .contact-role {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .contact-meta {
      font-size: 13px;
      color: #555;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .contact-meta a {
      color: #2d5be3;
      text-decoration: none;
    }
    .contact-meta a:hover {
      text-decoration: underline;
    }
    .contact-phone {
      font-size: 13px;
      font-weight: 600;
    }
    .contacts-footer {
      margin-top: 10px;
    }
    .contacts-link.tile {
      background: linear-gradient(135deg, #2d5be3, #1c3ea4);
      border-color: transparent;
      color: #fff;
    }
    .contacts-link .tile-title { color: #fff; }
    .contacts-link .tile-sub   { color: #e0e6ff; }

    /* Outlook heat bubbles */
    .heat-cell {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
      display: inline-block;
      cursor: pointer;
    }
    .heat-cell.dept-low  { background:#e8f5e9; color:#1b5e20; }
    .heat-cell.dept-med  { background:#c8e6c9; color:#1b5e20; }
    .heat-cell.dept-high { background:#a5d6a7; color:#1b5e20; }
    .heat-cell.co-low    { background:#e3f2fd; color:#0d47a1; }
    .heat-cell.co-med    { background:#bbdefb; color:#0d47a1; }
    .heat-cell.co-high   { background:#90caf9; color:#0d47a1; }

    .holiday-label {
      font-size: 11px;
      color: #0d47a1;
      margin-top: 2px;
    }

    #outlookDetails {
      margin-top: 8px;
      font-size: 12px;
      color: #333;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      background: #fafafa;
    }
    #outlookDetails h5 {
      margin: 0 0 4px 0;
      font-size: 13px;
      font-weight: 600;
    }
    #outlookDetails ul {
      margin: 0;
      padding-left: 18px;
    }

    /* Benefits card */
    .benefits-premium-row { margin-top: 6px; }
    .benefits-premium-bars {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }
    .benefits-premium-bar-label {
      width: 110px;
      font-size: 13px;
      color: #555;
    }
    .benefits-premium-bar-track {
      flex: 1;
      height: 20px;
      border-radius: 999px;
      background: #f1f3fb;
      border: 1px solid #e0e3f0;
      overflow: hidden;
    }
    .benefits-premium-bar {
      height: 100%;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      font-size: 12px;
      font-weight: 600;
    }
    .benefits-premium-bar.uhc {
      background: linear-gradient(90deg, #f97373, #ef4444);
      color: #fff;
    }
    .benefits-premium-bar.bcbs {
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      color: #fff;
    }
    .benefits-mini-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    .benefits-list {
      margin: 4px 0 0 16px;
      padding: 0;
      font-size: 13px;
      color: #555;
    }
    .benefits-list li { margin-bottom: 3px; }

    @media (max-width: 640px) {
      body { padding: 24px 12px 40px; }
    }
  </style>
</head>

<body>
<div class="max">

  <!-- Login Card -->
  <div class="card" id="loginCard">
    <h2>Employee Login</h2>

    <label for="empSelect">Select your name</label>
    <select id="empSelect">
      <option value="">Loading employees...</option>
    </select>

    <label for="passcodeInput">Enter your 4-digit passcode</label>
    <input id="passcodeInput" type="password" maxlength="4" placeholder="0000" />

    <button id="loginBtn" type="button" style="width:100%; margin-top:8px;">Log In</button>

    <p id="loginError"></p>
    <p id="loadErrorDetails"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <!-- Header -->
    <div class="card">
      <div class="welcome" id="welcomeName"></div>
      <div class="sub" id="welcomeDept"></div>
      <p class="tagline">
        Your Holland Homes PTO, benefits, & contacts hub.
      </p>
    </div>

    <!-- Main grid: PTO summary + simulator + outlook -->
    <div class="grid">
      <!-- PTO Snapshot (simple top-level) -->
      <div class="card" id="ptoCard">
        <h3>Your PTO Snapshot</h3>
        <div id="ptoSummary">
          <p class="muted">Loading PTO info...</p>
        </div>
      </div>

      <!-- PTO Request Simulator -->
      <div class="card" id="simCard">
        <h3>PTO Request Simulator</h3>
        <form id="simForm">
          <label for="simType">PTO Type</label>
          <select id="simType">
            <option value="vacation">Vacation</option>
            <option value="sick">Sick</option>
            <option value="unpaid">Unpaid</option>
          </select>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
            <div style="flex:1 1 150px;">
              <label for="simStart">Start date</label>
              <input type="date" id="simStart" />
            </div>
            <div style="flex:1 1 120px;">
              <label for="simStartHalf">Start</label>
              <select id="simStartHalf">
                <option value="AM">Full day (AM–PM)</option>
                <option value="PM">PM only (half-day)</option>
              </select>
            </div>
          </div>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
            <div style="flex:1 1 150px;">
              <label for="simEnd">End date</label>
              <input type="date" id="simEnd" />
            </div>
            <div style="flex:1 1 120px;">
              <label for="simEndHalf">End</label>
              <select id="simEndHalf">
                <option value="PM">Full day (AM–PM)</option>
                <option value="AM">AM only (half-day)</option>
              </select>
            </div>
          </div>

          <button type="button" id="simPreviewBtn" style="width:100%; margin-top:4px;">
            Preview PTO impact
          </button>
        </form>

        <div id="simResult" style="margin-top:12px; font-size:13px; color:#444;"></div>
      </div>

      <!-- Team PTO Outlook -->
      <div class="card" id="outlookCard">
        <h3>Team PTO Outlook (Next 30 Days)</h3>
        <div id="outlookSummary">
          <p class="muted">Loading team PTO...</p>
        </div>
        <div id="outlookDetails" style="display:none;"></div>
      </div>
    </div>

    <!-- Policies + Contacts + Benefits -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>Policies & Resources</h3>
        <div class="tiles">
          <a class="tile" href="policy_pto.html">
            <div class="tile-title">PTO &amp; Time Off</div>
            <div class="tile-sub">How PTO accrues, how to request it, and key guardrails.</div>
          </a>
          <a class="tile" href="policy_benefits.html">
            <div class="tile-title">Health &amp; Benefits</div>
            <div class="tile-sub">Medical, dental, vision, and 401(k) overview.</div>
          </a>
          <a class="tile" href="policy_handbook.html">
            <div class="tile-title">Employee Handbook</div>
            <div class="tile-sub">Core expectations, values, and general policies.</div>
          </a>
          <a class="tile" href="policy_travel.html">
            <div class="tile-title">Travel &amp; Reimbursement</div>
            <div class="tile-sub">Per diem, mileage, and what’s reimbursable.</div>
          </a>
          <a class="tile" href="policy_holidays.html">
            <div class="tile-title">Holidays &amp; Office Closures</div>
            <div class="tile-sub">Observed holidays and standard closure dates.</div>
          </a>
        </div>
      </div>

      <div class="card" id="contactsCard">
        <h3>Your Team Contacts</h3>
        <div id="contactsSummary">
          <p class="muted">Loading team contacts...</p>
        </div>
        <div class="contacts-footer">
          <a class="tile contacts-link" href="index_contacts.html">
            <div class="tile-title">Open Full Contacts Dashboard</div>
            <div class="tile-sub">View all departments, regions, and models in one place.</div>
          </a>
        </div>
      </div>

      <div class="card" id="benefitsCard">
        <h3>Your Benefits Snapshot</h3>
        <p class="muted" id="benefitsLoadingText">Loading benefits...</p>

        <div id="benefitsContent" style="display:none;">
          <div class="metric-row">
            <span class="metric-label">Medical Coverage Level</span>
            <span class="metric-value" id="benefitsCoverageLevel">—</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Dental</span>
            <span class="metric-value" id="benefitsDentalStatus">—</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Vision</span>
            <span class="metric-value" id="benefitsVisionStatus">—</span>
          </div>

          <hr style="border:none;border-top:1px solid #eee;margin:10px 0;">

          <div class="benefits-premium-row">
            <h4 style="margin-bottom:4px;">2026 Health Premiums Comparison</h4>
            <p class="small-note">
              Total monthly premium at your coverage level (before employer contributions),
              comparing UHC 2026 renewal vs BCBS Secure Gold.
            </p>

            <div class="benefits-premium-bars">
              <div class="benefits-premium-bar-label">UHC 2026 (total)</div>
              <div class="benefits-premium-bar-track">
                <div class="benefits-premium-bar uhc" id="benefitsUhcBar">
                  <span id="benefitsUhcAmount">$—/mo</span>
                </div>
              </div>
            </div>

            <div class="benefits-premium-bars">
              <div class="benefits-premium-bar-label">BCBS Secure Gold</div>
              <div class="benefits-premium-bar-track">
                <div class="benefits-premium-bar bcbs" id="benefitsBcbsBar">
                  <span id="benefitsBcbsAmount">$—/mo</span>
                </div>
              </div>
            </div>

            <p class="small-note" id="benefitsSavingsText"></p>
          </div>

          <hr style="border:none;border-top:1px solid #eee;margin:10px 0;">

          <div class="benefits-mini-grid">
            <div>
              <h4>Your Share (Per Month)</h4>
              <ul class="benefits-list">
                <li><strong>Health:</strong> <span id="benefitsYourHealth">$0.00</span></li>
                <li><strong>Dental:</strong> <span id="benefitsYourDental">$0.00</span></li>
                <li><strong>Vision:</strong> <span id="benefitsYourVision">$0.00</span></li>
              </ul>
            </div>
            <div>
              <h4>HH Contribution (Per Month)</h4>
              <ul class="benefits-list">
                <li><strong>Health:</strong> <span id="benefitsHHHealth">$0.00</span></li>
                <li><strong>Dental:</strong> <span id="benefitsHHDental">$0.00</span></li>
                <li><strong>Vision:</strong> <span id="benefitsHHVision">$0.00</span></li>
              </ul>
            </div>
          </div>

          <p class="small-note" style="margin-top:8px;">
            Numbers shown are based on current enrollment records. For questions or corrections,
            reach out to the People Team.
          </p>
        </div>
      </div>
    </div>

    <!-- PTO Request Form (demo + email draft) -->
    <div class="card" id="ptoFormCard">
      <h3>PTO Request Form</h3>

      <div style="display:flex; flex-wrap:wrap; gap:12px;">
        <div style="flex:1 1 220px;">
          <label>Employee Name</label>
          <input type="text" id="formEmpName" readonly />
        </div>
        <div style="flex:1 1 180px;">
          <label>Department</label>
          <input type="text" id="formDept" readonly />
        </div>
        <div style="flex:1 1 220px;">
          <label>Supervisor</label>
          <input type="text" id="formSupervisor" readonly />
        </div>
      </div>

      <label for="formType">PTO Type</label>
      <select id="formType">
        <option value="vacation">Vacation</option>
        <option value="sick">Sick</option>
        <option value="unpaid">Unpaid</option>
      </select>

      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <div style="flex:1 1 150px;">
          <label for="formStart">Start date</label>
          <input type="date" id="formStart" />
        </div>
        <div style="flex:1 1 120px;">
          <label for="formStartHalf">Start</label>
          <select id="formStartHalf">
            <option value="AM">Full day (AM–PM)</option>
            <option value="PM">PM only (half-day)</option>
          </select>
        </div>
        <div style="flex:1 1 150px;">
          <label for="formEnd">End date</label>
          <input type="date" id="formEnd" />
        </div>
        <div style="flex:1 1 120px;">
          <label for="formEndHalf">End</label>
          <select id="formEndHalf">
            <option value="PM">Full day (AM–PM)</option>
            <option value="AM">AM only (half-day)</option>
          </select>
        </div>
      </div>

      <label for="formReason">Reason / Notes (optional)</label>
      <textarea id="formReason" placeholder="Family trip, appointment, etc."></textarea>

      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
        <div style="flex:1 1 260px;">
          <label for="formEmailSend">Send summary to email</label>
          <input type="email" id="formEmailSend" placeholder="someone@hollandhomesllc.com" />
        </div>
        <div style="flex:0 0 180px;">
          <button type="button" id="formEmailBtn" style="width:100%;">Open email draft</button>
        </div>
      </div>

      <button type="button" id="formPreviewBtn" style="margin-top:8px;">
        Refresh request summary
      </button>

      <div id="formSummary" style="margin-top:12px; font-size:13px;"></div>
    </div>

  </div> <!-- /dashboard -->

</div> <!-- /max -->

<script>
  let employees = [];
  let ptoInfo = [];
  let contacts = [];
  let ptoRequests = [];
  let currentUser = null;
  let selectedOutlook = null; // last clicked outlook bubble

  // UHC vs BCBS comparison totals (from your 2026 analysis)
  const HEALTH_PREMIUMS = {
    "Employee Only":     { uhc: 759.17 },
    "Employee + Spouse": { uhc: 1568.96 },
    "Employee + Children": { uhc: 1384.91 },
    "Employee + Family": { uhc: 2157.89 }
  };

  const COVERAGE_KEY_MAP = {
    "Employee": "Employee Only",
    "Employee + Spouse": "Employee + Spouse",
    "Employee + Children": "Employee + Children",
    "Family": "Employee + Family"
  };

  // US holidays 2025 & 2026 (ISO date -> name)
  const usHolidays = {
    "2025-01-01": "New Year's Day",
    "2025-01-20": "MLK Day",
    "2025-02-17": "Presidents Day",
    "2025-05-26": "Memorial Day",
    "2025-06-19": "Juneteenth",
    "2025-07-04": "Independence Day",
    "2025-09-01": "Labor Day",
    "2025-10-13": "Columbus / Indigenous Peoples Day",
    "2025-11-11": "Veterans Day",
    "2025-11-27": "Thanksgiving Day",
    "2025-12-25": "Christmas Day",
    "2026-01-01": "New Year's Day",
    "2026-01-19": "MLK Day",
    "2026-02-16": "Presidents Day",
    "2026-05-25": "Memorial Day",
    "2026-06-19": "Juneteenth",
    "2026-07-04": "Independence Day",
    "2026-09-07": "Labor Day",
    "2026-10-12": "Columbus / Indigenous Peoples Day",
    "2026-11-11": "Veterans Day",
    "2026-11-26": "Thanksgiving Day",
    "2026-12-25": "Christmas Day"
  };

  const keyEvents = []; // optional future events
  let outlookDetailMap = {};

  // ---------- Load JSON data ----------
  async function loadAllData() {
    const loginError = document.getElementById('loginError');
    const loadErrorDetails = document.getElementById('loadErrorDetails');
    const empSelect = document.getElementById('empSelect');

    try {
      const [empRes, ptoRes, contactsRes, reqRes] = await Promise.all([
        fetch('employees.json'),
        fetch('pto_employee_info.json'),
        fetch('contacts.json'),
        fetch('pto_requests.json')
      ]);

      if (!empRes.ok) throw new Error('employees.json HTTP ' + empRes.status);
      if (!ptoRes.ok) throw new Error('pto_employee_info.json HTTP ' + ptoRes.status);

      employees   = await empRes.json();
      ptoInfo     = await ptoRes.json();
      contacts    = contactsRes.ok ? await contactsRes.json() : [];
      ptoRequests = reqRes.ok ? await reqRes.json() : [];

      if (!Array.isArray(employees) || employees.length === 0) {
        throw new Error('employees.json is empty or not an array');
      }

      empSelect.innerHTML = '<option value="">Select your name...</option>';
      employees.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      employees.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.empId;
        opt.textContent = emp.name + (emp.department ? ' – ' + emp.department : '');
        empSelect.appendChild(opt);
      });

      loginError.style.display = 'none';
      loginError.textContent = '';
      loadErrorDetails.style.display = 'none';
      loadErrorDetails.textContent = '';

    } catch (err) {
      console.error('Error loading JSON data:', err);
      empSelect.innerHTML = '<option value="">Could not load employees</option>';
      loginError.textContent = 'Could not load portal data. Check JSON files and how this page is being served.';
      loginError.style.display = 'block';
      loadErrorDetails.textContent = String(err.message || err);
      loadErrorDetails.style.display = 'block';
    }
  }

  // ---------- Login ----------
  function setupLogin() {
    const loginBtn = document.getElementById('loginBtn');
    const dropdown = document.getElementById('empSelect');
    const passcodeInput = document.getElementById('passcodeInput');
    const loginError = document.getElementById('loginError');

    loginBtn.addEventListener('click', () => {
      loginError.style.display = 'none';
      loginError.textContent = '';

      const selectedId = dropdown.value;
      const passcode = passcodeInput.value.trim();

      if (!selectedId || !passcode) {
        loginError.textContent = 'Please select your name and enter your passcode.';
        loginError.style.display = 'block';
        return;
      }

      const user = employees.find(e => e.empId === selectedId);
      if (!user || (user.passcode && user.passcode !== passcode)) {
        loginError.textContent = 'Incorrect passcode. Please try again.';
        loginError.style.display = 'block';
        return;
      }

      currentUser = user;
      showDashboard();
    });

    passcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });
  }

  // ---------- Helpers ----------
  function findPtoRecord(empId) {
    if (!Array.isArray(ptoInfo)) return null;
    return ptoInfo.find(r => r.empId === empId || r.name?.includes(empId));
  }

  function getBalances() {
    const record = findPtoRecord(currentUser.empId);
    if (!record) {
      return {
        vacationAvailable: 0,
        sickAvailable: 0,
        unpaidAvailable: 0,
        vacationBeginning: 0,
        sickBeginning: 0,
        unpaidBeginning: 0,
        vacationUsed: 0,
        sickUsed: 0,
        unpaidUsed: 0,
        futureVacationApproved: 0,
        futureSickDays: 0,
        futureUnpaidDays: 0
      };
    }
    const b = record.balances || {};
    return {
      vacationAvailable: Number(b.vacationAvailable ?? 0),
      sickAvailable: Number(b.sickAvailable ?? 0),
      unpaidAvailable: Number(b.unpaidAvailable ?? 0),
      vacationBeginning: Number(b.vacationBeginning ?? 0),
      sickBeginning: Number(b.sickBeginning ?? 0),
      unpaidBeginning: Number(b.unpaidBeginning ?? 0),
      vacationUsed: Number(b.vacationUsed ?? 0),
      sickUsed: Number(b.sickUsed ?? 0),
      unpaidUsed: Number(b.unpaidUsed ?? 0),
      futureVacationApproved: Number(b.futureVacationApproved ?? 0),
      futureSickDays: Number(b.futureSickDays ?? 0),
      futureUnpaidDays: Number(b.futureUnpaidDays ?? 0)
    };
  }

  function parseMDY(mdyString) {
    if (!mdyString) return null;
    const parts = mdyString.split('/');
    if (parts.length < 3) return null;
    let [m, d, y] = parts.map(p => p.trim());
    m = Number(m); d = Number(d); y = Number(y);
    if (y < 100) y = 2000 + y;
    const dt = new Date(y, m - 1, d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function toISODate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function diffDaysInclusive(start, end) {
    const msPerDay = 24 * 60 * 60 * 1000;
    const diff = (end - start) / msPerDay;
    return diff >= 0 ? diff + 1 : 0;
  }

  function formatISOForDisplay(dateStr) {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  }

  // ---------- PTO Summary ----------
  function renderPtoSummary() {
    const container = document.getElementById('ptoSummary');
    const record = findPtoRecord(currentUser.empId);

    if (!record) {
      container.innerHTML = '<p class="muted">No PTO data found for your profile.</p>';
      return;
    }

    const b = record.balances || {};
    container.innerHTML = `
      <div class="metric-row">
        <span class="metric-label">Vacation Available</span>
        <span class="metric-value">${(b.vacationAvailable ?? 0).toFixed(2)} days</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Sick Available</span>
        <span class="metric-value">${(b.sickAvailable ?? 0).toFixed(2)} days</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Unpaid Available</span>
        <span class="metric-value">${(b.unpaidAvailable ?? 0).toFixed(2)} days</span>
      </div>
    `;
  }

  // ---------- PTO Simulator ----------
  function setupSimulator() {
    const btn = document.getElementById('simPreviewBtn');
    const result = document.getElementById('simResult');

    btn.addEventListener('click', () => {
      if (!currentUser) return;

      const type = document.getElementById('simType').value;
      const startStr = document.getElementById('simStart').value;
      const endStr = document.getElementById('simEnd').value;
      const startHalf = document.getElementById('simStartHalf').value;
      const endHalf = document.getElementById('simEndHalf').value;

      if (!startStr || !endStr) {
        result.innerHTML = `<span style="color:#c62828;">Select both a start and end date.</span>`;
        return;
      }

      const start = new Date(startStr);
      const end = new Date(endStr);
      if (isNaN(start.getTime()) || isNaN(end.getTime()) || end < start) {
        result.innerHTML = `<span style="color:#c62828;">End date must be the same or after the start date.</span>`;
        return;
      }

      let days = diffDaysInclusive(start, end);
      if (startHalf === 'PM') days -= 0.5;
      if (endHalf === 'AM') days -= 0.5;
      if (days < 0) days = 0;

      const b = getBalances();
      let available = 0;
      let label = '';

      if (type === 'vacation') { available = b.vacationAvailable; label = 'Vacation'; }
      else if (type === 'sick') { available = b.sickAvailable; label = 'Sick'; }
      else { available = b.unpaidAvailable; label = 'Unpaid'; }

      const remaining = available - days;
      const pillClass = type === 'vacation' ? 'vacation' : type === 'sick' ? 'sick' : 'unpaid';

      result.innerHTML = `
        <p style="margin:0 0 6px 0;">
          Requesting <strong>${days.toFixed(2)} days</strong> of
          <strong>${label}</strong> PTO
          <span class="pill ${pillClass}">${label}</span>
        </p>
        <p style="margin:0;">
          Available now: <strong>${available.toFixed(2)} days</strong><br/>
          After this request: <strong>${remaining.toFixed(2)} days</strong>
          ${remaining < 0 ? '<br/><span style="color:#c62828;">(This would exceed your current available balance.)</span>' : ''}
        </p>
      `;
    });
  }

  // ---------- Contacts ----------
  function renderContacts() {
    const container = document.getElementById('contactsSummary');

    if (!Array.isArray(contacts) || contacts.length === 0) {
      container.innerHTML = '<p class="muted">Team contact directory coming soon.</p>';
      return;
    }

    const dept = currentUser.department;
    const team = contacts.filter(c => c.department === dept);

    if (team.length === 0) {
      container.innerHTML = '<p class="muted">No contact records found for your department yet.</p>';
      return;
    }

    const cards = team.map(c => {
      const name = c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim();
      const region = c.region || '';
      const deptLabel = c.department || '';
      const metaLine = [deptLabel, region].filter(Boolean).join(' · ');

      return `
        <div class="contact-card">
          <div class="contact-name">${name}</div>
          <div class="contact-role">${metaLine || '&nbsp;'}</div>
          <div class="contact-meta">
            ${c.email ? `<a href="mailto:${c.email}">${c.email}</a>` : ''}
            ${c.workNumber ? `<span class="contact-phone">${c.workNumber}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = `<div class="contacts-grid">${cards}</div>`;
  }

  // ---------- PTO request split (past / future) ----------
  function splitRequestsByTiming() {
    if (!Array.isArray(ptoRequests)) return { past: [], future: [] };

    const now = new Date();
    const myReqs = ptoRequests.filter(r => {
      const id = (r.empId || "").toString().toLowerCase();
      return id === currentUser.empId.toString().toLowerCase();
    });

    const past = [];
    const future = [];

    myReqs.forEach(r => {
      const startStr = r.startDate || r["PTO Request Start Date"];
      const endStr = r.endDate || r["PTO Request End Date"] || startStr;

      const start = parseMDY(startStr) || new Date(startStr);
      const end = parseMDY(endStr) || new Date(endStr);
      if (!start || isNaN(start.getTime())) return;

      const type = (r.type || r["PTO Request Type"] || "").toLowerCase();
      const totalDays = Number(r.totalDays ?? r["PTO Request Total Days"] ?? 0);
      const obj = { type, startStr, endStr, totalDays };

      if (end < now) past.push(obj); else future.push(obj);
    });

    return { past, future };
  }

  function formatDateRange(r) {
    if (!r) return "";
    if (!r.endStr || r.endStr === r.startStr) return r.startStr || "";
    return `${r.startStr}–${r.endStr}`;
  }

  // ---------- TMC-style snapshot HTML (embedded in outlook) ----------
  function buildTmcSnapshotHtml() {
    const rec = findPtoRecord(currentUser.empId);
    if (!rec) {
      return '<p class="muted">No PTO balance data found for this employee.</p>';
    }

    const b = getBalances();
    const { past, future } = splitRequestsByTiming();

    const pastVacation = past.filter(r => r.type === 'vacation');
    const pastSick     = past.filter(r => r.type === 'sick');
    const pastUnpaid   = past.filter(r => r.type === 'unpaid');

    const futureVacation = future.filter(r => r.type === 'vacation');
    const futureSick     = future.filter(r => r.type === 'sick');
    const futureUnpaid   = future.filter(r => r.type === 'unpaid');

    const joinRanges = (arr) => arr.map(formatDateRange).filter(Boolean).join(', ');

    const allPast   = [...pastVacation, ...pastSick, ...pastUnpaid];
    const allFuture = [...futureVacation, ...futureSick, ...futureUnpaid];

    const msPerDay = 24 * 60 * 60 * 1000;
    const today = new Date();

    let lastVacDate = null;
    pastVacation.forEach(r => {
      const d = parseMDY(r.endStr) || parseMDY(r.startStr) || new Date(r.endStr || r.startStr);
      if (d && !isNaN(d.getTime())) {
        if (!lastVacDate || d > lastVacDate) lastVacDate = d;
      }
    });

    let nextVacDate = null;
    futureVacation.forEach(r => {
      const d = parseMDY(r.startStr) || new Date(r.startStr);
      if (d && !isNaN(d.getTime())) {
        if (!nextVacDate || d < nextVacDate) nextVacDate = d;
      }
    });

    let lastLine = '<span class="muted">No prior vacation days recorded.</span>';
    if (lastVacDate) {
      const daysAgo = Math.round((today - lastVacDate) / msPerDay);
      lastLine = `${lastVacDate.toLocaleDateString()} (${daysAgo >= 0 ? daysAgo : 0} days ago)`;
    }

    let nextLine = '<span class="muted">No upcoming vacation days scheduled.</span>';
    if (nextVacDate) {
      const daysUntil = Math.round((nextVacDate - today) / msPerDay);
      nextLine = `${nextVacDate.toLocaleDateString()} (${daysUntil >= 0 ? daysUntil : 0} days from now)`;
    }

    return `
      <div style="margin-top:10px;">
        <div class="metric-row">
          <span class="metric-label">Last vacation day taken</span>
          <span class="metric-value">${lastLine}</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Next vacation day scheduled</span>
          <span class="metric-value">${nextLine}</span>
        </div>

        <table>
          <thead>
            <tr>
              <th></th>
              <th>Vacation</th>
              <th>Sick</th>
              <th>Unpaid</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>2025 Beginning Balances</strong></td>
              <td>${b.vacationBeginning.toFixed(2)}</td>
              <td>${b.sickBeginning.toFixed(2)}</td>
              <td>${b.unpaidBeginning.toFixed(2)}</td>
            </tr>
            <tr>
              <td><strong>Days Used YTD</strong></td>
              <td>${b.vacationUsed.toFixed(2)}</td>
              <td>${b.sickUsed.toFixed(2)}</td>
              <td>${b.unpaidUsed.toFixed(2)}</td>
            </tr>
            <tr>
              <td><strong>Future Days Approved</strong></td>
              <td>${b.futureVacationApproved.toFixed(2)}</td>
              <td>${b.futureSickDays.toFixed(2)}</td>
              <td>${b.futureUnpaidDays.toFixed(2)}</td>
            </tr>
            <tr>
              <td><strong>2025 Remaining Balances</strong></td>
              <td>${b.vacationAvailable.toFixed(2)}</td>
              <td>${b.sickAvailable.toFixed(2)}</td>
              <td>${b.unpaidAvailable.toFixed(2)}</td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top:10px; font-size:13px;">
          <p><strong>Vacation Dates Used:</strong> ${joinRanges(pastVacation) || '<span class="muted">None recorded</span>'}</p>
          <p><strong>Vacation Dates Previously Approved (Future):</strong> ${joinRanges(futureVacation) || '<span class="muted">None recorded</span>'}</p>

          <p><strong>Sick Dates Used:</strong> ${joinRanges(pastSick) || '<span class="muted">None recorded</span>'}</p>
          <p><strong>Sick Dates Previously Approved (Future):</strong> ${joinRanges(futureSick) || '<span class="muted">None recorded</span>'}</p>

          <p><strong>Unpaid Dates Used:</strong> ${joinRanges(pastUnpaid) || '<span class="muted">None recorded</span>'}</p>
          <p><strong>Unpaid Dates Previously Approved (Future):</strong> ${joinRanges(futureUnpaid) || '<span class="muted">None recorded</span>'}</p>

          <hr style="border:none; border-top:1px solid #eee; margin:10px 0;">

          <p><strong>All Dates Used (All Types):</strong> ${joinRanges(allPast) || '<span class="muted">None recorded</span>'}</p>
          <p><strong>All Dates Previously Approved (All Types):</strong> ${joinRanges(allFuture) || '<span class="muted">None recorded</span>'}</p>
        </div>
      </div>
    `;
  }

  function buildFullPtoSnapshotText() {
    const rec = findPtoRecord(currentUser.empId);
    if (!rec) return '';

    const b = getBalances();
    const { past, future } = splitRequestsByTiming();

    const pastVacation = past.filter(r => r.type === 'vacation');
    const pastSick     = past.filter(r => r.type === 'sick');
    const pastUnpaid   = past.filter(r => r.type === 'unpaid');

    const futureVacation = future.filter(r => r.type === 'vacation');
    const futureSick     = future.filter(r => r.type === 'sick');
    const futureUnpaid   = future.filter(r => r.type === 'unpaid');

    const joinRanges = (arr) => arr.map(formatDateRange).filter(Boolean).join(', ') || 'None recorded';

    const allPast   = [...pastVacation, ...pastSick, ...pastUnpaid];
    const allFuture = [...futureVacation, ...futureSick, ...futureUnpaid];

    const msPerDay = 24 * 60 * 60 * 1000;
    const today = new Date();

    let lastVacDate = null;
    pastVacation.forEach(r => {
      const d = parseMDY(r.endStr) || parseMDY(r.startStr) || new Date(r.endStr || r.startStr);
      if (d && !isNaN(d.getTime())) {
        if (!lastVacDate || d > lastVacDate) lastVacDate = d;
      }
    });

    let nextVacDate = null;
    futureVacation.forEach(r => {
      const d = parseMDY(r.startStr) || new Date(r.startStr);
      if (d && !isNaN(d.getTime())) {
        if (!nextVacDate || d < nextVacDate) nextVacDate = d;
      }
    });

    let lastLine = 'No prior vacation days recorded.';
    if (lastVacDate) {
      const daysAgo = Math.round((today - lastVacDate) / msPerDay);
      lastLine = `${lastVacDate.toLocaleDateString()} (${daysAgo >= 0 ? daysAgo : 0} days ago)`;
    }

    let nextLine = 'No upcoming vacation days scheduled.';
    if (nextVacDate) {
      const daysUntil = Math.round((nextVacDate - today) / msPerDay);
      nextLine = `${nextVacDate.toLocaleDateString()} (${daysUntil >= 0 ? daysUntil : 0} days from now)`;
    }

    const lines = [];

    lines.push('Last vacation day taken');
    lines.push(lastLine);
    lines.push('Next vacation day scheduled');
    lines.push(nextLine);
    lines.push('');

    lines.push('Vacation   Sick   Unpaid');
    lines.push('2025 Beginning Balances');
    lines.push(
      `${b.vacationBeginning.toFixed(2)}   ` +
      `${b.sickBeginning.toFixed(2)}   ` +
      `${b.unpaidBeginning.toFixed(2)}`
    );
    lines.push('Days Used YTD');
    lines.push(
      `${b.vacationUsed.toFixed(2)}   ` +
      `${b.sickUsed.toFixed(2)}   ` +
      `${b.unpaidUsed.toFixed(2)}`
    );
    lines.push('Future Days Approved');
    lines.push(
      `${b.futureVacationApproved.toFixed(2)}   ` +
      `${b.futureSickDays.toFixed(2)}   ` +
      `${b.futureUnpaidDays.toFixed(2)}`
    );
    lines.push('2025 Remaining Balances');
    lines.push(
      `${b.vacationAvailable.toFixed(2)}   ` +
      `${b.sickAvailable.toFixed(2)}   ` +
      `${b.unpaidAvailable.toFixed(2)}`
    );
    lines.push('');

    lines.push(`Vacation Dates Used: ${joinRanges(pastVacation)}`);
    lines.push(`Vacation Dates Previously Approved (Future): ${joinRanges(futureVacation)}`);
    lines.push(`Sick Dates Used: ${joinRanges(pastSick)}`);
    lines.push(`Sick Dates Previously Approved (Future): ${joinRanges(futureSick)}`);
    lines.push(`Unpaid Dates Used: ${joinRanges(pastUnpaid)}`);
    lines.push(`Unpaid Dates Previously Approved (Future): ${joinRanges(futureUnpaid)}`);
    lines.push('');
    lines.push(`All Dates Used (All Types): ${joinRanges(allPast)}`);
    lines.push(`All Dates Previously Approved (All Types): ${joinRanges(allFuture)}`);

    return lines.join('\n');
  }

  // ---------- Team PTO Outlook ----------
  function renderOutlook() {
    const container = document.getElementById('outlookSummary');
    const detailsBox = document.getElementById('outlookDetails');
    outlookDetailMap = {};
    detailsBox.style.display = 'none';
    detailsBox.innerHTML = '';

    if (!Array.isArray(ptoRequests) || ptoRequests.length === 0) {
      container.innerHTML = '<p class="muted">No PTO requests loaded yet.</p>';
      return;
    }

    const dept = currentUser.department;
    const msPerDay = 24 * 60 * 60 * 1000;
    const today = new Date();
    const windowStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const windowDays = 30;
    const windowEnd = new Date(windowStart.getTime() + (windowDays - 1) * msPerDay);

    const empIndex = {};
    employees.forEach(e => {
      if (!e.empId) return;
      empIndex[e.empId.toString().toLowerCase()] = e;
    });

    const keyEventMap = {};
    keyEvents.forEach(ev => {
      if (!ev.date) return;
      if (!keyEventMap[ev.date]) keyEventMap[ev.date] = [];
      keyEventMap[ev.date].push(ev.name);
    });

    const bucket = {};

    function ensureBucket(dateStr) {
      if (!bucket[dateStr]) {
        bucket[dateStr] = {
          deptCount: 0,
          companyCount: 0,
          events: []
        };
      }
      return bucket[dateStr];
    }

    function pushDetail(scope, dateStr, entry) {
      const key = scope + '|' + dateStr;
      if (!outlookDetailMap[key]) outlookDetailMap[key] = [];
      outlookDetailMap[key].push(entry);
    }

    const upcomingForUser = [];

    ptoRequests.forEach(r => {
      const rawStart = r.startDate || r["PTO Request Start Date"];
      const rawEnd   = r.endDate || r["PTO Request End Date"] || rawStart;
      if (!rawStart) return;

      let start = parseMDY(rawStart);
      let end   = parseMDY(rawEnd);
      if (!start) start = new Date(rawStart);
      if (!end)   end   = new Date(rawEnd);
      if (isNaN(start.getTime()) || isNaN(end.getTime())) return;

      if (end < start) {
        const tmp = start; start = end; end = tmp;
      }

      if (end < windowStart || start > windowEnd) return;

      const clampedStart = start < windowStart ? windowStart : start;
      const clampedEnd   = end > windowEnd ? windowEnd : end;

      const id        = (r.empId || "").toString().toLowerCase();
      const currentId = currentUser.empId.toString().toLowerCase();
      const emp       = empIndex[id];
      const name      = emp ? emp.name : (r.employeeName || r["Employee Name"] || '');
      const rDept     = r.department || (emp && emp.department) || '';

      if (id === currentId) {
        upcomingForUser.push({
          startStr: rawStart,
          endStr: rawEnd,
          type: r.type || r["PTO Request Type"] || '',
          totalDays: Number(r.totalDays ?? r["PTO Request Total Days"] ?? 0)
        });
      }

      for (let d = new Date(clampedStart.getTime());
           d <= clampedEnd;
           d = new Date(d.getTime() + msPerDay)) {
        const dateKey = toISODate(d);
        const isHoliday = !!usHolidays[dateKey];

        const b = ensureBucket(dateKey);

        if (keyEventMap[dateKey]) {
          keyEventMap[dateKey].forEach(evName => {
            if (!b.events.includes(evName)) b.events.push(evName);
          });
        }
        if (isHoliday) {
          const holName = usHolidays[dateKey];
          const label = 'US Holiday – ' + holName;
          if (!b.events.includes(label)) b.events.push(label);
        }

        if (!isHoliday) {
          b.companyCount += 1;
          if (rDept === dept) {
            b.deptCount += 1;
          }

          const entry = {
            name,
            department: rDept,
            type: (r.type || r["PTO Request Type"] || ''),
            range: rawStart === rawEnd ? rawStart : (rawStart + '–' + rawEnd)
          };
          pushDetail('company', dateKey, entry);
          if (rDept === dept) {
            pushDetail('dept', dateKey, entry);
          }
        }
      }
    });

    Object.keys(usHolidays).forEach(dateStr => {
      const d = new Date(dateStr);
      if (d >= windowStart && d <= windowEnd) {
        const b = ensureBucket(dateStr);
        const label = 'US Holiday – ' + usHolidays[dateStr];
        if (!b.events.includes(label)) b.events.push(label);
      }
    });

    const days = Object.keys(bucket)
      .sort()
      .map(dateStr => ({ dateStr, ...bucket[dateStr] }));

    if (days.length === 0) {
      container.innerHTML = `
        <p class="muted">
          No PTO scheduled in the next 30 days (excluding company-wide holidays).
        </p>
      `;
      return;
    }

    const deptCounts = days.map(d => d.deptCount);
    const companyCounts = days.map(d => d.companyCount);
    const deptMax = Math.max(...deptCounts);
    const companyMax = Math.max(...companyCounts);

    const deptHotThreshold = Math.max(2, Math.ceil(deptMax * 0.5));
    const companyHotThreshold = Math.max(4, Math.ceil(companyMax * 0.4));

    function deptHeatClass(count) {
      if (!count) return '';
      if (count >= deptHotThreshold) return 'dept-high';
      if (count >= 2) return 'dept-med';
      return 'dept-low';
    }

    function coHeatClass(count) {
      if (!count) return '';
      if (count >= companyHotThreshold) return 'co-high';
      if (count >= 3) return 'co-med';
      return 'co-low';
    }

    const scoredDays = days.map(d => {
      const flags = [];
      if (d.deptCount >= deptHotThreshold) flags.push('Dept hotspot');
      if (d.companyCount >= companyHotThreshold) flags.push('Company hotspot');
      if (d.events && d.events.length && d.companyCount > 0) flags.push('Key event + PTO');
      const score = d.deptCount * 2 + d.companyCount + (flags.length * 2);
      return { ...d, flags, score };
    }).sort((a, b) => b.score - a.score || (a.dateStr.localeCompare(b.dateStr)));

    const topImportant = scoredDays.slice(0, 10).sort((a,b) => a.dateStr.localeCompare(b.dateStr));

    const overviewRows = topImportant.map(d => {
      const deptClass = deptHeatClass(d.deptCount);
      const coClass   = coHeatClass(d.companyCount);

      const deptCell = d.deptCount
        ? `<span class="heat-cell ${deptClass} outlook-bubble" data-scope="dept" data-date="${d.dateStr}">
             ${d.deptCount}
           </span>`
        : '<span class="muted">0</span>';

      const coCell = d.companyCount
        ? `<span class="heat-cell ${coClass} outlook-bubble" data-scope="company" data-date="${d.dateStr}">
             ${d.companyCount}
           </span>`
        : '<span class="muted">0</span>';

      const flagsPieces = [];
      if (d.deptCount >= deptHotThreshold) {
        flagsPieces.push('<span class="pill hot">Dept hotspot</span>');
      }
      if (d.companyCount >= companyHotThreshold) {
        flagsPieces.push('<span class="pill hot">Company hotspot</span>');
      }
      if (d.events && d.events.some(e => e.startsWith('US Holiday'))) {
        flagsPieces.push('<span class="pill event">Holiday</span>');
      }
      if (d.events && d.events.some(e => !e.startsWith('US Holiday'))) {
        flagsPieces.push('<span class="pill event">Event</span>');
      }

      const holidayHtml = (d.events || [])
        .filter(e => e.startsWith('US Holiday'))
        .map(e => `<div class="holiday-label">${e}</div>`)
        .join('');

      const eventHtml = (d.events || [])
        .filter(e => !e.startsWith('US Holiday'))
        .map(e => `<div class="holiday-label">${e}</div>`)
        .join('');

      const flagsHtml = flagsPieces.join(' ');

      return `
        <tr>
          <td>
            ${formatISOForDisplay(d.dateStr)}
            ${holidayHtml}
            ${eventHtml}
          </td>
          <td>${deptCell}</td>
          <td>${coCell}</td>
          <td>${flagsHtml || '<span class="muted">—</span>'}</td>
        </tr>
      `;
    }).join('');

    const tmcHtml = buildTmcSnapshotHtml();

    container.innerHTML = `
      <h4>At a glance – dates to watch</h4>
      <table>
        <thead>
          <tr>
            <th style="width:36%;">Date</th>
            <th style="width:18%;">Dept Out</th>
            <th style="width:18%;">Company Out</th>
            <th style="width:28%;">Flags</th>
          </tr>
        </thead>
        <tbody>
          ${overviewRows}
        </tbody>
      </table>

      <h4 style="margin-top:12px;">Your PTO Outlook</h4>
      ${tmcHtml}
    `;

    const bubbles = container.querySelectorAll('.outlook-bubble');
    const detailsBoxEl = document.getElementById('outlookDetails');

    bubbles.forEach(b => {
      b.addEventListener('click', () => {
        const scope = b.getAttribute('data-scope');
        const dateStr = b.getAttribute('data-date');
        const key = scope + '|' + dateStr;

        selectedOutlook = { scope, dateStr };

        const list = outlookDetailMap[key] || [];
        if (!list.length) {
          detailsBoxEl.style.display = 'block';
          detailsBoxEl.innerHTML = `
            <h5>${formatISOForDisplay(dateStr)} – ${scope === 'dept' ? 'Dept' : 'Company'} details</h5>
            <p class="muted" style="margin:0;">No individual PTO records found for this day.</p>
          `;
          return;
        }
        const items = list.map(e => `
          <li>
            <strong>${e.name || '(Name missing)'}</strong>
            ${e.department ? ' · ' + e.department : ''}
            ${e.type ? ' · ' + e.type : ''}
            ${e.range ? ' · ' + e.range : ''}
          </li>
        `).join('');
        detailsBoxEl.style.display = 'block';
        detailsBoxEl.innerHTML = `
          <h5>${formatISOForDisplay(dateStr)} – ${scope === 'dept' ? 'Dept' : 'Company'} details</h5>
          <ul>${items}</ul>
        `;
      });
    });
  }

  // ---------- PTO Request Form + Email Draft ----------
  function setupPtoForm() {
    const nameInput = document.getElementById('formEmpName');
    const deptInput = document.getElementById('formDept');
    const supInput  = document.getElementById('formSupervisor');

    nameInput.value = currentUser.name || '';
    deptInput.value = currentUser.department || '';
    supInput.value  = currentUser.directReport || '';

    ['formType','formStart','formEnd','formStartHalf','formEndHalf','formReason'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', renderPtoFormSummary);
      el.addEventListener('input', renderPtoFormSummary);
    });

    document.getElementById('formPreviewBtn')
      .addEventListener('click', renderPtoFormSummary);

    document.getElementById('formEmailBtn')
      .addEventListener('click', openPtoEmailDraft);

    renderPtoFormSummary();
  }

  function renderPtoFormSummary() {
    const container = document.getElementById('formSummary');
    const type = document.getElementById('formType').value;
    const startStr = document.getElementById('formStart').value;
    const endStr   = document.getElementById('formEnd').value;
    const startHalf = document.getElementById('formStartHalf').value;
    const endHalf   = document.getElementById('formEndHalf').value;

    if (!startStr || !endStr) {
      container.innerHTML = '<span class="muted">Choose a start and end date to see request details.</span>';
      return;
    }

    const start = new Date(startStr);
    const end   = new Date(endStr);
    if (isNaN(start.getTime()) || isNaN(end.getTime()) || end < start) {
      container.innerHTML = '<span style="color:#c62828;">End date must be the same or after the start date.</span>';
      return;
    }

    let days = diffDaysInclusive(start, end);
    if (startHalf === 'PM') days -= 0.5;
    if (endHalf === 'AM')   days -= 0.5;
    if (days < 0) days = 0;

    const b = getBalances();

    let label, begin, used, futureApproved, available;
    if (type === 'vacation') {
      label = 'Vacation';
      begin = b.vacationBeginning;
      used  = b.vacationUsed;
      futureApproved = b.futureVacationApproved;
      available = b.vacationAvailable;
    } else if (type === 'sick') {
      label = 'Sick';
      begin = b.sickBeginning;
      used  = b.sickUsed;
      futureApproved = b.futureSickDays;
      available = b.sickAvailable;
    } else {
      label = 'Unpaid';
      begin = b.unpaidBeginning;
      used  = b.unpaidUsed;
      futureApproved = b.futureUnpaidDays;
      available = b.unpaidAvailable;
    }

    const newUsed = used + days;
    const newFutureApproved = futureApproved + days;
    const remainingIfApproved = available - days;

    const warning = remainingIfApproved < 0
      ? `<p style="color:#c62828; margin:6px 0 0 0;">
           This request would exceed your current available ${label.toLowerCase()} balance
           by ${Math.abs(remainingIfApproved).toFixed(2)} days.
         </p>`
      : '';

    container.innerHTML = `
      <p style="margin:0 0 6px 0;">
        Requesting <strong>${days.toFixed(2)}</strong> day(s) of <strong>${label}</strong> PTO.
      </p>
      <p style="margin:0 0 10px 0; font-size:13px;">
        Dates out: <strong>${startStr}</strong>${endStr && endStr !== startStr ? ' – <strong>' + endStr + '</strong>' : ''}
      </p>

      <table>
        <thead>
          <tr>
            <th></th>
            <th>${label}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>2025 Beginning Balance</strong></td>
            <td>${begin.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Days Used YTD (before this request)</strong></td>
            <td>${used.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Days Used YTD (including this request)</strong></td>
            <td>${newUsed.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Future Days Previously Approved</strong></td>
            <td>${futureApproved.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Future Days Approved (if this is signed)</strong></td>
            <td>${newFutureApproved.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Available Balance Today</strong></td>
            <td>${available.toFixed(2)}</td>
          </tr>
          <tr>
            <td><strong>Balance If Approved</strong></td>
            <td>${remainingIfApproved.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
      ${warning}
    `;
  }

  function buildPtoEmailBody() {
    const name = currentUser.name || '';
    const dept = currentUser.department || '';
    const sup  = currentUser.directReport || '';

    const type = document.getElementById('formType').value;
    const startStr = document.getElementById('formStart').value;
    const endStr   = document.getElementById('formEnd').value;
    const startHalf = document.getElementById('formStartHalf').value;
    const endHalf   = document.getElementById('formEndHalf').value;
    const reason    = document.getElementById('formReason').value.trim();

    if (!startStr || !endStr) return null;

    const start = new Date(startStr);
    const end   = new Date(endStr);
    if (isNaN(start.getTime()) || isNaN(end.getTime()) || end < start) return null;

    let days = diffDaysInclusive(start, end);
    if (startHalf === 'PM') days -= 0.5;
    if (endHalf === 'AM')   days -= 0.5;
    if (days < 0) days = 0;

    const b = getBalances();

    let label, begin, used, futureApproved, available;
    if (type === 'vacation') {
      label = 'Vacation';
      begin = b.vacationBeginning;
      used  = b.vacationUsed;
      futureApproved = b.futureVacationApproved;
      available = b.vacationAvailable;
    } else if (type === 'sick') {
      label = 'Sick';
      begin = b.sickBeginning;
      used  = b.sickUsed;
      futureApproved = b.futureSickDays;
      available = b.sickAvailable;
    } else {
      label = 'Unpaid';
      begin = b.unpaidBeginning;
      used  = b.unpaidUsed;
      futureApproved = b.futureUnpaidDays;
      available = b.unpaidAvailable;
    }

    const newUsed = used + days;
    const newFutureApproved = futureApproved + days;
    const remainingIfApproved = available - days;

    const lines = [
      `PTO Request – ${name}`,
      '',
      `Employee: ${name}`,
      `Department: ${dept}`,
      `Supervisor: ${sup}`,
      '',
      `PTO Type: ${label}`,
      `Dates: ${startStr}${endStr && endStr !== startStr ? ' – ' + endStr : ''}`,
      `Start: ${startHalf}`,
      `End: ${endHalf}`,
      `Total Days Requested: ${days.toFixed(2)}`,
      reason ? `Reason / Notes: ${reason}` : '',
      '',
      `Snapshot for ${label}:`,
      `  2025 Beginning Balance: ${begin.toFixed(2)}`,
      `  Days Used YTD (before): ${used.toFixed(2)}`,
      `  Days Used YTD (after):  ${newUsed.toFixed(2)}`,
      `  Future Days Previously Approved: ${futureApproved.toFixed(2)}`,
      `  Future Days Approved (if signed): ${newFutureApproved.toFixed(2)}`,
      `  Available Today: ${available.toFixed(2)}`,
      `  Balance If Approved: ${remainingIfApproved.toFixed(2)}`,
      remainingIfApproved < 0
        ? `  WARNING: This request exceeds current available ${label.toLowerCase()} by ${Math.abs(remainingIfApproved).toFixed(2)} day(s).`
        : '',
      ''
    ].filter(Boolean);

    const fullSnapshotText = buildFullPtoSnapshotText();
    if (fullSnapshotText) {
      lines.push('Full PTO Snapshot');
      lines.push('-----------------');
      lines.push(fullSnapshotText);
      lines.push('');
    }

    if (selectedOutlook && outlookDetailMap) {
      const key = selectedOutlook.scope + '|' + selectedOutlook.dateStr;
      const list = outlookDetailMap[key] || [];
      if (list.length) {
        const scopeLabel = selectedOutlook.scope === 'dept' ? 'Dept' : 'Company';
        lines.push(`${formatISOForDisplay(selectedOutlook.dateStr)} – ${scopeLabel} details`);
        list.forEach(e => {
          const line = `  • ${e.name || '(Name missing)'}`
            + (e.department ? ` · ${e.department}` : '')
            + (e.type ? ` · ${e.type}` : '')
            + (e.range ? ` · ${e.range}` : '');
          lines.push(line);
        });
        lines.push('');
      }
    }

    lines.push('This email was generated from the HH PTO & Benefits portal prototype.');

    return lines.join('\n');
  }

  function openPtoEmailDraft() {
    const body = buildPtoEmailBody();
    if (!body) {
      alert('Please complete a valid date range before creating an email draft.');
      return;
    }

    const emailInput = document.getElementById('formEmailSend');
    let to = (emailInput.value || '').trim();

    if (!to && currentUser.email1) {
      to = currentUser.email1;
    }

    const subject = `PTO Request – ${currentUser.name || ''}`;
    const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  }

  // ---------- Benefits rendering ----------
  function renderBenefitsCard() {
    const loadingEl = document.getElementById('benefitsLoadingText');
    const contentEl = document.getElementById('benefitsContent');
    if (!loadingEl || !contentEl) return;

    if (!currentUser) {
      loadingEl.textContent = 'Log in above to see your benefits.';
      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';
      return;
    }

    const covLevelEl      = document.getElementById('benefitsCoverageLevel');
    const dentalStatusEl  = document.getElementById('benefitsDentalStatus');
    const visionStatusEl  = document.getElementById('benefitsVisionStatus');
    const uhcBar          = document.getElementById('benefitsUhcBar');
    const bcbsBar         = document.getElementById('benefitsBcbsBar');
    const uhcAmountEl     = document.getElementById('benefitsUhcAmount');
    const bcbsAmountEl    = document.getElementById('benefitsBcbsAmount');
    const savingsTextEl   = document.getElementById('benefitsSavingsText');

    const yourHealthEl    = document.getElementById('benefitsYourHealth');
    const yourDentalEl    = document.getElementById('benefitsYourDental');
    const yourVisionEl    = document.getElementById('benefitsYourVision');
    const hhHealthEl      = document.getElementById('benefitsHHHealth');
    const hhDentalEl      = document.getElementById('benefitsHHDental');
    const hhVisionEl      = document.getElementById('benefitsHHVision');

    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';

    const healthPlan = (currentUser.healthPlan || '').trim();
    const dentalEnrolled = (currentUser.dentalIns || '').toLowerCase() === 'yes';
    const visionEnrolled = (currentUser.visionIns || '').toLowerCase() === 'yes';

    covLevelEl.textContent     = healthPlan || 'Not enrolled';
    dentalStatusEl.textContent = dentalEnrolled ? (currentUser.dentalPlan || 'Enrolled') : 'Not enrolled';
    visionStatusEl.textContent = visionEnrolled ? (currentUser.visionPlan || 'Enrolled') : 'Not enrolled';

    const hEmp = Number(currentUser.healthEmployeeMonthlyCost || 0);
    const hEr  = Number(currentUser.healthEmployerMonthlyCost || 0);
    const dEmp = Number(currentUser.dentalEmployeeMonthlyCost || 0);
    const dEr  = Number(currentUser.dentalEmployerMonthlyCost || 0);
    const vEmp = Number(currentUser.visionEmployeeMonthlyCost || 0);
    const vEr  = Number(currentUser.visionEmployerMonthlyCost || 0);

    yourHealthEl.textContent = `$${hEmp.toFixed(2)}`;
    yourDentalEl.textContent = `$${dEmp.toFixed(2)}`;
    yourVisionEl.textContent = `$${vEmp.toFixed(2)}`;

    hhHealthEl.textContent = `$${hEr.toFixed(2)}`;
    hhDentalEl.textContent = `$${dEr.toFixed(2)}`;
    hhVisionEl.textContent = `$${vEr.toFixed(2)}`;

    const bcbsTotal = hEmp + hEr;

    const coverageKey = COVERAGE_KEY_MAP[healthPlan] || 'Employee Only';
    const uhcPrem = HEALTH_PREMIUMS[coverageKey];

    if (!uhcPrem || !bcbsTotal) {
      uhcAmountEl.textContent = uhcPrem ? `$${uhcPrem.uhc.toFixed(2)}/mo` : '$—/mo';
      bcbsAmountEl.textContent = bcbsTotal ? `$${bcbsTotal.toFixed(2)}/mo` : '$—/mo';
      uhcBar.style.width = '50%';
      bcbsBar.style.width = '50%';
      savingsTextEl.textContent = 'Premium comparison not available for this coverage level.';
      return;
    }

    uhcAmountEl.textContent  = `$${uhcPrem.uhc.toFixed(2)}/mo`;
    bcbsAmountEl.textContent = `$${bcbsTotal.toFixed(2)}/mo`;

    const max = Math.max(uhcPrem.uhc, bcbsTotal);
    const uhcPct  = Math.max(20, (uhcPrem.uhc / max) * 100);
    const bcbsPct = Math.max(20, (bcbsTotal / max) * 100);
    uhcBar.style.width = uhcPct + '%';
    bcbsBar.style.width = bcbsPct + '%';

    const savings = uhcPrem.uhc - bcbsTotal;
    const pct     = (savings / uhcPrem.uhc) * 100;
    savingsTextEl.textContent =
      `Total BCBS premium at your coverage level is about $${bcbsTotal.toFixed(2)}/month. ` +
      `That’s saving roughly $${savings.toFixed(2)}/month (${pct.toFixed(1)}% lower) vs the 2026 UHC renewal.`;
  }

  // ---------- Show dashboard ----------
  function showDashboard() {
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    const welcomeName = document.getElementById('welcomeName');
    const welcomeDept = document.getElementById('welcomeDept');

    welcomeName.textContent = `Welcome, ${currentUser.name}`;
    const dept = currentUser.department || '';
    const dr   = currentUser.directReport || '';
    welcomeDept.textContent = dept ? (dr ? `${dept} · Reports to ${dr}` : dept) : '';

    renderPtoSummary();
    renderOutlook();
    renderContacts();
    setupPtoForm();
    renderBenefitsCard();
  }

  // ---------- Boot ----------
  document.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    setupLogin();
    setupSimulator();
  });
</script>

</body>
</html>
