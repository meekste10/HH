<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PTO Dashboard ‚Äî Requests ‚Ä¢ Burnout Radar ‚Ä¢ Calendar Heatmap</title>
<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>

<style>
  :root{
    --bg:#0f1115; --panel:#151922; --ink:#e7e9ee; --muted:#98a1b2; --accent:#6ea8fe;
    --ok:#3fb950; --warn:#f2cc60; --bad:#f85149; --chip:#232838; --line:#242938;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
  h1,h2,h3{margin:0 0 .5rem 0}
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:0 auto;padding:20px;}
  .grid{display:grid;gap:16px}
  .g-2{grid-template-columns:1fr 1fr}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border-radius:999px;padding:6px 10px;font-size:.9rem}
  .pill.ok{border:1px solid var(--ok)} .pill.warn{border:1px solid var(--warn)} .pill.bad{border:1px solid var(--bad)}
  .tag{font-size:.75rem;opacity:.85}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:.95rem;text-align:left}
  .table th{color:var(--muted);font-weight:600}
  .legend{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .swatch{width:14px;height:14px;border-radius:3px;border:1px solid var(--line);display:inline-block}
  .controls{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .slider-wrap{display:flex;align-items:center;gap:8px}
  input[type="range"]{accent-color:var(--accent)}
  details{background:var(--chip);border-radius:10px;padding:10px}
  summary{cursor:pointer}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b0d12;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  .badrow{font-family:ui-monospace;font-size:.9rem;color:#ffb4a9;white-space:pre-wrap}
  /* Calendar heatmap */
  .cal{overflow:auto}
  .month-label{fill:var(--muted);font-size:12px}
  .day-label{fill:var(--muted);font-size:10px}
  .tooltip{position:fixed;pointer-events:none;background:#0b0d12;border:1px solid var(--line);padding:6px 8px;border-radius:6px;font-size:.9rem;display:none}
</style>
</head>
<body>
<div class="wrap grid">
  <header class="panel">
    <h1>PTO Dashboard</h1>
    <div class="muted">PTO Requests ‚Ä¢ Burnout Radar ‚Ä¢ Calendar Heatmap</div>
    <div class="row muted" style="margin-top:8px">
      Data sources: <code>PTO Requests.csv</code> ‚Ä¢ <code>Employee Reference.csv</code> ‚Ä¢ <code>PTO Employee Info.csv</code>
    </div>
  </header>

  <!-- Controls -->
  <section class="panel">
    <h2>Controls</h2>
    <div class="controls" style="margin-top:10px">
      <label>Year:
        <select id="yearSelect"></select>
      </label>
      <label>Status:
        <select id="statusFilter">
          <option value="approved">Approved only</option>
          <option value="approved,pending">Approved + Pending</option>
          <option value="all">All (Approved, Pending, Denied)</option>
        </select>
      </label>
      <label>Type:
        <select id="typeFilter">
          <option value="all">All PTO</option>
          <option value="non-sick">Vacation/Personal only</option>
          <option value="sick">Sick only</option>
        </select>
      </label>
      <div class="slider-wrap">
        <span class="muted">Burnout: days since any time-off ‚â•</span>
        <input id="anyCutoff" type="range" min="5" max="30" value="12" />
        <span id="anyCutoffVal">12</span>
      </div>
      <div class="slider-wrap">
        <span class="muted">Burnout: days since vacation (excl. sick) ‚â•</span>
        <input id="vacCutoff" type="range" min="15" max="120" value="45" />
        <span id="vacCutoffVal">45</span>
      </div>
    </div>
  </section>

  <!-- Burnout Radar -->
  <section class="panel">
    <h2>Burnout Radar</h2>
    <div class="muted" style="margin:.25rem 0 .75rem">Sick days <em>do</em> count as rest for ‚Äúdays since any time-off,‚Äù but are tracked separately from true vacation/personal time.</div>
    <table class="table" id="burnoutTable">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Days since ANY time-off</th>
          <th>Days since Vacation/Personal</th>
          <th>Last 14 days: Sick</th>
          <th>Last 14 days: Vac/Personal</th>
          <th>Risk</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Calendar Heatmap -->
  <section class="panel">
    <h2>Calendar Heatmap</h2>
    <div class="legend" id="legend"></div>
    <div class="cal" id="calWrap" style="margin-top:10px"></div>
  </section>

  <!-- Data quality -->
  <section class="panel">
    <h2>Data Quality & Missing Rows</h2>
    <div class="muted">If something ‚Äúwent missing,‚Äù it will be listed here with the reason. Fix the source CSV or adjust filters and reload.</div>
    <details style="margin-top:10px">
      <summary><strong>Skipped rows (click to expand)</strong></summary>
      <div id="badRows"></div>
    </details>
  </section>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
/*** ‚á¢ 1) CONFIG: paste your raw GitHub CSV URLs here ***/
const CSV_URLS = {
  ptoRequests: "https://raw.githubusercontent.com/meekste10/HH/main/PTO%20Requests.csv",
  employeeRef: "https://raw.githubusercontent.com/meekste10/HH/main/Employee%20Reference.csv",
  ptoEmployeeInfo: "https://raw.githubusercontent.com/meekste10/HH/main/PTO%20Employee%20Info.csv",
};

/*** ‚á¢ 2) UTILITIES ***/
const parseDate = (v) => {
  if (!v) return null;
  let s = (""+v).trim().replace(/\./g,'/').replace(/-/g,'/');
  // Accept M/D/Y, Y/M/D, etc.
  const d = new Date(s);
  return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
};
const fmt = (d)=> d ? d.toLocaleDateString('en-US') : '';
const daysBetween = (a,b)=> Math.round((a - b)/(1000*60*60*24));
const today = new Date(); const todayUTC = new Date(today.getFullYear(), today.getMonth(), today.getDate());
const norm = (s)=> (s??"").toString().trim();
const normID = (s)=> norm(s).toUpperCase();

/*** ‚á¢ 3) LOAD CSVs (robust) ***/
function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true, header:true, dynamicTyping:true, skipEmptyLines:'greedy',
      complete: (res)=> resolve(res.data),
      error: (err)=> reject(err)
    });
  });
}

async function loadAll(){
  const [ptoReq, empRef, ptoInfo] = await Promise.all([
    loadCSV(CSV_URLS.ptoRequests),
    loadCSV(CSV_URLS.employeeRef),
    loadCSV(CSV_URLS.ptoEmployeeInfo)
  ]);
  return {ptoReq, empRef, ptoInfo};
}

/*** ‚á¢ 4) CLEAN + INDEX ***/
function prepareData(raw){
  const badRows = [];
  const employees = new Map();

  // Build a quick employee lookup by EmpID or Email
  const addEmp = (row)=>{
    const id = normID(row.EmpID || row.EmployeeID || row.ID);
    if(!id) return;
    if(!employees.has(id)){
      employees.set(id,{
        id,
        name: norm(row.EmployeeName || row.Name || row.FullName),
        email: norm(row.Email || row.Email1 || row["Email 1"]),
        department: norm(row.Department),
        requests: []
      });
    }else{
      // fill gaps
      const e = employees.get(id);
      if(!e.name && row.EmployeeName) e.name = norm(row.EmployeeName);
      if(!e.email && row.Email) e.email = norm(row.Email);
      if(!e.department && row.Department) e.department = norm(row.Department);
    }
  };

  raw.empRef.forEach(addEmp);
  raw.ptoInfo.forEach(addEmp);

  // Parse PTO Requests
  const requests = [];
  (raw.ptoReq||[]).forEach((r, idx)=>{
    const EmpID = normID(r.EmpID || r.EmployeeID || r.ID);
    const Employee = norm(r.Employee || r.EmployeeName || r.Name);
    const Type = norm(r.Type || r.PTOType || r.Category); // e.g., Vacation, Sick, Personal
    const Status = norm(r.Status || r.ApprovalStatus || r.State).toLowerCase(); // approved/pending/denied
    const Start = parseDate(r.StartDate || r.Start || r.Date);
    const End   = parseDate(r.EndDate || r.End || r.Date);
    const Days  = Number(r.Days || r.TotalDays || r.Length || 1);
    const Reason = norm(r.Reason || r.Notes);

    // Validate
    let reason = [];
    if(!EmpID && !Employee) reason.push("missing EmpID & Employee name");
    if(!Start) reason.push("bad Start date");
    // Normalize End
    const endDate = End ? End : Start;
    // Infer days if missing and start/end present
    const spanDays = endDate && Start ? (daysBetween(endDate, Start)+1) : 1;
    const totalDays = isFinite(Days) && Days>0 ? Days : Math.max(1, spanDays);
    const typeClean = Type.toLowerCase();
    const mappedType =
      typeClean.includes("sick") ? "Sick" :
      (typeClean.includes("vac")||typeClean.includes("pto")||typeClean.includes("personal")) ? "Vacation/Personal" :
      Type || "Other";
    let mappedStatus =
      Status.includes("appr") ? "approved" :
      Status.includes("pend") ? "pending" :
      Status.includes("deny") ? "denied" :
      (Status||"").length ? Status : "approved"; // default to approved if blank

    if(reason.length){
      badRows.push({idx, raw:r, why:reason.join(", ")});
      return;
    }

    // push day-by-day events for calendar
    for(let i=0;i<totalDays;i++){
      let d = new Date(Start.getFullYear(), Start.getMonth(), Start.getDate()+i);
      requests.push({
        EmpID: EmpID || ("NAME:"+Employee.toUpperCase()),
        Employee: Employee,
        Type: mappedType,
        Status: mappedStatus,
        Date: d,
        Reason
      });
    }
  });

  // Attach requests to employees; also create shell employee if unknown
  requests.forEach(ev=>{
    const empKey = ev.EmpID;
    if(!employees.has(empKey)){
      employees.set(empKey, {id:empKey, name: ev.Employee || "", email:"", department:"", requests:[]});
    }
    employees.get(empKey).requests.push(ev);
  });

  // Build years list
  const years = Array.from(new Set(requests.map(r=>r.Date.getFullYear()))).sort((a,b)=>a-b);

  return { employees, requests, years, badRows };
}

/*** ‚á¢ 5) UI BINDINGS ***/
const yearSel = document.getElementById('yearSelect');
const statusSel = document.getElementById('statusFilter');
const typeSel = document.getElementById('typeFilter');
const anyCutoff = document.getElementById('anyCutoff');
const anyCutoffVal = document.getElementById('anyCutoffVal');
const vacCutoff = document.getElementById('vacCutoff');
const vacCutoffVal = document.getElementById('vacCutoffVal');

anyCutoff.addEventListener('input', ()=> anyCutoffVal.textContent = anyCutoff.value);
vacCutoff.addEventListener('input', ()=> vacCutoffVal.textContent = vacCutoff.value);

/*** ‚á¢ 6) RENDER: Burnout Radar ***/
function renderBurnout(employeesMap, year){
  const tbody = document.querySelector('#burnoutTable tbody');
  tbody.innerHTML = '';
  const statuses = statusSel.value === 'all' ? ['approved','pending','denied']
                  : statusSel.value.split(',');
  const todayRef = todayUTC;

  const rows = [];

  employeesMap.forEach(emp=>{
    // Filter requests by status and year (but burnout is based on *up to today*, not just the selected year)
    const reqs = emp.requests.filter(r=> statuses.includes(r.Status));
    // Build last-any / last-vac dates
    const pastReqs = reqs.filter(r=> r.Date <= todayRef).sort((a,b)=> a.Date - b.Date);
    let lastAny = null, lastVac = null;
    let sick14 = 0, vac14 = 0;

    pastReqs.forEach(r=>{
      if(!lastAny || r.Date > lastAny) lastAny = r.Date;
      if(r.Type !== 'Sick'){
        if(!lastVac || r.Date > lastVac) lastVac = r.Date;
      }
      const diff = daysBetween(todayRef, r.Date);
      if(diff >=0 && diff < 14){
        if(r.Type === 'Sick') sick14++;
        else vac14++;
      }
    });

    const daysSinceAny = lastAny ? daysBetween(todayRef, lastAny) : 999;
    const daysSinceVac = lastVac ? daysBetween(todayRef, lastVac) : 999;

    const risk =
      (daysSinceAny >= Number(anyCutoff.value) && daysSinceVac >= Number(vacCutoff.value)) ? 'High' :
      (daysSinceAny >= Number(anyCutoff.value) || daysSinceVac >= Number(vacCutoff.value)) ? 'Watch' :
      'OK';

    rows.push({
      name: emp.name || emp.id,
      daysSinceAny, daysSinceVac, sick14, vac14, risk
    });
  });

  // Sort: High ‚Üí Watch ‚Üí OK, then by daysSinceAny desc
  const order = {High:0, Watch:1, OK:2};
  rows.sort((a,b)=> (order[a.risk]-order[b.risk]) || (b.daysSinceAny - a.daysSinceAny));

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const riskClass = r.risk==='High' ? 'bad' : (r.risk==='Watch' ? 'warn' : 'ok');
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.daysSinceAny===999?'<span class="muted">no time-off yet</span>':r.daysSinceAny}</td>
      <td>${r.daysSinceVac===999?'<span class="muted">no vacation yet</span>':r.daysSinceVac}</td>
      <td><span class="pill">${r.sick14}</span></td>
      <td><span class="pill">${r.vac14}</span></td>
      <td><span class="pill ${riskClass}">${r.risk}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

/*** ‚á¢ 7) RENDER: Calendar Heatmap ***/
function renderHeatmap(requests, year){
  const container = d3.select("#calWrap");
  container.selectAll("*").remove();

  const statuses = statusSel.value === 'all' ? ['approved','pending','denied']
                  : statusSel.value.split(',');
  const typeMode = typeSel.value; // all | non-sick | sick
  const filtered = requests.filter(r=>{
    const passYear = r.Date.getFullYear() === Number(year);
    const passStatus = statuses.includes(r.Status);
    const passType = typeMode==='all' ? true : (typeMode==='sick' ? r.Type==='Sick' : r.Type!=='Sick');
    return passYear && passStatus && passType;
  });

  // Count PTO per day
  const key = d => d.toISOString().slice(0,10);
  const counts = d3.rollup(filtered, v=>v.length, r=> key(r.Date));
  const firstDay = new Date(year,0,1);
  const lastDay = new Date(year,11,31);

  const day = d3.timeDay;
  const week = d3.timeWeek;
  const weeksInYear = week.count(day.floor(firstDay), day.ceil(d3.timeYear.offset(firstDay,1)));
  const cellSize = 16, gutter = 4, leftMargin = 50, topMargin = 24;
  const width = leftMargin + (cellSize+gutter)*53 + 10;
  const heightPerMonth = topMargin + (cellSize+gutter)*7 + 24;

  const svg = container.append("svg")
    .attr("width", width)
    .attr("height", heightPerMonth*12);

  // Day labels
  const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  svg.selectAll(".day-label")
    .data(days)
    .enter()
    .append("text")
    .attr("class","day-label")
    .attr("x", leftMargin - 8)
    .attr("y", (d,i)=> 24 + i*(cellSize+gutter) + cellSize*.75)
    .attr("text-anchor","end")
    .text(d=>d);

  // Color scale
  const maxCount = d3.max(Array.from(counts.values())) || 0;
  const color = d3.scaleLinear().domain([0, Math.max(1,maxCount)]).range(["#1b2130","#6ea8fe"]);

  // Month groups
  const months = d3.range(0,12);
  const tooltip = d3.select("#tooltip");

  months.forEach(m=>{
    const monthStart = new Date(year, m, 1);
    const monthEnd = new Date(year, m+1, 0);
    const monthWeeks = d3.timeWeeks(d3.timeSunday.floor(monthStart), d3.timeSunday.ceil(monthEnd));
    const xOffset = 0;
    const yOffset = m*heightPerMonth;

    // Month label
    svg.append("text")
      .attr("class","month-label")
      .attr("x", 8)
      .attr("y", yOffset + 14)
      .text(monthStart.toLocaleString('en-US',{month:'long'}));

    // Draw cells
    const startWeek = d3.timeSunday.count(d3.timeYear.floor(new Date(year,0,1)), monthStart);
    const daysInMonth = d3.timeDays(monthStart, d3.timeDay.offset(monthEnd,1));

    svg.selectAll(`.cell-${m}`)
      .data(daysInMonth)
      .enter()
      .append("rect")
      .attr("class", `cell cell-${m}`)
      .attr("width", cellSize)
      .attr("height", cellSize)
      .attr("rx", 3).attr("ry",3)
      .attr("x", d=>{
        const wk = d3.timeSunday.count(d3.timeYear.floor(new Date(year,0,1)), d);
        return leftMargin + (cellSize+gutter)*wk;
      })
      .attr("y", d=> yOffset + topMargin + d.getDay()*(cellSize+gutter))
      .attr("fill", d=>{
        const c = counts.get(key(d)) || 0;
        return c===0 ? "#1b2130" : color(c);
      })
      .on("mousemove", (event,d)=>{
        const c = counts.get(key(d)) || 0;
        tooltip
          .style("display","block")
          .style("left", (event.clientX+12)+"px")
          .style("top", (event.clientY+12)+"px")
          .html(`<strong>${d.toLocaleDateString()}</strong><br/>PTO Events: ${c}`);
      })
      .on("mouseleave", ()=> tooltip.style("display","none"));
  });

  // Legend
  const legend = d3.select("#legend");
  legend.selectAll("*").remove();
  const steps = Math.max(4, Math.min(8, maxCount || 4));
  const vals = d3.range(0, steps+1);
  legend.append("span").attr("class","muted").text("Intensity:");
  vals.forEach(v=>{
    const sw = document.createElement('span');
    sw.className = 'swatch';
    sw.style.background = v===0 ? "#1b2130" : color(v);
    legend.node().appendChild(sw);
  });
  legend.append("span").classed("muted",true).text(` 0 ‚Üí ${maxCount||'+'}`);
}

/*** ‚á¢ 8) RENDER: Bad rows ***/
function renderBadRows(badRows){
  const box = document.getElementById('badRows');
  if(!badRows.length){ box.innerHTML = '<div class="muted">No skipped rows üéâ</div>'; return; }
  box.innerHTML = '';
  badRows.slice(0,250).forEach(b=>{
    const div = document.createElement('div');
    div.className = 'badrow';
    const sample = JSON.stringify(b.raw);
    div.textContent = `Row#${b.idx+1} ‚Ä¢ ${b.why}\n${sample}`;
    box.appendChild(div);
  });
  if(badRows.length>250){
    const more = document.createElement('div');
    more.className='muted';
    more.textContent = `+ ${badRows.length-250} more rows‚Ä¶`;
    box.appendChild(more);
  }
}

/*** ‚á¢ 9) BOOT ***/
let GLOBAL = null;

function populateYears(years){
  yearSel.innerHTML = '';
  const uniq = Array.from(new Set([...years, todayUTC.getFullYear()])).sort((a,b)=>a-b);
  uniq.forEach(y=>{
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if(y===todayUTC.getFullYear()) opt.selected = true;
    yearSel.appendChild(opt);
  });
}

function redraw(){
  if(!GLOBAL) return;
  renderBurnout(GLOBAL.employees, Number(yearSel.value));
  renderHeatmap(GLOBAL.requests, Number(yearSel.value));
}

yearSel.addEventListener('change', redraw);
statusSel.addEventListener('change', redraw);
typeSel.addEventListener('change', redraw);
anyCutoff.addEventListener('change', redraw);
vacCutoff.addEventListener('change', redraw);

(async function init(){
  try{
    const raw = await loadAll();
    const prepped = prepareData(raw);
    GLOBAL = prepped;
    populateYears(prepped.years.length ? prepped.years : [todayUTC.getFullYear()]);
    renderBadRows(prepped.badRows);
    anyCutoffVal.textContent = anyCutoff.value;
    vacCutoffVal.textContent = vacCutoff.value;
    redraw();
  }catch(err){
    alert("Error loading CSVs: " + err);
    console.error(err);
  }
})();
</script>
</body>
</html>
