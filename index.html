<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Holland Homes ‚Ä¢ PTO Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<style>
  :root { --brand:#184A30; --ink:#1c1c1c; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; --line:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  body { margin:0; background:var(--bg); color:var(--ink); }
  header { background:var(--brand); color:#fff; padding:16px 20px; }
  header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
  .wrap { max-width:1200px; margin:0 auto; padding:16px; }
  .row { display:grid; gap:12px; }
  .grid-6 { grid-template-columns: repeat(6, 1fr); }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .grid-2 { grid-template-columns: repeat(2, 1fr); }
  .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toolbar input, .toolbar select, .toolbar button, .toolbar label { font-size:14px; }
  .toolbar input, .toolbar select, .toolbar button { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; background:#fff; }
  .btn { cursor:pointer; }
  .kpi { display:flex; align-items:baseline; gap:8px; }
  .kpi .big { font-size:26px; font-weight:700; }
  .kpi .label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.2px; }
  .list { margin:8px 0 0; padding:0; list-style:none; }
  .list li { padding:8px 0; border-bottom:1px dashed #eee; font-size:14px; display:flex; justify-content:space-between; gap:10px; }
  .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
  .muted { color:var(--muted); }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .status.ok{border-color:var(--ok); color:#065f46}
  .status.warn{border-color:var(--warn); color:#7c2d12}
  .status.bad{border-color:var(--bad); color:#7f1d1d}

  /* Scrollable frames */
  .scroll-card { max-height: 420px; overflow:auto; border-radius:12px; -webkit-overflow-scrolling:touch; }
  .scroll-card h3 { position: sticky; top: 0; background: var(--card); padding-bottom:6px; margin-top:0; }

  canvas { width:100%; height:260px; }

  /* Table */
  .table-wrap { overflow:auto; max-height: 460px; -webkit-overflow-scrolling:touch; border:1px solid #e5e7eb; border-radius:12px; }
  table { width:100%; border-collapse: collapse; font-size:14px; min-width: 820px; }
  th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
  th { font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; position: sticky; top: 0; background: #fff; z-index: 1; }

  /* Heatmap (calendar style Sun‚ÜíSat) */
  .heatmap { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .heatcell { border-radius:6px; padding:8px; text-align:center; border:1px solid #eee; background:#fafafa; }
  .heatcell .d { font-weight:600; }
  .legend { display:flex; align-items:center; gap:6px; }
  .swatch { width:18px; height:12px; border-radius:3px; border:1px solid #e5e7eb; }

  details summary{cursor:pointer}
  code{font-family:ui-monospace,Menlo,Consolas,monospace}
  .badrow{font-family:ui-monospace; font-size:12px; white-space:pre-wrap; background:#fff7ed; border:1px dashed #f59e0b; padding:8px; border-radius:8px; margin:6px 0;}
  @media (max-width: 1024px){ .grid-6, .grid-3, .grid-2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header><h1>Holland Homes ‚Äî PTO Dashboard</h1></header>

<div class="wrap">

  <!-- Controls -->
  <div class="toolbar card" style="justify-content:space-between;">
    <div class="toolbar">
      <label>From: <input id="dateFrom" type="date" /></label>
      <label>To: <input id="dateTo" type="date" /></label>

      <!-- Quick ranges -->
      <button class="btn" id="rngToday">Today</button>
      <button class="btn" id="rng7">Next 7</button>
      <button class="btn" id="rng14">Next 14</button>
      <button class="btn" id="rng30">Next 30</button>
      <button class="btn" id="rngMonth">This Month</button>

      <!-- Filters -->
      <label>Department:<select id="fDept"><option value="">All</option></select></label>
      <label>Manager:<select id="fMgr"><option value="">All</option></select></label>
      <label>Type:
        <select id="fType">
          <option value="">All</option>
          <option>Vacation</option><option>Sick</option><option>Unpaid</option>
        </select>
      </label>
      <label>Employment:<select id="fStatus"><option value="">All</option><option>Active</option><option>Inactive</option></select></label>
      <label>Search: <input id="fSearch" type="search" placeholder="Name, dept, manager‚Ä¶" /></label>
    </div>
    <div class="toolbar">
      <button id="refreshBtn" class="btn" type="button">Reload Data</button>
      <span class="footer">From CSV ‚Ä¢ <span id="asOf"></span></span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row grid-6">
    <div class="card kpi"><span class="big" id="kpiRequests">0</span><span class="label">Requests</span></div>
    <div class="card kpi"><span class="big" id="kpiPeople">0</span><span class="label">Unique Employees</span></div>
    <div class="card kpi"><span class="big" id="kpiDepts">0</span><span class="label">Departments</span></div>
    <div class="card kpi"><span class="big" id="kpiDays">0</span><span class="label">Total Person-Days</span></div>
    <div class="card kpi"><span class="big" id="kpiSick14">0</span><span class="label">Sick events (14d)</span></div>
    <div class="card kpi"><span class="big" id="kpiVac14">0</span><span class="label">Vac/Personal (14d)</span></div>
  </div>

  <!-- Lists + Chart -->
  <div class="row grid-3" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Requests</h3>
      <ul class="list" id="reqList"></ul>
    </div>
    <div class="card scroll-card">
      <h3>By Employee</h3>
      <ul class="list" id="empList"></ul>
    </div>
    <div class="card scroll-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">By Team</h3>
        <label class="muted">Metric:
          <select id="chartMode">
            <option value="days">Person-Days</option>
            <option value="coverage">Coverage %</option>
          </select>
        </label>
      </div>
      <canvas id="deptChart" aria-label="Team metric"></canvas>
    </div>
  </div>

  <!-- Heatmap + Burnout -->
  <div class="row grid-2" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Calendar Heatmap</h3>
      <div id="heatmapLegend" class="legend" style="margin:6px 0 8px;"></div>
      <div id="heatmap" class="heatmap"></div>
      <div class="footer" id="heatmapNote"></div>
    </div>
    <div class="card scroll-card">
      <h3>Burnout Radar</h3>
      <div class="muted" style="margin:4px 0 8px;">Sick counts as rest for ‚Äúdays since any time-off‚Äù; vacation/personal tracked separately.</div>
      <ul class="list" id="burnoutList"></ul>
      <div class="footer"><span id="burnoutCount">0</span> employee(s) flagged</div>
    </div>
  </div>

  <!-- Timeline/Gantt -->
  <div class="card" style="margin-top:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Timeline</h3>
      <div class="muted" id="ganttRange"></div>
    </div>
    <div class="gantt"><div class="gantt-grid" id="ganttGrid" style="position:relative; min-width:900px;"></div></div>
    <div class="footer">Showing requests overlapping the selected range (max 150 rows).</div>
  </div>

  <!-- Roster snapshot -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Roster Snapshot</h3>
    <div class="table-wrap">
      <table id="balTable">
        <thead>
          <tr>
            <th>Employee</th><th>Department</th><th>Manager</th><th>Status</th>
            <th>Vacation Avail (days)</th><th>Days Since Last PTO (ANY)</th><th>Risk</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer">Roster derived from Employee Reference + PTO Employee Info.</div>
  </div>

  <!-- Diagnostics -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Diagnostics</h3>
    <div class="muted" id="colInspector"></div>
    <details style="margin-top:8px;">
      <summary><strong>Skipped Rows (if any)</strong></summary>
      <div id="badRows"></div>
    </details>
  </div>
</div>

<script>
  // ===== CONFIG (use your filenames or raw GitHub URLs) =====
  const REQUESTS_CSV = './PTO Requests.csv';
  const EMP_REF_CSV  = './Employee Reference.csv';
  const PTO_INFO_CSV = './PTO Employee Info.csv';

  const MS_DAY=86400000;

  // ===== UTIL =====
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const dayStart = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const dayISO   = d => dayStart(d).toISOString().slice(0,10);
  const L = s => String(s||'').toLowerCase().trim();
  const num = v => { const n = Number(String(v??'').replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; };
  const cleanKey = s => String(s||'').replace(/\uFEFF/g,'').replace(/\s+/g,' ').trim().toLowerCase();

  function pick(row, candidates){
    const map = new Map(Object.keys(row).map(k => [cleanKey(k), k]));
    for (const wanted of candidates){
      const k = map.get(cleanKey(wanted));
      if (k !== undefined) return row[k];
    }
    return undefined;
  }
  function normName(s){
    const t = String(s||'').trim();
    if (!t) return '';
    const m = /^([^,]+),\s*(.+)$/.exec(t);
    if (m) return (m[2] + ' ' + m[1]).replace(/\s+/g,' ').trim();
    return t.replace(/\s+/g,' ').trim();
  }

  const excelSerialToDate = (num) => {
    // Excel epoch (Windows): 1899-12-30 (Excel's 1900 leap bug baked in)
    const base = new Date(Date.UTC(1899,11,30));
    const ms = num * 86400000;
    const d = new Date(base.getTime() + ms);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  };

  // <-- UPDATED to accept Excel serials passed as strings, plus YYYYMMDD
  const tryParseOneDate = (raw) => {
    if (raw == null || raw === '') return null;

    // Numbers (Excel serials or YYYYMMDD numeric)
    if (typeof raw === 'number') {
      if (raw >= 30000 && raw <= 60000) return excelSerialToDate(raw); // Excel serial (~1982‚Äì2064)
      if (raw >= 19000101 && raw <= 20991231) {
        const s = String(raw);
        const y = +s.slice(0,4), m = +s.slice(4,6), d = +s.slice(6,8);
        return new Date(y, m-1, d);
      }
      return null;
    }

    // Strings
    let s = String(raw).trim();

    // Excel serial as string (e.g., "45567")
    if (/^\d{5}$/.test(s)) {
      const n = +s;
      if (n >= 30000 && n <= 60000) return excelSerialToDate(n);
    }

    // "YYYYMMDD"
    const ymd = s.match(/^(\d{4})(\d{2})(\d{2})$/);
    if (ymd) return new Date(+ymd[1], +ymd[2]-1, +ymd[3]);

    // "M/D/YY" or "MM/DD/YYYY" (optional time)
    const md = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})(?:\s+\d{1,2}:\d{2}(:\d{2})?\s*[AP]M?)?$/i);
    if (md) {
      const y = md[3].length===2 ? (2000+ +md[3]) : +md[3];
      return new Date(y, +md[1]-1, +md[2]);
    }

    // "14-Oct-2025" or "Oct 14, 2025"
    const d1 = new Date(Date.parse(s));
    if (!isNaN(d1)) return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());

    // Last chance
    const d2 = new Date(s.replace(/\./g,'/'));
    return isNaN(d2) ? null : new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
  };

  // Accept single date OR "start - end" (e.g., "10/14/2025 - 10/16/2025")
  const parseDateFlexible = (raw) => {
    if (raw == null || raw === '') return {start:null, end:null};
    if (typeof raw === 'number') { const d = tryParseOneDate(raw); return {start:d, end:d}; }
    const s = String(raw).trim();
    const parts = s.split(/\s*-\s*/);
    if (parts.length === 2) {
      const a = tryParseOneDate(parts[0]);
      const b = tryParseOneDate(parts[1]);
      return {start:a, end:b || a};
    }
    const single = tryParseOneDate(s);
    return {start:single, end:single};
  };

  function overlapDays(r, rs, re){
    const s=r.s, e=r.e; if(!s||!e) return 0;
    const a=dayStart(s), b=dayStart(e), R1=dayStart(rs), R2=dayStart(re);
    if(b<R1 || a>R2) return 0;
    const start=a<R1?R1:a, end=b>R2?R2:b;
    let days = Math.floor((end - start)/MS_DAY) + 1;
    // half days by AM/PM hints if present
    const AMPM = t => (String(t||'').toUpperCase()==='AM' || String(t||'').toUpperCase()==='PM');
    if(dayISO(start)===dayISO(a) && AMPM(r.sh)) days -= 0.5;
    if(dayISO(end)  ===dayISO(b) && AMPM(r.eh)) days -= 0.5;
    return Math.max(0, days);
  }

  async function loadCSV(url){
    const res = await fetch(url+'?v='+todayISO(), {cache:'no-store'});
    if(!res.ok) throw new Error('fetch failed '+url);
    const text = await res.text();
    return new Promise(resolve => Papa.parse(text, {header:true, skipEmptyLines:true, complete: out=>resolve(out.data)}));
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // ===== STATE =====
  let REQ_RAW=[], EMP_REF_RAW=[], PTO_INFO_RAW=[];
  let REQ=[], ROSTER=new Map(); // key: EmpID or EMAIL:... or NAME:...
  let chart;
  const badRows = [];

  // ===== DOM =====
  const dateFrom=document.getElementById('dateFrom');
  const dateTo=document.getElementById('dateTo');
  const rngToday=document.getElementById('rngToday');
  const rng7=document.getElementById('rng7');
  const rng14=document.getElementById('rng14');
  const rng30=document.getElementById('rng30');
  const rngMonth=document.getElementById('rngMonth');

  const fDept=document.getElementById('fDept');
  const fMgr=document.getElementById('fMgr');
  const fType=document.getElementById('fType');
  const fStatus=document.getElementById('fStatus');
  const fSearch=document.getElementById('fSearch');

  const asOf=document.getElementById('asOf');
  const kpiRequests=document.getElementById('kpiRequests');
  const kpiPeople=document.getElementById('kpiPeople');
  const kpiDepts=document.getElementById('kpiDepts');
  const kpiDays=document.getElementById('kpiDays');
  const kpiSick14=document.getElementById('kpiSick14');
  const kpiVac14=document.getElementById('kpiVac14');

  const reqList=document.getElementById('reqList');
  const empList=document.getElementById('empList');
  const chartMode=document.getElementById('chartMode');
  const deptChart=document.getElementById('deptChart');

  const heatmap=document.getElementById('heatmap');
  const heatmapLegend=document.getElementById('heatmapLegend');
  const heatmapNote=document.getElementById('heatmapNote');

  const burnoutList=document.getElementById('burnoutList');
  const burnoutCount=document.getElementById('burnoutCount');

  const ganttGrid=document.getElementById('ganttGrid');
  const ganttRange=document.getElementById('ganttRange');

  const balTableBody=document.querySelector('#balTable tbody');

  const colInspector=document.getElementById('colInspector');
  const badRowsBox=document.getElementById('badRows');

  // ===== Build roster from two files =====
  function setIfEmpty(obj, k, v){ if(!obj[k] && v!=null && v!=='') obj[k]=String(v).trim(); }
  function upsertEmp(key, patch){
    let rec = ROSTER.get(key);
    if(!rec){ rec = { key, EmpID:'', Name:'', Email:'', Department:'', Manager:'', Status:'', VacAvail:'', SickAvail:'', UnpaidAvail:'', DaysSinceAny:null, Risk:'' }; }
    Object.assign(rec, patch);
    ROSTER.set(key, rec);
  }
  function bestKey({EmpID, Email, Name}){
    if(EmpID) return EmpID.toUpperCase();
    if(Email) return ('EMAIL:'+Email).toUpperCase();
    if(Name)  return ('NAME:'+Name).toUpperCase();
    return null;
  }

  // --- NEW: indexes to merge dupes across files/keys
  const nameIndex = new Map();  // "FIRST LAST" -> key
  const emailIndex = new Map(); // lower(email) -> key
  function registerIndexes(key, Name, Email){
    if (Name)  nameIndex.set(String(Name).toUpperCase(), key);
    if (Email) emailIndex.set(String(Email).toLowerCase(), key);
  }
  function findExistingKey(Name, Email){
    if (Email && emailIndex.has(String(Email).toLowerCase())) return emailIndex.get(String(Email).toLowerCase());
    if (Name && nameIndex.has(String(Name).toUpperCase()))    return nameIndex.get(String(Name).toUpperCase());
    return null;
  }

  function harvestEmpRows(rows){
    rows.forEach(r=>{
      const EmpID = String(pick(r,['EmpID','Emp ID','EmployeeID','Employee ID','EEID','ID'])||'').trim();
      const Name  = normName(pick(r,['Employee Name','Employee','Name','Full Name','Employee Name 1','Employee Name 2','Employee Name 3'])||'');
      const Email = String(pick(r,['Email','Work Email','Email 1'])||'').trim();
      const Department = String(pick(r,['Department','Team'])||'').trim();
      const Manager    = String(pick(r,['Direct Report','Manager'])||'').trim();
      const Status     = String(pick(r,['Employee Status','Status'])||'').trim();
      const VacAvail   = pick(r,['Vacation Available','Vacation Avail (days)']);
      const SickAvail  = pick(r,['Sick Available','Sick Avail (days)']);
      const UnpaidAvail= pick(r,['Unpaid Available','Unpaid Avail (days)']);
      const DaysSince  = pick(r,['Days Since Last PTO','Days Since Last PTO (ANY)']);
      const Risk       = pick(r,['Risk Score (Burnout)','Risk Score']);

      // Prefer EmpID; else reuse an existing record by email/name; else synthesize
      let key = EmpID ? EmpID.toUpperCase() : findExistingKey(Name, Email);
      if (!key) key = Email ? ('EMAIL:'+Email).toUpperCase() : (Name ? ('NAME:'+Name).toUpperCase() : null);
      if (!key) return;

      upsertEmp(key, { EmpID, Name, Email });
      const rec = ROSTER.get(key);
      if (!rec.Department && Department) rec.Department = Department;
      if (!rec.Manager && Manager)       rec.Manager    = Manager;
      if (!rec.Status && Status)         rec.Status     = Status;
      if (!rec.VacAvail && VacAvail!=null)     rec.VacAvail   = String(VacAvail).trim();
      if (!rec.SickAvail && SickAvail!=null)   rec.SickAvail  = String(SickAvail).trim();
      if (!rec.UnpaidAvail && UnpaidAvail!=null) rec.UnpaidAvail = String(UnpaidAvail).trim();
      if (rec.DaysSinceAny==null && DaysSince!=null && DaysSince!=='') rec.DaysSinceAny = Number(DaysSince);
      if (!rec.Risk && Risk) rec.Risk = String(Risk).trim();

      ROSTER.set(key, rec);
      registerIndexes(key, rec.Name, rec.Email);
    });
  }

  // ===== Normalize requests (from PTO Requests.csv) =====
  function normalizeRequests(){
    REQ = [];
    badRows.length = 0;

    REQ_RAW.forEach((r, idx)=>{
      const EmpID = String(pick(r,['EmpID','Emp ID','EmployeeID','Employee ID','EEID','ID'])||'').trim();
      let Name    = normName(pick(r,['Employee Name','Employee','Name','Employee Name 1','Employee Name 2','Employee Name 3'])||'');
      const Email = String(pick(r,['Email','Work Email'])||'').trim();

      // Derive key and name from roster if missing
      let key = null;
      if(EmpID) key = EmpID.toUpperCase();
      else if(Email) key = ('EMAIL:'+Email).toUpperCase();
      else if(Name)  key = ('NAME:'+Name).toUpperCase();

      if(!Name && key && ROSTER.has(key)) Name = ROSTER.get(key).Name || Name;

      // Dates (accept ranges in a single cell or separate start/end)
      const rng = parseDateFlexible(pick(r,['PTO Request Dates','Dates','PTO Date','Date','Start']));
      let Start = rng.start, End = rng.end;
      if(!Start){
        const s2 = parseDateFlexible(pick(r,['PTO Request Start Date','Start Date','Start'])).start;
        const e2 = parseDateFlexible(pick(r,['PTO Request End Date','End Date','End'])).end;
        Start = s2 || e2 || null;
        End   = e2 || s2 || null;
      }
      if(End && Start && End<Start) { const t=Start; Start=End; End=t; }

      const sh   = pick(r,['Start AM/PM']) || '';
      const eh   = pick(r,['End AM/PM'])   || '';
      const typeRaw = (pick(r,['PTO Request Type','Type','Category']) || '').toString();
      const type = /sick/i.test(typeRaw) ? 'Sick' : (/vac|personal|pto/i.test(typeRaw) ? 'Vacation' : (typeRaw||'Other'));

      // Enrich with roster meta if available
      let meta = key && ROSTER.get(key) ? ROSTER.get(key) : {};
      const dept   = (meta.Department || pick(r,['Department','Team']) || 'Unknown').toString().trim();
      const mgr    = (meta.Manager || pick(r,['Direct Report','Manager']) || '').toString().trim();
      const status = (meta.Status  || pick(r,['Employment Status','Status']) || '').toString().trim();

      // Validate; try really hard not to drop
      const reasons = [];
      if(!Name && !key) reasons.push('no EmpID/Email/Name');
      if(!Start) reasons.push('no parsable date');
      if(reasons.length){
        badRows.push({idx, why: reasons.join(', '), raw:r});
        return;
      }

      REQ.push({ key: key||('NAME:'+Name.toUpperCase()), emp: Name||key, type, s:Start, e:End||Start, sh, eh, dept, mgr, status, raw:r });
    });
  }

  // ===== Filters =====
  function passesFilters(r){
    const q=L(fSearch.value);
    const dept=L(fDept.value), mgr=L(fMgr.value), type=L(fType.value), st=L(fStatus.value);
    if(dept && L(r.dept)!==L(dept)) return false;
    if(mgr  && L(r.mgr)!==L(mgr)) return false;
    if(type && L(r.type)!==L(type)) return false;
    if(st   && L(r.status)!==L(st)) return false;
    if(q){
      const blob=[r.emp,r.dept,r.mgr,r.type,r.status].map(x=>String(x||'').toLowerCase()).join('|');
      if(!blob.includes(q)) return false;
    }
    return true;
  }
  function buildFilterOptions(){
    function setOptions(el, arr){
      const opts=[...new Set(arr.map(x=>String(x||'').trim()).filter(Boolean))].sort();
      el.innerHTML='<option value="">All</option>'+opts.map(v=>`<option>${v}</option>`).join('');
    }
    const depts = new Set(); const mgrs = new Set();
    ROSTER.forEach(m=>{ if(m.Department) depts.add(m.Department); if(m.Manager) mgrs.add(m.Manager); });
    REQ.forEach(r=>{ if(r.dept) depts.add(r.dept); if(r.mgr) mgrs.add(r.mgr); });
    setOptions(fDept, [...depts]);
    setOptions(fMgr,  [...mgrs]);
  }

  // ===== Render =====
  function renderAll(){
    const rs=parseDateFlexible(dateFrom.value).start||new Date();
    const re=parseDateFlexible(dateTo.value).start||rs;
    if(re<rs){ dateTo.value=dateFrom.value; return; }

    const rows = REQ
      .map(r=> ({...r, overlapDays: overlapDays(r, rs, re)}))
      .filter(r=> r.overlapDays>0 && passesFilters(r));

    // KPIs
    kpiRequests.textContent = rows.length;
    kpiPeople.textContent   = new Set(rows.map(r=>r.emp)).size;
    kpiDepts.textContent    = new Set(rows.map(r=>r.dept)).size;
    kpiDays.textContent     = rows.reduce((a,r)=>a+r.overlapDays,0);

    const last14 = addDays(new Date(), -14);
    let sick14=0, vac14=0;
    REQ.forEach(r=>{
      if(r.s>=last14 && r.s<=new Date()){
        if(r.type==='Sick') sick14++; else if(r.type==='Vacation') vac14++;
      }
    });
    kpiSick14.textContent = sick14;
    kpiVac14.textContent  = vac14;

    // Requests list
    reqList.innerHTML='';
    rows.sort((a,b)=> (a.s-b.s) || a.emp.localeCompare(b.emp)).forEach(r=>{
      const li=document.createElement('li');
      li.innerHTML = `<div>${r.emp} ‚Ä¢ ${r.type}</div>
                      <div><span class="pill">${r.dept}</span> <span class="muted">${dayISO(r.s)} ‚Üí ${dayISO(r.e)} ‚Ä¢ ${r.overlapDays}d</span></div>`;
      reqList.appendChild(li);
    });

    // By Employee totals
    const byEmp={};
    rows.forEach(r=>{ byEmp[r.emp]=(byEmp[r.emp]||0)+r.overlapDays; });
    const empItems=Object.entries(byEmp).sort((a,b)=>b[1]-a[1]);
    empList.innerHTML='';
    empItems.forEach(([name,days])=>{
      const r0 = rows.find(r=>r.emp===name);
      const li=document.createElement('li');
      li.innerHTML = `<div>${name}</div><div><span class="pill">${r0?r0.dept:''}</span> <span class="muted">${days} day(s)</span></div>`;
      empList.appendChild(li);
    });

    renderChart(rows);
    renderHeatmap(rows, rs, re);
    renderGantt(rows, rs, re);
    renderRosterTable();
    renderBurnout();
    renderDiagnostics();
  }

  function renderChart(rows){
    const mode = chartMode.value;
    if(chart) chart.destroy();

    if(mode==='days'){
      const byDept={}; rows.forEach(r=>{ byDept[r.dept]=(byDept[r.dept]||0)+r.overlapDays; });
      const labels=Object.keys(byDept).sort();
      const data=labels.map(l=>byDept[l]);
      chart = new Chart(deptChart, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Person-Days', data }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    } else {
      // coverage %: 1 - (unique people out / headcount) by dept (active only if we have that flag)
      const headcountByDept={};
      ROSTER.forEach(m=>{
        if(L(m.Status)==='active'){
          headcountByDept[m.Department]=(headcountByDept[m.Department]||0)+1;
        }
      });
      const byDeptPeople=new Map();
      rows.forEach(r=>{
        const set = byDeptPeople.get(r.dept) || new Set();
        set.add(r.emp); byDeptPeople.set(r.dept,set);
      });

      const labels=Object.keys(headcountByDept).sort();
      const data=labels.map(d=>{
        const tot=headcountByDept[d]||0, outs=(byDeptPeople.get(d)||new Set()).size;
        return tot>0 ? Math.round((1 - outs/tot)*100) : 100;
      });
      chart = new Chart(deptChart, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Coverage %', data }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' } } } }
      });
    }
  }

  function renderHeatmap(rows, rs, re){
    heatmap.innerHTML=''; heatmapLegend.innerHTML='';
    const perDay=[]; let max=0;

    // pad grid from Sunday
    const pad = rs.getDay(); // 0=Sun
    for(let i=0;i<pad;i++){
      const c=document.createElement('div'); c.className='heatcell'; c.style.visibility='hidden'; heatmap.appendChild(c);
    }

    for(let d=new Date(rs); d<=re; d=addDays(d,1)){
      const count = rows.reduce((acc,r)=> acc + ( (dayStart(r.s)<=d && dayStart(r.e)>=d) ? (r.sh||r.eh?0.5:1) : 0 ), 0);
      perDay.push({d:new Date(d), count}); max=Math.max(max,count);
    }
    const scale = c => {
      if(max<=0) return '#fafafa';
      const t = c/max;
      const a = Math.max(0.08, 0.15 + 0.55*t);
      return `rgba(16,185,129,${a})`;
    };
    heatmapLegend.innerHTML = `<span class="muted">Load:</span>
      <span class="swatch" style="background:#fafafa;"></span>
      <span class="swatch" style="background:${scale(max*0.33)}"></span>
      <span class="swatch" style="background:${scale(max*0.66)}"></span>
      <span class="swatch" style="background:${scale(max)}"></span>`;

    perDay.forEach(({d,count})=>{
      const cell=document.createElement('div'); cell.className='heatcell';
      cell.style.background=scale(count);
      cell.innerHTML = `<div class="d">${d.getDate()}</div><div class="muted" style="font-size:12px;">${count||0}</div>`;
      heatmap.appendChild(cell);
    });
    heatmapNote.textContent = `${dayISO(rs)} ‚Üí ${dayISO(re)} ‚Ä¢ Max daily load: ${max}`;
  }

  function renderGantt(rows, rs, re){
    ganttRange.textContent = `${dayISO(rs)} ‚Üí ${dayISO(re)}`;
    const MAX=150, span=Math.max(1, Math.floor((dayStart(re)-dayStart(rs))/MS_DAY)+1);
    ganttGrid.innerHTML='';
    rows.slice(0,MAX).sort((a,b)=> a.emp.localeCompare(b.emp) || (a.s-b.s)).forEach(r=>{
      const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.borderBottom='1px dashed #eee'; row.style.padding='6px 0'; row.style.height='28px';
      const name=document.createElement('div'); name.style.width='180px'; name.style.flex='0 0 180px'; name.style.fontSize='13px'; name.style.whiteSpace='nowrap'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis'; name.textContent=r.emp;
      const lane=document.createElement('div'); lane.style.position='relative'; lane.style.height='8px'; lane.style.flex='1'; lane.style.background='linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px) 0 0/14px 100% no-repeat'; lane.style.borderRadius='8px';
      const start = dayStart(r.s)<dayStart(rs) ? rs : r.s;
      const end   = dayStart(r.e)>dayStart(re) ? re : r.e;
      const offset = Math.max(0, Math.floor((dayStart(start)-dayStart(rs))/MS_DAY));
      const len = Math.max(0.2, overlapDays(r, rs, re));
      const leftPct = (offset/span)*100, widthPct=(len/span)*100;
      const bar=document.createElement('div'); bar.style.position='absolute'; bar.style.top='-2px'; bar.style.height='12px'; bar.style.borderRadius='8px';
      bar.style.background='#d1fae5'; bar.style.border='1px solid #10b981'; bar.style.left=leftPct+'%'; bar.style.width=widthPct+'%';
      bar.title = `${r.emp} ‚Ä¢ ${r.type} ‚Ä¢ ${dayISO(r.s)} ‚Üí ${dayISO(r.e)} (${r.overlapDays}d)`;
      lane.appendChild(bar);
      row.appendChild(name); row.appendChild(lane); ganttGrid.appendChild(row);
    });
  }

  function renderRosterTable(){
    balTableBody.innerHTML='';
    const rows=[...ROSTER.values()].sort((a,b)=> (a.Name||'').localeCompare(b.Name||''));
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.Name||r.EmpID||r.Email||r.key}</td>
        <td>${r.Department||''}</td>
        <td>${r.Manager||''}</td>
        <td>${r.Status||''}</td>
        <td>${r.VacAvail||''}</td>
        <td>${(r.DaysSinceAny??'')!==''?r.DaysSinceAny:''}</td>
        <td>${r.Risk||''}</td>`;
      balTableBody.appendChild(tr);
    });
  }

  // ===== Burnout: include Sick as rest for "ANY" but show split counts =====
  function renderBurnout(){
    const today = dayStart(new Date());
    const last14 = addDays(today, -14);

    // Build per-employee stats
    const byKey = new Map();
    function ensure(key, name){
      if(!byKey.has(key)) byKey.set(key, {name, lastAny:null, lastVac:null, sick14:0, vac14:0});
      return byKey.get(key);
    }
    REQ.forEach(r=>{
      const s = ensure(r.key, r.emp);
      // last ANY (sick or vacation)
      if(!s.lastAny || r.s > s.lastAny) s.lastAny = r.s;
      // last VACATION only
      if(r.type!=='Sick'){ if(!s.lastVac || r.s > s.lastVac) s.lastVac = r.s; }
      // last 14d counts
      if(r.s>=last14 && r.s<=today){
        if(r.type==='Sick') s.sick14++;
        else s.vac14++;
      }
    });

    // Active employees from roster; if not listed in roster, still include from REQ
    const allKeys = new Set([...byKey.keys(), ...ROSTER.keys()]);
    const items=[];
    allKeys.forEach(k=>{
      const rec = ROSTER.get(k)||{};
      const s = byKey.get(k)||{name:(rec.Name||k), lastAny:null, lastVac:null, sick14:0, vac14:0};
      const daysSinceAny = s.lastAny ? Math.floor((today - dayStart(s.lastAny))/MS_DAY) : (rec.DaysSinceAny!=null? rec.DaysSinceAny : null);
      const daysSinceVac = s.lastVac ? Math.floor((today - dayStart(s.lastVac))/MS_DAY) : null;

      // Risk rules:
      // - If ANY time off was recent (e.g., <=14 days), treat as OK even if it was Sick
      // - Otherwise, if long time since Vacation (e.g., >=45 days) mark Watch; if also long since ANY (>=12) mark High
      const anyCut=12, vacCut=45;
      let risk='OK';
      if((daysSinceAny??999) >= anyCut || (daysSinceVac??999) >= vacCut) risk='Watch';
      if((daysSinceAny??999) >= anyCut && (daysSinceVac??999) >= vacCut) risk='High';

      items.push({ name: s.name, dept: rec.Department||'', mgr: rec.Manager||'', sick14: s.sick14, vac14: s.vac14, daysSinceAny, daysSinceVac, risk });
    });

    items.sort((a,b)=>{
      const o={High:0,Watch:1,OK:2};
      const d = (o[a.risk]-o[b.risk]); if(d) return d;
      return (b.daysSinceVac??-1)-(a.daysSinceVac??-1);
    });

    burnoutList.innerHTML='';
    items.forEach(x=>{
      const cls = x.risk==='High'?'bad':(x.risk==='Watch'?'warn':'ok');
      const li=document.createElement('li');
      li.innerHTML = `<div>${x.name} ‚Ä¢ <span class="pill">${x.dept||''}</span> <span class="muted">${x.mgr||''}</span></div>
                      <div><span class="pill">Any: ${x.daysSinceAny==null?'‚Äî':x.daysSinceAny}d</span>
                           <span class="pill">Vac: ${x.daysSinceVac==null?'‚Äî':x.daysSinceVac}d</span>
                           <span class="pill">Sick14: ${x.sick14}</span>
                           <span class="pill">Vac14: ${x.vac14}</span>
                           <span class="pill status ${cls}">${x.risk}</span></div>`;
      burnoutList.appendChild(li);
    });
    burnoutCount.textContent = items.filter(i=>i.risk!=='OK').length;
  }

  // ===== Diagnostics =====
  function renderDiagnostics(){
    const colsReq = Object.keys(REQ_RAW?.[0]||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
    const colsEmp = Object.keys(EMP_REF_RAW?.[0]||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
    const colsInfo= Object.keys(PTO_INFO_RAW?.[0]||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
    colInspector.textContent = `Detected columns ‚Äî PTO Requests: [${colsReq.join(', ')}] ‚Ä¢ Employee Reference: [${colsEmp.join(', ')}] ‚Ä¢ PTO Employee Info: [${colsInfo.join(', ')}]`;
    badRowsBox.innerHTML = badRows.length ? badRows.slice(0,150).map(b=>{
      const sample = JSON.stringify(b.raw);
      return `<div class="badrow">Row#${b.idx+1} ‚Ä¢ ${b.why}\n${sample}</div>`;
    }).join('') : '<div class="muted">No skipped rows üéâ</div>';
    if(badRows.length>150){
      const more=document.createElement('div'); more.className='muted'; more.textContent=`+ ${badRows.length-150} more‚Ä¶`; badRowsBox.appendChild(more);
    }
  }

  // ===== INIT =====
  async function init(){
    const t=new Date();
    dateFrom.value = todayISO();
    dateTo.value   = addDays(t,7).toISOString().slice(0,10);
    asOf.textContent = new Date().toLocaleString();

    try{ [REQ_RAW, EMP_REF_RAW, PTO_INFO_RAW] = await Promise.all([loadCSV(REQUESTS_CSV), loadCSV(EMP_REF_CSV), loadCSV(PTO_INFO_CSV)]); }
    catch(e){ console.error(e); }

    // Build roster from both employee files
    ROSTER.clear();
    harvestEmpRows(EMP_REF_RAW||[]);
    harvestEmpRows(PTO_INFO_RAW||[]);

    // Requests
    normalizeRequests();

    // Filters + render
    buildFilterOptions();
    renderAll();
  }

  // ===== EVENTS =====
  document.getElementById('refreshBtn').addEventListener('click', init);
  [dateFrom,dateTo,fDept,fMgr,fType,fStatus,chartMode].forEach(el=> el.addEventListener('change', renderAll));
  fSearch.addEventListener('input', renderAll);

  // Quick ranges
  function setRange(start,end){ dateFrom.value=dayISO(start); dateTo.value=dayISO(end); renderAll(); }
  rngToday.addEventListener('click', ()=>{ const t=new Date(); setRange(t,t); });
  rng7.addEventListener('click', ()=>{ const t=new Date(); setRange(t, addDays(t,7)); });
  rng14.addEventListener('click', ()=>{ const t=new Date(); setRange(t, addDays(t,14)); });
  rng30.addEventListener('click', ()=>{ const t=new Date(); setRange(t, addDays(t,30)); });
  rngMonth.addEventListener('click', ()=>{
    const t=new Date();
    const start=new Date(t.getFullYear(), t.getMonth(), 1);
    const end=new Date(t.getFullYear(), t.getMonth()+1, 0);
    setRange(start,end);
  });

  init();
</script>
</body>
</html>
