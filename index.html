<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Holland Homes ‚Ä¢ PTO Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdnjs.cloudflare.com/" />
<!-- Charts + CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --brand:#184A30; --ink:#1c1c1c; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; --line:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  body { margin:0; background:var(--bg); color:var(--ink); }
  header { background:var(--brand); color:#fff; padding:16px 20px; }
  header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
  .wrap { max-width:1200px; margin:0 auto; padding:16px; }
  .row { display:grid; gap:12px; }
  .grid-6 { grid-template-columns: repeat(6, 1fr); }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .grid-2 { grid-template-columns: repeat(2, 1fr); }
  .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toolbar input, .toolbar select, .toolbar button, .toolbar label { font-size:14px; }
  .toolbar input, .toolbar select, .toolbar button { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; background:#fff; }
  .btn { cursor:pointer; }
  .kpi { display:flex; align-items:baseline; gap:8px; }
  .kpi .big { font-size:26px; font-weight:700; }
  .kpi .label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.2px; }
  .list { margin:8px 0 0; padding:0; list-style:none; }
  .list li { padding:8px 0; border-bottom:1px dashed #eee; font-size:14px; display:flex; justify-content:space-between; gap:10px; }
  .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
  .muted { color:var(--muted); }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .status.ok{border-color:var(--ok); color:#065f46}
  .status.warn{border-color:var(--warn); color:#7c2d12}
  .status.bad{border-color:var(--bad); color:#7f1d1d}
  .scroll-card { max-height: 420px; overflow:auto; border-radius:12px; -webkit-overflow-scrolling:touch; }
  .scroll-card h3 { position: sticky; top: 0; background: var(--card); padding-bottom:6px; margin-top:0; }
  canvas { width:100%; height:260px; }
  .table-wrap { overflow:auto; max-height: 460px; -webkit-overflow-scrolling:touch; border:1px solid #e5e7eb; border-radius:12px; }
  table { width:100%; border-collapse: collapse; font-size:14px; min-width: 820px; }
  th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
  th { font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; position: sticky; top: 0; background: #fff; z-index: 1; }
  .heatcell { border-radius:6px; padding:8px; text-align:center; border:1px solid #eee; background:#fafafa; }
  .legend { display:flex; align-items:center; gap:6px; }
  .swatch { width:18px; height:12px; border-radius:3px; border:1px solid #e5e7eb; }
  details summary{cursor:pointer}
  code{font-family:ui-monospace,Menlo,Consolas,monospace}
  .badrow{font-family:ui-monospace; font-size:12px; white-space:pre-wrap; background:#fff7ed; border:1px dashed #f59e0b; padding:8px; border-radius:8px; margin:6px 0;}
  @media (max-width: 1024px){ .grid-6, .grid-3, .grid-2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header><h1>Holland Homes ‚Äî PTO Dashboard</h1></header>

<div class="wrap">

  <!-- Controls -->
  <div class="toolbar card" style="justify-content:space-between;">
    <div class="toolbar">
      <label>From: <input id="dateFrom" type="date" /></label>
      <label>To: <input id="dateTo" type="date" /></label>

      <!-- Quick ranges -->
      <button class="btn" id="rngToday">Today</button>
      <button class="btn" id="rng7">Next 7</button>
      <button class="btn" id="rng14">Next 14</button>
      <button class="btn" id="rng30">Next 30</button>
      <button class="btn" id="rngMonth">This Month</button>

      <!-- Filters -->
      <label>Department:<select id="fDept"><option value="">All</option></select></label>
      <label>Manager:<select id="fMgr"><option value="">All</option></select></label>
      <label>Type:
        <select id="fType">
          <option value="">All</option>
          <option>Vacation</option><option>Sick</option><option>Unpaid</option>
        </select>
      </label>
      <label>Employment:<select id="fStatus"><option value="">(Active by default)</option><option>Active</option><option>Inactive</option></select></label>
      <label>Search: <input id="fSearch" type="search" placeholder="Name, dept, manager‚Ä¶" /></label>
    </div>
    <div class="toolbar">
      <button id="refreshBtn" class="btn" type="button">Reload Data</button>
      <span class="footer">From CSV ‚Ä¢ <span id="asOf"></span></span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row grid-6">
    <div class="card kpi"><span class="big" id="kpiRequests">0</span><span class="label">Requests</span></div>
    <div class="card kpi"><span class="big" id="kpiPeople">0</span><span class="label">Unique Employees</span></div>
    <div class="card kpi"><span class="big" id="kpiDepts">0</span><span class="label">Departments</span></div>
    <div class="card kpi"><span class="big" id="kpiDays">0</span><span class="label">Total Person-Days</span></div>
    <div class="card kpi"><span class="big" id="kpiSick14">0</span><span class="label">Sick events (14d)</span></div>
    <div class="card kpi"><span class="big" id="kpiVac14">0</span><span class="label">Vac/Personal (14d)</span></div>
  </div>

  <!-- Lists + Chart -->
  <div class="row grid-3" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Requests</h3>
      <ul class="list" id="reqList"></ul>
    </div>

    <!-- NEW: By Employee usage table -->
    <div class="card scroll-card">
      <h3>By Employee</h3>
      <div class="table-wrap">
        <table id="empUsageTable">
          <thead>
            <tr>
              <th>Employee</th><th>Department</th>
              <th>Vac Used</th><th>Vac Avail</th>
              <th>Sick Used</th><th>Sick Avail</th>
              <th>Unpaid Used</th><th>Unpaid Avail</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card scroll-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">By Team</h3>
        <label class="muted">Metric:
          <select id="chartMode">
            <option value="days">Person-Days</option>
            <option value="coverage">Coverage %</option>
          </select>
        </label>
      </div>
      <canvas id="deptChart" aria-label="Team metric"></canvas>
    </div>
  </div>

  <!-- Heatmap + Burnout -->
  <div class="row grid-2" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Calendar Heatmap</h3>
      <div id="heatmapLegend" class="legend" style="margin:6px 0 8px;"></div>
      <div id="heatmap"></div>
      <div class="footer" id="heatmapNote"></div>
    </div>
    <div class="card scroll-card">
      <h3>Burnout Radar</h3>
      <div class="muted" style="margin:4px 0 8px;">Sick counts as rest for ‚Äúdays since any time-off‚Äù; vacation/personal tracked separately.</div>
      <ul class="list" id="burnoutList"></ul>
      <div class="footer"><span id="burnoutCount">0</span> employee(s) flagged</div>
    </div>
  </div>

  <!-- Timeline/Gantt -->
  <div class="card" style="margin-top:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Timeline</h3>
      <div class="muted" id="ganttRange"></div>
    </div>
    <div class="gantt"><div class="gantt-grid" id="ganttGrid" style="position:relative; min-width:900px;"></div></div>
    <div class="footer">Showing requests overlapping the selected range (max 150 rows).</div>
  </div>

  <!-- Roster snapshot -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Roster Snapshot</h3>
    <div class="table-wrap">
      <table id="balTable">
        <thead>
          <tr>
            <th>Employee</th><th>Department</th><th>Manager</th><th>Status</th>
            <th>Vacation Avail (days)</th><th>Days Since Last PTO (ANY)</th><th>Risk</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer">Roster derived from Employee Reference + PTO Employee Info.</div>
  </div>

  <!-- Diagnostics -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Diagnostics</h3>
    <div class="muted" id="colInspector"></div>
    <details style="margin-top:8px;">
      <summary><strong>Skipped Rows (if any)</strong></summary>
      <div id="badRows"></div>
    </details>
  </div>
</div>

<script>
/* =============================== CONFIG =============================== */
const REQUESTS_CSV = './PTO Requests.csv';
const EMP_REF_CSV  = './Employee Reference.csv';
const PTO_INFO_CSV = './PTO Employee Info.csv';
const MS_DAY=86400000;

/* =============================== HELPERS ============================== */
const todayISO = () => new Date().toISOString().slice(0,10);
const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const dayStart = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
const dayISO   = d => dayStart(d).toISOString().slice(0,10);
const L = s => String(s||'').toLowerCase().trim();
const num = v => { const n = Number(String(v??'').replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; };
const cleanKey = s => String(s||'').replace(/\uFEFF/g,'').replace(/\s+/g,' ').trim().toLowerCase();
const isActive = s => L(s)==='active' || s===true || s==='1';

function pick(row, candidates){
  const map = new Map(Object.keys(row).map(k => [cleanKey(k), k]));
  for (const wanted of candidates){
    const k = map.get(cleanKey(wanted));
    if (k !== undefined) return row[k];
  }
  return undefined;
}

function normName(s){
  const t = String(s||'').trim();
  if (!t) return '';
  const m = /^([^,]+),\s*(.+)$/.exec(t);
  if (m) return (m[2] + ' ' + m[1]).replace(/\s+/g,' ').trim();
  return t.replace(/\s+/g,' ').trim();
}

function excelSerialToDate(n){
  const base = new Date(Date.UTC(1899,11,30));
  const d = new Date(base.getTime() + n*MS_DAY);
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

/* ----- Date parsing (robust) ----- */
const MONTH_MAP = (() => {
  const names = ['january','february','march','april','may','june','july','august','september','october','november','december'];
  const m=new Map(); names.forEach((n,i)=>m.set(n,i)); return m;
})();

function monthToIndex(v){
  if (v==null || v==='') return null;
  const s=String(v).trim();
  const n = parseInt(s,10);
  if (!isNaN(n) && n>=1 && n<=12) return n-1;
  const Ls=L(s);
  for (const [name,idx] of MONTH_MAP.entries()){
    if (name.startsWith(Ls) || Ls.startsWith(name.slice(0,3))) return idx;
  }
  const short = ['jan','feb','mar','apr','may','jun','jul','aug','sep','sept','oct','nov','dec'];
  const i = short.indexOf(Ls);
  if (i>=0) return i===8?8:i;
  return null;
}

function buildDateFromPieces(row, which){
  const Y = num(pick(row, ['Year']));
  if (!Y) return null;
  const mCandidates = which==='start'
    ? ['Month of Start Date','PTO Request Month 1','Month 1','Month of Start']
    : ['Month of End Date','PTO Request Month 2','Month 2','Month of End'];
  const dCandidates = which==='start'
    ? ['Start Day of Request','Request Day of Month','Day of Start Date','Start Day']
    : ['Day of End Date','End Day of Month','Day of End','End Day'];

  let M = monthToIndex(pick(row, mCandidates));
  let D = num(pick(row, dCandidates));
  if (!D && which==='end') D = num(pick(row, ['Day of End Date','Request Day of Month'])) || null;

  if (M==null || !D) return null;
  const dt = new Date(Y, M, D);
  return isNaN(+dt) ? null : dt;
}

function tryParseOneDate(raw){
  if (raw == null || raw === '') return null;
  if (typeof raw === 'number') {
    if (raw >= 30000 && raw <= 60000) return excelSerialToDate(raw);
    if (raw >= 19000101 && raw <= 20991231) {
      const s = String(raw);
      return new Date(+s.slice(0,4), +s.slice(4,6)-1, +s.slice(6,8));
    }
    return null;
  }
  let s = String(raw).trim();
  if (/^\d{5}$/.test(s)) { const n=+s; if(n>=30000&&n<=60000) return excelSerialToDate(n); }
  const ymd = s.match(/^(\d{4})(\d{2})(\d{2})$/);
  if (ymd) return new Date(+ymd[1], +ymd[2]-1, +ymd[3]);
  const md = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
  if (md) { const y = md[3].length===2 ? (2000+ +md[3]) : +md[3]; return new Date(y, +md[1]-1, +md[2]); }
  const d1 = new Date(Date.parse(s));
  if (!isNaN(d1)) return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
  const d2 = new Date(s.replace(/\./g,'/'));
  return isNaN(d2) ? null : new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
}

function parseDateFlexible(raw, row, which){
  if (raw != null && String(raw).trim()!=='') {
    if (typeof raw === 'number') { const d=tryParseOneDate(raw); return {start:d, end:d}; }
    const s = String(raw).trim();
    const parts = s.split(/\s*-\s*/);
    if (parts.length === 2) {
      const a = tryParseOneDate(parts[0]);
      const b = tryParseOneDate(parts[1]) || a;
      return {start:a, end:b};
    }
    const single = tryParseOneDate(s);
    return {start:single, end:single};
  }
  const sPiece = which==='start' ? buildDateFromPieces(row,'start') : null;
  const ePiece = which==='end'   ? buildDateFromPieces(row,'end')   : null;
  if (sPiece || ePiece) {
    const start = sPiece || ePiece;
    const end   = ePiece || sPiece;
    return {start, end};
  }
  return {start:null, end:null};
}

/* ====================== ROSTER KEY & MERGE (dedupe) =================== */
function makeRosterKey(rec){
  const id = String(pick(rec, ['EmpID','Emp ID','EmployeeID','Employee ID','EEID'])||'').trim();
  if(id) return ('ID:'+id).toUpperCase();
  const email = String(pick(rec, ['Email','Work Email','Email 1'])||'').trim();
  if(email) return ('EMAIL:'+email).toUpperCase();
  const nm = normName(pick(rec, ['Employee Name','Employee','Name','Full Name'])||'');
  return ('NAME:'+nm.toUpperCase());
}
function mergePeople(a,b){ const out={...a}; for(const k of Object.keys(b)){ const nv=b[k]; const ov=out[k]; if(nv!=null && nv!=='' && (ov==null||ov==='')) out[k]=nv; } return out; }

/* =============================== DATA ================================= */
let REQ_RAW=[], EMP_REF_RAW=[], PTO_INFO_RAW=[];
let REQ=[];
const ROSTER = new Map();
const badRows = [];
let chart=null;

/* =============================== IO =================================== */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Failed to load '+url);
  const text = await res.text();
  const parsed = Papa.parse(text, {header:true, dynamicTyping:true, skipEmptyLines:true});
  return parsed.data;
}

/* ============================ NORMALIZE =============================== */
function normalizeType(v){
  const t=L(v);
  if (/sick/.test(t)) return 'Sick';
  if (/vac|personal|pto/.test(t)) return 'Vacation';
  if (/unpaid|unpaiid/.test(t)) return 'Unpaid';
  return (v||'Other');
}

function harvestEmpRows(rows){
  rows.forEach(r=>{
    const key = makeRosterKey(r);
    const Name = normName(pick(r, ['Employee Name','Employee','Name','Full Name'])||'');
    const Department = String(pick(r,['Department','Team'])||'').trim();
    const Manager    = String(pick(r,['Direct Report','Manager'])||'').trim();
    const Status     = String(pick(r,['Employment Status','Status'])||'').trim();

    const VacAvail    = num(pick(r,['Vacation Avail (days)','Vacation Avail','Vacation Available','Vac Avail']));
    const SickAvail   = num(pick(r,['Sick Avail (days)','Sick Avail','Sick Available']));
    const UnpaidAvail = num(pick(r,['Unpaid Avail (days)','Unpaid Avail','Unpaid Available']));

    const rec = { key, Name, Department, Manager, Status, VacAvail, SickAvail, UnpaidAvail };
    if(ROSTER.has(key)) ROSTER.set(key, mergePeople(ROSTER.get(key), rec));
    else ROSTER.set(key, rec);
  });
}

function normalizeRequests(){
  REQ = [];
  badRows.length = 0;

  REQ_RAW.forEach((r, idx)=>{
    const EmpID = String(pick(r,['EmpID','Emp ID','EmployeeID','Employee ID','EEID','ID'])||'').trim();
    let Name    = normName(pick(r,[
      'Employee Name','Employee','Name','Full Name',
      'Employee Name 1','Employee Name 2','Employee Name 3'
    ])||'');
    const Email = String(pick(r,['Email','Work Email','Email 1'])||'').trim();

    let key = EmpID ? ('ID:'+EmpID).toUpperCase()
            : Email ? ('EMAIL:'+Email).toUpperCase()
            : Name  ? ('NAME:'+Name.toUpperCase())
            : null;

    if(!Name && key && ROSTER.has(key)) Name = ROSTER.get(key).Name || Name;

    // Primary date cell (can be "start - end")
    let rng = parseDateFlexible(pick(r,['PTO Request Dates','Dates','PTO Date','Date','Start']), r, 'start');

    // fallback: explicit Start/End
    if(!rng.start){
      const s2 = parseDateFlexible(pick(r,['PTO Request Start Date','Start Date','Start']), r, 'start').start;
      const e2 = parseDateFlexible(pick(r,['PTO Request End Date','End Date','End']), r, 'end').end;
      rng = {start: s2||e2||null, end: e2||s2||null};
    }

    // final fallback: month/day/year pieces
    if(!rng.start){
      const s3 = buildDateFromPieces(r,'start');
      const e3 = buildDateFromPieces(r,'end') || s3;
      rng = {start:s3, end:e3};
    }

    let {start:Start, end:End} = rng;
    if(End && Start && End<Start){ const t=Start; Start=End; End=t; }

    const sh   = pick(r,['Start AM/PM']) || '';
    const eh   = pick(r,['End AM/PM'])   || '';
    const type = normalizeType(pick(r,['PTO Request Type','Type','Category']));

    const meta = (key && ROSTER.get(key)) || {};
    const dept   = (meta.Department || pick(r,['Department','Team']) || 'Unknown').toString().trim();
    const mgr    = (meta.Manager    || pick(r,['Direct Report','Manager']) || '').toString().trim();
    const status = (meta.Status     || pick(r,['Employment Status','Status']) || '').toString().trim();

    const reasons=[];
    if(!Name && !key) reasons.push('no EmpID/Email/Name');
    if(!Start) reasons.push('no parsable date (even after month/day/year rebuild)');
    if(reasons.length){ badRows.push({idx, why: reasons.join(', '), raw:r}); return; }

    REQ.push({
      key: key||('NAME:'+Name.toUpperCase()),
      emp: Name||key,
      type, s:Start, e:End||Start, sh, eh,
      dept, mgr, status, raw:r
    });
  });
}

/* ============================ FILTERS/UTIL ============================ */
function passesFilters(r){
  // default: hide inactive
  const statusWanted = document.getElementById('fStatus').value;
  if(!statusWanted && !isActive(r.status)) return false;
  if(statusWanted && L(r.status)!==L(statusWanted)) return false;

  const dept=L(document.getElementById('fDept').value);
  const mgr =L(document.getElementById('fMgr').value);
  const type=L(document.getElementById('fType').value);
  const q   =L(document.getElementById('fSearch').value);

  if(dept && L(r.dept)!==dept) return false;
  if(mgr  && L(r.mgr)!==mgr) return false;
  if(type && L(r.type)!==type) return false;
  if(q){
    const blob=[r.emp,r.dept,r.mgr,r.type,r.status].map(x=>String(x||'').toLowerCase()).join('|');
    if(!blob.includes(q)) return false;
  }
  return true;
}

function buildFilterOptions(){
  function setOptions(el, arr){
    const opts=[...new Set(arr.map(x=>String(x||'').trim()).filter(Boolean))].sort();
    el.innerHTML='<option value="">All</option>'+opts.map(v=>`<option>${v}</option>`).join('');
  }
  const depts = new Set(); const mgrs = new Set();
  ROSTER.forEach(m=>{ if(m.Department) depts.add(m.Department); if(m.Manager) mgrs.add(m.Manager); });
  REQ.forEach(r=>{ if(r.dept) depts.add(r.dept); if(r.mgr) mgrs.add(r.mgr); });
  setOptions(document.getElementById('fDept'), [...depts]);
  setOptions(document.getElementById('fMgr'),  [...mgrs]);
}

function overlapDays(r, rs, re){
  const a = dayStart(r.s), b = dayStart(r.e);
  const start = a>rs ? a : rs;
  const end   = b<re ? b : re;
  const diff = Math.floor((end - start)/MS_DAY) + 1;
  if (diff<=0) return 0;
  return (r.sh||r.eh) ? 0.5*diff : diff;
}

/* ============================== RENDER ================================ */
function renderAll(){
  const dateFrom = document.getElementById('dateFrom');
  const dateTo   = document.getElementById('dateTo');
  const rs=parseDateFlexible(dateFrom.value).start||new Date();
  const re=parseDateFlexible(dateTo.value).start||rs;
  if(re<rs){ dateTo.value=dateFrom.value; return; }

  // filter, compute overlaps
  let rows = REQ
    .map(r=> ({...r, overlapDays: overlapDays(r, rs, re)}))
    .filter(r=> r.overlapDays>0 && passesFilters(r));

  // Optional: collapse exact duplicate request rows (name+dates+type+dept)
  const uniq = new Map();
  rows.forEach(r=>{
    const k = `${r.emp}|${dayISO(r.s)}|${dayISO(r.e)}|${r.type}|${r.dept}`;
    if(!uniq.has(k)) uniq.set(k, r);
  });
  rows = [...uniq.values()];

  // KPIs
  document.getElementById('kpiRequests').textContent = rows.length;
  document.getElementById('kpiPeople').textContent   = new Set(rows.map(r=>r.emp)).size;
  document.getElementById('kpiDepts').textContent    = new Set(rows.map(r=>r.dept)).size;
  document.getElementById('kpiDays').textContent     = rows.reduce((a,r)=>a+r.overlapDays,0);

  const last14 = addDays(new Date(), -14);
  let sick14=0, vac14=0;
  REQ.forEach(r=>{
    if(r.s>=last14 && r.s<=new Date()){
      if(r.type==='Sick') sick14++; else if(r.type==='Vacation') vac14++;
    }
  });
  document.getElementById('kpiSick14').textContent = sick14;
  document.getElementById('kpiVac14').textContent  = vac14;

  // Requests list
  const reqList = document.getElementById('reqList');
  reqList.innerHTML='';
  rows.sort((a,b)=> (a.s-b.s) || a.emp.localeCompare(b.emp)).forEach(r=>{
    const li=document.createElement('li');
    li.innerHTML = `<div>${r.emp} ‚Ä¢ ${r.type}</div>
                    <div><span class="pill">${r.dept}</span> <span class="muted">${dayISO(r.s)} ‚Üí ${dayISO(r.e)} ‚Ä¢ ${r.overlapDays}d</span></div>`;
    reqList.appendChild(li);
  });

  // By Employee usage table
  renderByEmployeeUsage(rows);

  renderChart(rows);
  renderHeatmap(rows, rs, re);
  renderGantt(rows, rs, re);
  renderRosterTable();
  renderBurnout();
  renderDiagnostics();
}

function renderByEmployeeUsage(rows){
  const tb = document.querySelector('#empUsageTable tbody');
  tb.innerHTML='';

  const agg = new Map();
  function bump(name, dept, type, days){
    const s = agg.get(name) || {dept, vac:0, sick:0, unpaid:0};
    if(type==='Vacation') s.vac += days;
    else if(type==='Sick') s.sick += days;
    else if(type==='Unpaid') s.unpaid += days;
    agg.set(name, s);
  }
  rows.forEach(r=> bump(r.emp, r.dept, r.type, r.overlapDays));

  const out=[];
  agg.forEach((v,name)=>{
    let rec=null;
    for(const m of ROSTER.values()){ if((m.Name||'').toLowerCase()===name.toLowerCase()){ rec=m; break; } }
    out.push({
      name,
      dept: v.dept || rec?.Department || '',
      vacU: v.vac,        vacA: rec?.VacAvail ?? '‚Äî',
      sickU: v.sick,      sickA: rec?.SickAvail ?? '‚Äî',
      unpU: v.unpaid,     unpA: rec?.UnpaidAvail ?? '‚Äî',
    });
  });
  out.sort((a,b)=> (b.vacU+b.sickU+b.unpU) - (a.vacU+a.sickU+a.unpU));

  out.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${x.name}</td><td>${x.dept}</td>
                    <td>${x.vacU||0}</td><td>${x.vacA}</td>
                    <td>${x.sickU||0}</td><td>${x.sickA}</td>
                    <td>${x.unpU||0}</td><td>${x.unpA}</td>`;
    tb.appendChild(tr);
  });
}

function renderChart(rows){
  const mode = document.getElementById('chartMode').value;
  if(chart) chart.destroy();

  if(mode==='days'){
    const byDept={}; rows.forEach(r=>{ byDept[r.dept]=(byDept[r.dept]||0)+r.overlapDays; });
    const labels=Object.keys(byDept).sort();
    const data=labels.map(l=>byDept[l]);
    chart = new Chart(document.getElementById('deptChart'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Person-Days', data }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  } else {
    const headcountByDept={};
    ROSTER.forEach(m=>{
      if(isActive(m.Status)){
        headcountByDept[m.Department]=(headcountByDept[m.Department]||0)+1;
      }
    });
    const byDeptPeople=new Map();
    rows.forEach(r=>{
      const set = byDeptPeople.get(r.dept) || new Set();
      set.add(r.emp); byDeptPeople.set(r.dept,set);
    });

    const labels=Object.keys(headcountByDept).sort();
    const data=labels.map(d=>{
      const tot=headcountByDept[d]||0, outs=(byDeptPeople.get(d)||new Set()).size;
      return tot>0 ? Math.round((1 - outs/tot)*100) : 100;
    });
    chart = new Chart(document.getElementById('deptChart'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Coverage %', data }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' } } } }
    });
  }
}

/* ---- Heatmap with ISO week numbers and month boundaries ---- */
function isoWeek(d){
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = (tmp.getUTCDay()+6)%7; // Mon=0
  tmp.setUTCDate(tmp.getUTCDate()-dayNum+3);
  const firstThu = new Date(Date.UTC(tmp.getUTCFullYear(),0,4));
  const week = 1 + Math.round(((tmp - firstThu)/86400000 - 3)/7);
  return week;
}
function renderHeatmap(rows, rs, re){
  const heatmap = document.getElementById('heatmap');
  const legend = document.getElementById('heatmapLegend');
  const note = document.getElementById('heatmapNote');
  heatmap.innerHTML=''; legend.innerHTML='';

  // Header row
  const header = document.createElement('div');
  header.style.display='grid';
  header.style.gridTemplateColumns='60px repeat(7, 1fr)';
  header.style.gap='6px';
  header.style.margin='0 0 6px';
  header.innerHTML = `<div class="muted" style="font-size:12px;">Week</div>
    <div class="muted" style="text-align:center">Sun</div>
    <div class="muted" style="text-align:center">Mon</div>
    <div class="muted" style="text-align:center">Tue</div>
    <div class="muted" style="text-align:center">Wed</div>
    <div class="muted" style="text-align:center">Thu</div>
    <div class="muted" style="text-align:center">Fri</div>
    <div class="muted" style="text-align:center">Sat</div>`;
  heatmap.appendChild(header);

  const container = document.createElement('div');
  container.style.display='grid';
  container.style.gridTemplateColumns='60px repeat(7, 1fr)';
  container.style.gap='6px';

  let cursor = new Date(rs); cursor.setDate(cursor.getDate()-cursor.getDay());
  while(cursor <= re){
    // week number cell (left)
    const wk = document.createElement('div');
    wk.className='heatcell';
    wk.style.textAlign='right';
    wk.style.background='#fff';
    wk.textContent = isoWeek(cursor);
    wk.style.fontWeight='600';
    container.appendChild(wk);

    for(let i=0;i<7;i++){
      const d = new Date(cursor);
      const inRange = d>=dayStart(rs) && d<=dayStart(re);
      const cell=document.createElement('div'); cell.className='heatcell';
      if(!inRange){ cell.style.visibility='hidden'; container.appendChild(cell); cursor=addDays(cursor,1); continue; }

      // count load for this day
      const count = rows.reduce((acc,r)=> acc + ( (dayStart(r.s)<=d && dayStart(r.e)>=d) ? (r.sh||r.eh?0.5:1) : 0 ), 0);
      const max=10; const t=Math.min(1, count/max); const a=Math.max(0.08, 0.15 + 0.55*t);
      cell.style.background=`rgba(16,185,129,${a})`;
      cell.innerHTML = `<div class="d">${d.getDate()}</div><div class="muted" style="font-size:12px;">${count||0}</div>`;

      if(d.getDate()===1){ cell.style.outline='2px solid #c7e5d9'; cell.style.outlineOffset='-2px'; cell.title = d.toLocaleString(undefined,{month:'long',year:'numeric'}); }
      container.appendChild(cell);
      cursor = addDays(cursor,1);
    }
  }
  heatmap.appendChild(container);

  legend.innerHTML = `<span class="muted">Load:</span>
    <span class="swatch" style="background:#fafafa;"></span>
    <span class="swatch" style="background:rgba(16,185,129,.35)"></span>
    <span class="swatch" style="background:rgba(16,185,129,.55)"></span>
    <span class="swatch" style="background:rgba(16,185,129,.7)"></span>`;
  note.textContent = `${dayISO(rs)} ‚Üí ${dayISO(re)}`;
}

function renderGantt(rows, rs, re){
  const ganttRange = document.getElementById('ganttRange');
  const ganttGrid  = document.getElementById('ganttGrid');
  ganttRange.textContent = `${dayISO(rs)} ‚Üí ${dayISO(re)}`;
  const MAX=150, span=Math.max(1, Math.floor((dayStart(re)-dayStart(rs))/MS_DAY)+1);
  ganttGrid.innerHTML='';
  rows.slice(0,MAX).sort((a,b)=> a.emp.localeCompare(b.emp) || (a.s-b.s)).forEach(r=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.borderBottom='1px dashed #eee'; row.style.padding='6px 0'; row.style.height='28px';
    const name=document.createElement('div'); name.style.width='180px'; name.style.flex='0 0 180px'; name.style.fontSize='13px'; name.style.whiteSpace='nowrap'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis'; name.textContent=r.emp;
    const lane=document.createElement('div'); lane.style.position='relative'; lane.style.height='8px'; lane.style.flex='1'; lane.style.background='linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px) 0 0/14px 100% no-repeat'; lane.style.borderRadius='8px';
    const start = dayStart(r.s)<dayStart(rs) ? rs : r.s;
    const end   = dayStart(r.e)>dayStart(re) ? re : r.e;
    const offset = Math.max(0, Math.floor((dayStart(start)-dayStart(rs))/MS_DAY));
    const len = Math.max(0.2, overlapDays(r, rs, re));
    const leftPct = (offset/span)*100, widthPct=(len/span)*100;
    const bar=document.createElement('div'); bar.style.position='absolute'; bar.style.top='-2px'; bar.style.height='12px'; bar.style.borderRadius='8px';
    bar.style.background='#d1fae5'; bar.style.border='1px solid #10b981'; bar.style.left=leftPct+'%'; bar.style.width=widthPct+'%';
    bar.title = `${r.emp} ‚Ä¢ ${r.type} ‚Ä¢ ${dayISO(r.s)} ‚Üí ${dayISO(r.e)} (${r.overlapDays}d)`;
    lane.appendChild(bar);
    row.appendChild(name); row.appendChild(lane); ganttGrid.appendChild(row);
  });
}

function renderRosterTable(){
  const tbody = document.querySelector('#balTable tbody');
  tbody.innerHTML='';
  const statusSel = document.getElementById('fStatus').value;
  const rows=[...ROSTER.values()]
    .filter(r => statusSel ? L(r.Status)===L(statusSel) : isActive(r.Status))
    .sort((a,b)=> (a.Name||'').localeCompare(b.Name||''));
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.Name||r.key}</td>
      <td>${r.Department||''}</td>
      <td>${r.Manager||''}</td>
      <td>${r.Status||''}</td>
      <td>${r.VacAvail||''}</td>
      <td>${(r.DaysSinceAny??'')!==''?r.DaysSinceAny:''}</td>
      <td>${r.Risk||''}</td>`;
    tbody.appendChild(tr);
  });
}

function renderBurnout(){
  const today = dayStart(new Date());
  const last14 = addDays(today, -14);
  const fStatusVal=document.getElementById('fStatus').value;

  const byKey = new Map();
  function ensure(key, name){
    if(!byKey.has(key)) byKey.set(key, {name, lastAny:null, lastVac:null, sick14:0, vac14:0});
    return byKey.get(key);
  }
  REQ.forEach(r=>{
    const s = ensure(r.key, r.emp);
    if(!s.lastAny || r.s > s.lastAny) s.lastAny = r.s;
    if(r.type!=='Sick'){ if(!s.lastVac || r.s > s.lastVac) s.lastVac = r.s; }
    if(r.s>=last14 && r.s<=today){
      if(r.type==='Sick') s.sick14++; else s.vac14++;
    }
  });

  const allKeys = new Set([...byKey.keys(), ...ROSTER.keys()]);
  const items=[];
  allKeys.forEach(k=>{
    const rec = ROSTER.get(k)||{};
    if(!fStatusVal && !isActive(rec.Status)) return;   // default hide inactive
    if(fStatusVal && L(rec.Status)!==L(fStatusVal)) return;

    const s = byKey.get(k)||{name:(rec.Name||k), lastAny:null, lastVac:null, sick14:0, vac14:0};
    const daysSinceAny = s.lastAny ? Math.floor((today - dayStart(s.lastAny))/MS_DAY) : (rec.DaysSinceAny!=null? rec.DaysSinceAny : null);
    const daysSinceVac = s.lastVac ? Math.floor((today - dayStart(s.lastVac))/MS_DAY) : null;

    const anyCut=12, vacCut=45;
    let risk='OK';
    if((daysSinceAny??999) >= anyCut || (daysSinceVac??999) >= vacCut) risk='Watch';
    if((daysSinceAny??999) >= anyCut && (daysSinceVac??999) >= vacCut) risk='High';

    items.push({ name: s.name, dept: rec.Department||'', mgr: rec.Manager||'', sick14: s.sick14, vac14: s.vac14, daysSinceAny, daysSinceVac, risk });
  });

  items.sort((a,b)=>{
    const o={High:0,Watch:1,OK:2};
    const d = (o[a.risk]-o[b.risk]); if(d) return d;
    return (b.daysSinceVac??-1)-(a.daysSinceVac??-1);
  });

  const ul=document.getElementById('burnoutList');
  ul.innerHTML='';
  items.forEach(x=>{
    const cls = x.risk==='High'?'bad':(x.risk==='Watch'?'warn':'ok');
    const li=document.createElement('li');
    li.innerHTML = `<div>${x.name} ‚Ä¢ <span class="pill">${x.dept||''}</span> <span class="muted">${x.mgr||''}</span></div>
                    <div><span class="pill">Any: ${x.daysSinceAny==null?'‚Äî':x.daysSinceAny}d</span>
                         <span class="pill">Vac: ${x.daysSinceVac==null?'‚Äî':x.daysSinceVac}d</span>
                         <span class="pill">Sick14: ${x.sick14}</span>
                         <span class="pill">Vac14: ${x.vac14}</span>
                         <span class="pill status ${cls}">${x.risk}</span></div>`;
    ul.appendChild(li);
  });
  document.getElementById('burnoutCount').textContent = items.filter(i=>i.risk!=='OK').length;
}

function renderDiagnostics(){
  const col = t => Object.keys((t?.[0])||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
  document.getElementById('colInspector').textContent =
    `Detected columns ‚Äî PTO Requests: [${col(REQ_RAW).join(', ')}] ‚Ä¢ Employee Reference: [${col(EMP_REF_RAW).join(', ')}] ‚Ä¢ PTO Employee Info: [${col(PTO_INFO_RAW).join(', ')}]`;

  const badBox = document.getElementById('badRows');
  badBox.innerHTML = badRows.length ? badRows.slice(0,150).map(b=>{
    const sample = JSON.stringify(b.raw);
    return `<div class="badrow">Row#${b.idx+1} ‚Ä¢ ${b.why}\n${sample}</div>`;
  }).join('') : '<div class="muted">No skipped rows üéâ</div>';
  if(badRows.length>150){
    const more=document.createElement('div'); more.className='muted'; more.textContent=`+ ${badRows.length-150} more‚Ä¶`; badBox.appendChild(more);
  }
}

/* ============================== INIT ================================== */
async function init(){
  const t=new Date();
  document.getElementById('dateFrom').value = todayISO();
  document.getElementById('dateTo').value   = addDays(t,7).toISOString().slice(0,10);
  document.getElementById('asOf').textContent = new Date().toLocaleString();

  try{
    [REQ_RAW, EMP_REF_RAW, PTO_INFO_RAW] = await Promise.all([
      loadCSV(REQUESTS_CSV), loadCSV(EMP_REF_CSV), loadCSV(PTO_INFO_CSV)
    ]);
  }catch(e){ console.error(e); }

  // Build roster from both employee files (deduping)
  ROSTER.clear();
  harvestEmpRows(EMP_REF_RAW||[]);
  harvestEmpRows(PTO_INFO_RAW||[]);

  // Requests
  normalizeRequests();

  // Filters + render
  buildFilterOptions();
  renderAll();
}

/* ============================== EVENTS ================================ */
document.getElementById('refreshBtn').addEventListener('click', init);
['dateFrom','dateTo','fDept','fMgr','fType','fStatus','chartMode'].forEach(id=> document.getElementById(id).addEventListener('change', renderAll));
document.getElementById('fSearch').addEventListener('input', renderAll);

function setRange(start,end){ document.getElementById('dateFrom').value=dayISO(start); document.getElementById('dateTo').value=dayISO(end); renderAll(); }
document.getElementById('rngToday').addEventListener('click', ()=>{ const t=new Date(); setRange(t,t); });
document.getElementById('rng7').addEventListener('click', ()=>{ const t=new Date(); setRange(t, addDays(t,7)); });
document.getElementById('rng14').addEventListener('click', ()=>{ const t=new Date(); setRange(t, addDays(t,14)); });
document.getElementById('rng30').addEventListener('click', ()=>{ const t=new Date(); setRange(t, addDays(t,30)); });
document.getElementById('rngMonth').addEventListener('click', ()=>{
  const t=new Date();
  const start=new Date(t.getFullYear(), t.getMonth(), 1);
  const end=new Date(t.getFullYear(), t.getMonth()+1, 0);
  setRange(start,end);
});

init();
</script>
</body>
</html>
