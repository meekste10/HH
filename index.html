<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Holland Homes ‚Ä¢ PTO Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdnjs.cloudflare.com/" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root { --brand:#184A30; --ink:#1c1c1c; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; --line:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  body { margin:0; background:var(--bg); color:var(--ink); }
  header { background:var(--brand); color:#fff; padding:16px 20px; }
  header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
  .wrap { max-width:1200px; margin:0 auto; padding:16px; }
  .row { display:grid; gap:12px; }
  .grid-6 { grid-template-columns: repeat(6, 1fr); }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .grid-2 { grid-template-columns: repeat(2, 1fr); }
  .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toolbar input, .toolbar select, .toolbar button { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; background:#fff; font-size:14px; }
  .btn { cursor:pointer; }
  .kpi { display:flex; align-items:baseline; gap:8px; }
  .kpi .big { font-size:26px; font-weight:700; }
  .kpi .label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.2px; }
  .list { margin:8px 0 0; padding:0; list-style:none; }
  .list li { padding:8px 0; border-bottom:1px dashed #eee; font-size:14px; display:flex; justify-content:space-between; gap:10px; }
  .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
  .muted { color:var(--muted); }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .status.ok{border-color:var(--ok); color:#065f46}
  .status.warn{border-color:var(--warn); color:#7c2d12}
  .status.bad{border-color:var(--bad); color:#7f1d1d}

  .scroll-card { max-height: 420px; overflow:auto; border-radius:12px; -webkit-overflow-scrolling:touch; }
  .scroll-card h3 { position: sticky; top: 0; background: var(--card); padding-bottom:6px; margin-top:0; }

  canvas { width:100%; height:260px; }

  .table-wrap { overflow:auto; max-height: 460px; -webkit-overflow-scrolling:touch; border:1px solid #e5e7eb; border-radius:12px; }
  table { width:100%; border-collapse: collapse; font-size:14px; min-width: 860px; }
  th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
  th { font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; position: sticky; top: 0; background: #fff; z-index: 1; }

  /* Heatmap */
  .heatmap { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .heatcell { border-radius:6px; padding:8px; text-align:center; border:1px solid #eee; background:#fafafa; position:relative; }
  .heatcell .d { font-weight:600; }
  .wk { position:absolute; top:4px; left:4px; font-size:10px; color:#4b5563; background:#fff; border:1px solid #e5e7eb; padding:0 4px; border-radius:999px; }
  .mo { position:absolute; top:-10px; right:4px; font-size:10px; color:#111827; background:#fff; border:1px solid #e5e7eb; padding:0 6px; border-radius:999px; }
  .monthTop { border-top:2px solid #94a3b8 !important; }

  details summary{cursor:pointer}
  code{font-family:ui-monospace,Menlo,Consolas,monospace}
  .badrow{font-family:ui-monospace; font-size:12px; white-space:pre-wrap; background:#fff7ed; border:1px dashed #f59e0b; padding:8px; border-radius:8px; margin:6px 0;}
  @media (max-width: 1024px){ .grid-6, .grid-3, .grid-2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header><h1>Holland Homes ‚Äî PTO Dashboard</h1></header>

<div class="wrap">

  <!-- Controls -->
  <div class="toolbar card" style="justify-content:space-between;">
    <div class="toolbar">
      <label>From: <input id="dateFrom" type="date" /></label>
      <label>To: <input id="dateTo" type="date" /></label>

      <button class="btn" id="rngToday">Today</button>
      <button class="btn" id="rng7">Next 7</button>
      <button class="btn" id="rng14">Next 14</button>
      <button class="btn" id="rng30">Next 30</button>
      <button class="btn" id="rngMonth">This Month</button>

      <label>Department:<select id="fDept"><option value="">All</option></select></label>
      <label>Manager:<select id="fMgr"><option value="">All</option></select></label>
      <label>Type:
        <select id="fType">
          <option value="">All</option>
          <option>Vacation</option><option>Sick</option><option>Unpaid</option>
        </select>
      </label>
      <label>Employment:
        <select id="fStatus">
          <option value="Active">Active</option>
          <option value="">All</option>
          <option>Inactive</option>
        </select>
      </label>
      <label>Search: <input id="fSearch" type="search" placeholder="Name, dept, manager‚Ä¶" /></label>
    </div>
    <div class="toolbar">
      <button id="refreshBtn" class="btn" type="button">Reload Data</button>
      <span class="footer">From CSV ‚Ä¢ <span id="asOf"></span></span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row grid-6">
    <div class="card kpi"><span class="big" id="kpiRequests">0</span><span class="label">Requests</span></div>
    <div class="card kpi"><span class="big" id="kpiPeople">0</span><span class="label">Unique Employees</span></div>
    <div class="card kpi"><span class="big" id="kpiDepts">0</span><span class="label">Departments</span></div>
    <div class="card kpi"><span class="big" id="kpiDays">0</span><span class="label">Total Person-Days</span></div>
    <div class="card kpi"><span class="big" id="kpiSick14">0</span><span class="label">Sick events (14d)</span></div>
    <div class="card kpi"><span class="big" id="kpiVac14">0</span><span class="label">Vac/Personal (14d)</span></div>
  </div>

  <!-- Lists + Team chart -->
  <div class="row grid-3" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Requests</h3>
      <ul class="list" id="reqList"></ul>
    </div>
    <div class="card scroll-card">
      <h3>By Employee (Balances & Usage)</h3>
      <div class="table-wrap">
        <table id="empUsageTable">
          <thead>
            <tr>
              <th>Employee</th><th>Department</th>
              <th>Vac Used</th><th>Vac Avail</th>
              <th>Sick Used</th><th>Sick Avail</th>
              <th>Unpaid Used</th><th>Unpaid Avail</th>
            </tr>
          </thead>
          <tbody id="empUsageTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card scroll-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">By Team</h3>
        <label class="muted">Metric:
          <select id="chartMode">
            <option value="days">Person-Days</option>
            <option value="coverage">Coverage %</option>
          </select>
        </label>
      </div>
      <canvas id="deptChart" aria-label="Team metric"></canvas>
    </div>
  </div>

  <!-- Heatmap + Burnout -->
  <div class="row grid-2" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Calendar Heatmap</h3>
      <div id="heatmapLegend" class="legend" style="margin:6px 0 8px;"></div>
      <div id="heatmap" class="heatmap"></div>
      <div class="footer" id="heatmapNote"></div>
    </div>
    <div class="card scroll-card">
      <h3>Burnout Radar</h3>
      <div class="muted" style="margin:4px 0 8px;">Sick counts as rest for ‚Äúdays since any time-off‚Äù; vacation/personal tracked separately. Inactive filtered by default.</div>
      <ul class="list" id="burnoutList"></ul>
      <div class="footer"><span id="burnoutCount">0</span> employee(s) flagged</div>
    </div>
  </div>

  <!-- Timeline/Gantt -->
  <div class="card" style="margin-top:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Timeline</h3>
      <div class="muted" id="ganttRange"></div>
    </div>
    <div class="gantt"><div class="gantt-grid" id="ganttGrid" style="position:relative; min-width:900px;"></div></div>
    <div class="footer">Showing requests overlapping the selected range (max 150 rows). Inactive excluded by default.</div>
  </div>

  <!-- Roster snapshot -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Roster Snapshot</h3>
    <div class="table-wrap">
      <table id="balTable">
        <thead>
          <tr>
            <th>Employee</th><th>Department</th><th>Manager</th><th>Status</th>
            <th>Vacation Avail (days)</th><th>Days Since Last PTO (ANY)</th><th>Risk</th>
          </tr>
        </thead>
        <tbody id="balTableBody"></tbody>
      </table>
    </div>
    <div class="footer">Roster derived from Employee Reference + PTO Employee Info.</div>
  </div>

  <!-- Diagnostics -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Diagnostics</h3>
    <div class="muted" id="colInspector"></div>
    <details style="margin-top:8px;">
      <summary><strong>Skipped Rows (if any)</strong></summary>
      <div id="badRows"></div>
    </details>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const REQUESTS_CSV = './PTO Requests.csv';
  const EMP_REF_CSV  = './Employee Reference.csv';
  const PTO_INFO_CSV = './PTO Employee Info.csv';
  const MS_DAY = 86400000;

  // ===== Robust date IO =====
  const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const dayStart = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const L = s => String(s||'').toLowerCase().trim();

  function parseInputDate(v){
    // Only accepts YYYY-MM-DD from input[type=date]
    if(!v) return null;
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v);
    if(!m) return null;
    return new Date(+m[1], +m[2]-1, +m[3]);
  }

  function setRange(start,end){
    dateFrom.value = fmt(dayStart(start));
    dateTo.value   = fmt(dayStart(end));
    renderAll();
  }

  // ===== CSV loader (cache-busted) =====
  async function loadCSV(url){
    const res = await fetch(url + `?v=${Date.now()}`, {cache:'no-store'});
    if(!res.ok) throw new Error('Fetch failed: '+url);
    const text = await res.text();
    return parseCSV(text);
  }
  function parseCSV(str){
    const lines=[]; let i=0, cur='', row=[], inQ=false;
    const pushRow=()=>{ lines.push(row); row=[]; };
    while(i<str.length){
      const ch=str[i];
      if(ch==='\"'){ if(inQ && str[i+1]==='\"'){ cur+='\"'; i+=2; continue; } inQ=!inQ; i++; continue; }
      if(ch===',' && !inQ){ row.push(cur); cur=''; i++; continue; }
      if((ch==='\n'||ch==='\r') && !inQ){ row.push(cur); cur=''; if(row.length) pushRow(); if(ch==='\r' && str[i+1]==='\n') i++; i++; continue; }
      cur+=ch; i++;
    }
    if(cur!=='' || row.length){ row.push(cur); pushRow(); }
    if(lines.length===0) return [];
    const header=lines[0];
    return lines.slice(1).map(r=>{ const o={}; header.forEach((h,idx)=>o[h]=r[idx]??''); return o; });
  }

  // ===== DOM =====
  const dateFrom = document.getElementById('dateFrom');
  const dateTo   = document.getElementById('dateTo');
  const rngToday = document.getElementById('rngToday');
  const rng7 = document.getElementById('rng7');
  const rng14 = document.getElementById('rng14');
  const rng30 = document.getElementById('rng30');
  const rngMonth = document.getElementById('rngMonth');
  const fDept = document.getElementById('fDept');
  const fMgr = document.getElementById('fMgr');
  const fType = document.getElementById('fType');
  const fStatus = document.getElementById('fStatus');
  const fSearch = document.getElementById('fSearch');
  const refreshBtn = document.getElementById('refreshBtn');
  const asOf = document.getElementById('asOf');
  const reqList = document.getElementById('reqList');
  const empUsageTableBody = document.getElementById('empUsageTableBody');
  const chartMode = document.getElementById('chartMode');
  const deptChart = document.getElementById('deptChart');
  const heatmap = document.getElementById('heatmap');
  const heatmapLegend = document.getElementById('heatmapLegend');
  const heatmapNote = document.getElementById('heatmapNote');
  const ganttGrid = document.getElementById('ganttGrid');
  const ganttRange = document.getElementById('ganttRange');
  const balTableBody = document.getElementById('balTableBody');
  const colInspector = document.getElementById('colInspector');
  const badRowsBox = document.getElementById('badRows');

  const kpiRequests = document.getElementById('kpiRequests');
  const kpiPeople = document.getElementById('kpiPeople');
  const kpiDepts = document.getElementById('kpiDepts');
  const kpiDays = document.getElementById('kpiDays');
  const kpiSick14 = document.getElementById('kpiSick14');
  const kpiVac14 = document.getElementById('kpiVac14');

  // ===== Helpers for parsing request dates =====
  const num = v => { const n = Number(String(v??'').replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; };
  const cleanKey = s => String(s||'').replace(/\uFEFF/g,'').replace(/\s+/g,' ').trim().toLowerCase();
  function pick(row, candidates){
    const map = new Map(Object.keys(row).map(k => [cleanKey(k), k]));
    for (const wanted of candidates){ const k = map.get(cleanKey(wanted)); if (k !== undefined) return row[k]; }
    return undefined;
  }
  function normName(s){
    const t = String(s||'').trim();
    if (!t) return '';
    const m = /^([^,]+),\s*(.+)$/.exec(t);
    if (m) return (m[2] + ' ' + m[1]).replace(/\s+/g,' ').trim();
    return t.replace(/\s+/g,' ').trim();
  }
  const excelSerialToDate = (n) => {
    const base = new Date(Date.UTC(1899,11,30));
    const d = new Date(base.getTime() + n*MS_DAY);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  };
  function tryParseOneDate(raw){
    if (raw == null || raw === '') return null;
    if (typeof raw === 'number') {
      if (raw >= 30000 && raw <= 60000) return excelSerialToDate(raw);
      if (raw >= 19000101 && raw <= 20991231) { const s=String(raw); return new Date(+s.slice(0,4), +s.slice(4,6)-1, +s.slice(6,8)); }
      return null;
    }
    let s = String(raw).trim();
    if (/^\d{5}$/.test(s)) { const n=+s; if (n>=30000 && n<=60000) return excelSerialToDate(n); }
    const ymd = s.match(/^(\d{4})(\d{2})(\d{2})$/); if (ymd) return new Date(+ymd[1], +ymd[2]-1, +ymd[3]);
    const md = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
    if (md) { const y = md[3].length===2 ? (2000+ +md[3]) : +md[3]; return new Date(y, +md[1]-1, +md[2]); }
    const d1 = new Date(Date.parse(s)); if (!isNaN(d1)) return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
    const d2 = new Date(s.replace(/\./g,'/')); return isNaN(d2) ? null : new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
  }
  function parseDateFlexible(raw){
    if (raw != null && String(raw).trim()!=='') {
      if (typeof raw === 'number') { const d=tryParseOneDate(raw); return {start:d, end:d}; }
      const s = String(raw).trim();
      const parts = s.split(/\s*-\s*/);
      if (parts.length === 2) { const a=tryParseOneDate(parts[0]); const b=tryParseOneDate(parts[1])||a; return {start:a,end:b}; }
      const single = tryParseOneDate(s);
      return {start:single, end:single};
    }
    return {start:null, end:null};
  }

  // ===== Data structures =====
  let REQ_RAW=[], EMP_REF_RAW=[], PTO_INFO_RAW=[];
  let REQ=[]; const badRows=[];
  const ROSTER = new Map();
  let deptBarChart=null;

  function keyFrom(EmpID, Email, Name){
    if (EmpID) return ('ID:'+String(EmpID).trim().toUpperCase());
    if (Email) return ('EMAIL:'+String(Email).trim().toUpperCase());
    if (Name)  return ('NAME:'+String(Name).trim().toUpperCase());
    return null;
  }
  function normalizeType(v){
    const t=L(v);
    if (/sick/.test(t)) return 'Sick';
    if (/vac|personal|pto/.test(t)) return 'Vacation';
    if (/unpaid|unpaiid/.test(t)) return 'Unpaid';
    return (v||'Other');
  }

  // ===== Build roster (dedupe) =====
  function harvestEmpRows(rows){
    rows.forEach(r=>{
      const EmpID = String(pick(r,['EmpID','Emp ID','EmployeeID','Employee ID','EEID','ID'])||'').trim();
      const Email = String(pick(r,['Email','Work Email','Email 1'])||'').trim();
      const Name  = normName(pick(r,['Employee Name','Employee','Name','Full Name'])||'');
      const key = keyFrom(EmpID, Email, Name);
      if(!key) return;

      const prev = ROSTER.get(key) || {};
      const rec = {
        key,
        EmpID: EmpID || prev.EmpID,
        Email: Email || prev.Email,
        Name:  Name  || prev.Name,
        Department: (pick(r,['Department','Team'])||prev.Department||'').toString().trim(),
        Manager: (pick(r,['Direct Report','Manager'])||prev.Manager||'').toString().trim(),
        Status: (pick(r,['Employment Status','Status'])||prev.Status||'').toString().trim(),
        VacAvail: num(pick(r, ['Vacation Avail','Vacation Available','Vac Avail','Vacation Balance','Vacation Days Available'] ) || prev.VacAvail),
        SickAvail: num(pick(r, ['Sick Avail','Sick Available','Sick Balance','Sick Days Available'] ) || prev.SickAvail),
        UnpaidAvail: num(pick(r, ['Unpaid Avail','Unpaid Available'] ) || prev.UnpaidAvail),
        DaysSinceAny: prev.DaysSinceAny ?? null,
        Risk: prev.Risk || ''
      };
      ROSTER.set(key, rec);
    });
  }

  // ===== Requests =====
  function normalizeRequests(){
    REQ = [];
    badRows.length = 0;
    REQ_RAW.forEach((r, idx)=>{
      const EmpID = String(pick(r,['EmpID','Emp ID','EmployeeID','Employee ID','EEID','ID'])||'').trim();
      let Name    = normName(pick(r,['Employee Name','Employee','Name','Full Name','Employee Name 1','Employee Name 2'])||'');
      const Email = String(pick(r,['Email','Work Email','Email 1'])||'').trim();
      const key = keyFrom(EmpID, Email, Name);
      if(!Name && key && ROSTER.has(key)) Name = ROSTER.get(key).Name || Name;

      let {start:Start, end:End} = parseDateFlexible(pick(r,['PTO Request Dates','Dates','PTO Date','Date','Start']));
      if(!Start){
        const s2 = parseDateFlexible(pick(r,['PTO Request Start Date','Start Date','Start'])).start;
        const e2 = parseDateFlexible(pick(r,['PTO Request End Date','End Date','End'])).end;
        Start = s2||e2||null; End = e2||s2||null;
      }
      if(End && Start && End<Start){ const t=Start; Start=End; End=t; }

      const sh   = pick(r,['Start AM/PM']) || '';
      const eh   = pick(r,['End AM/PM'])   || '';
      const type = normalizeType(pick(r,['PTO Request Type','Type','Category']));

      const meta = (key && ROSTER.get(key)) || {};
      const dept   = (meta.Department || pick(r,['Department','Team']) || 'Unknown').toString().trim();
      const mgr    = (meta.Manager    || pick(r,['Direct Report','Manager']) || '').toString().trim();
      const status = (meta.Status     || pick(r,['Employment Status','Status']) || '').toString().trim();

      const reasons=[];
      if(!Name && !key) reasons.push('no EmpID/Email/Name');
      if(!Start) reasons.push('no parsable date');
      if(reasons.length){ badRows.push({idx, why: reasons.join(', '), raw:r}); return; }

      REQ.push({ key: key||('NAME:'+Name.toUpperCase()), emp: Name||key, type, s:Start, e:End||Start, sh, eh, dept, mgr, status, raw:r });
    });
  }

  // ===== Filters =====
  function employeeIsIncluded(status){
    const desired = fStatus.value;
    if(desired==='') return true;
    if(desired==='Active') return L(status)==='active';
    if(desired==='Inactive') return L(status)==='inactive';
    return true;
  }
  function passesFilters(r){
    if(!employeeIsIncluded(r.status)) return false;
    const q=L(fSearch.value);
    const dept=L(fDept.value), mgr=L(fMgr.value), type=L(fType.value);
    if(dept && L(r.dept)!==L(dept)) return false;
    if(mgr  && L(r.mgr)!==L(mgr)) return false;
    if(type && L(r.type)!==L(type)) return false;
    if(q){
      const blob=[r.emp,r.dept,r.mgr,r.type,r.status].map(x=>String(x||'').toLowerCase()).join('|');
      if(!blob.includes(q)) return false;
    }
    return true;
  }
  function buildFilterOptions(){
    function setOptions(el, arr){
      const opts=[...new Set(arr.map(x=>String(x||'').trim()).filter(Boolean))].sort();
      el.innerHTML='<option value="">All</option>'+opts.map(v=>`<option>${v}</option>`).join('');
    }
    const depts = new Set(); const mgrs = new Set();
    ROSTER.forEach(m=>{ if(m.Department) depts.add(m.Department); if(m.Manager) mgrs.add(m.Manager); });
    REQ.forEach(r=>{ if(r.dept) depts.add(r.dept); if(r.mgr) mgrs.add(r.mgr); });
    setOptions(fDept, [...depts]);
    setOptions(fMgr,  [...mgrs]);
  }

  function overlapDays(r, rs, re){
    const s = dayStart(r.s), e = dayStart(r.e);
    const S = s<rs?rs:s, E = e>re?re:e;
    if(E<S) return 0;
    const hasHalf = !!(r.sh || r.eh);
    return (Math.floor((E - S)/MS_DAY)+1) * (hasHalf?0.5:1);
  }

  // ===== Render =====
  function renderAll(){
    // Always read inputs with the strict parser
    const rs = parseInputDate(dateFrom.value) || dayStart(new Date());
    const re = parseInputDate(dateTo.value)   || rs;

    if(re < rs){ // auto-correct
      dateTo.value = fmt(rs);
    }

    const rows = REQ
      .map(r=> ({...r, overlapDays: overlapDays(r, rs, re)}))
      .filter(r=> r.overlapDays>0 && passesFilters(r));

    // KPIs
    kpiRequests.textContent = rows.length;
    kpiPeople.textContent   = new Set(rows.map(r=>r.emp)).size;
    kpiDepts.textContent    = new Set(rows.map(r=>r.dept)).size;
    kpiDays.textContent     = rows.reduce((a,r)=>a+r.overlapDays,0).toFixed(1);

    const last14 = addDays(new Date(), -14);
    let sick14=0, vac14=0;
    REQ.forEach(r=>{
      if(!employeeIsIncluded(r.status)) return;
      if(r.s>=last14 && r.s<=new Date()){
        if(r.type==='Sick') sick14++; else if(r.type==='Vacation') vac14++;
      }
    });
    kpiSick14.textContent = sick14;
    kpiVac14.textContent  = vac14;

    // Requests list
    reqList.innerHTML='';
    rows.sort((a,b)=> (a.s-b.s) || a.emp.localeCompare(b.emp)).forEach(r=>{
      const li=document.createElement('li');
      li.innerHTML = `<div>${r.emp} ‚Ä¢ ${r.type}</div>
                      <div><span class="pill">${r.dept}</span> <span class="muted">${fmt(dayStart(r.s))} ‚Üí ${fmt(dayStart(r.e))} ‚Ä¢ ${r.overlapDays}d</span></div>`;
      reqList.appendChild(li);
    });

    renderUsageTable(rows);
    renderDeptChart(rows);
    renderHeatmap(rows, rs, re);
    renderGantt(rows, rs, re);
    renderRosterTable();
    renderBurnout();
    renderDiagnostics();
  }

  function renderUsageTable(rows){
    const use = {};
    rows.forEach(r=>{
      const k = r.key;
      if(!use[k]) use[k] = {name:r.emp, dept:r.dept, vac:0, sick:0, unpaid:0};
      if(r.type==='Vacation') use[k].vac += r.overlapDays;
      else if(r.type==='Sick') use[k].sick += r.overlapDays;
      else if(r.type==='Unpaid') use[k].unpaid += r.overlapDays;
    });

    const entries = [];
    ROSTER.forEach((rec, key)=>{
      if(!employeeIsIncluded(rec.Status)) return;
      const u = use[key] || {name:rec.Name||key, dept:rec.Department||'', vac:0, sick:0, unpaid:0};
      entries.push({
        name: u.name, dept: u.dept,
        vacUsed: (u.vac||0), vacAvail: rec.VacAvail ?? '',
        sickUsed: (u.sick||0), sickAvail: rec.SickAvail ?? '',
        unpUsed: (u.unpaid||0), unpAvail: rec.UnpaidAvail ?? ''
      });
    });

    entries.sort((a,b)=> a.name.localeCompare(b.name));
    empUsageTableBody.innerHTML='';
    entries.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${e.name}</td><td>${e.dept||''}</td>
        <td>${e.vacUsed||0}</td><td>${e.vacAvail!==''?e.vacAvail:'‚Äî'}</td>
        <td>${e.sickUsed||0}</td><td>${e.sickAvail!==''?e.sickAvail:'‚Äî'}</td>
        <td>${e.unpUsed||0}</td><td>${e.unpAvail!==''?e.unpAvail:'‚Äî'}</td>`;
      empUsageTableBody.appendChild(tr);
    });
  }

  function renderDeptChart(rows){
    const mode = chartMode.value;
    if(window._deptBarChart) window._deptBarChart.destroy();

    if(mode==='days'){
      const byDept={}; rows.forEach(r=>{ byDept[r.dept]=(byDept[r.dept]||0)+r.overlapDays; });
      const labels=Object.keys(byDept).sort();
      const data=labels.map(l=>byDept[l]);
      window._deptBarChart = new Chart(deptChart, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Person-Days', data }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    } else {
      const headcountByDept={};
      ROSTER.forEach(m=>{
        if(employeeIsIncluded(m.Status) && L(m.Status)==='active'){
          headcountByDept[m.Department]=(headcountByDept[m.Department]||0)+1;
        }
      });
      const byDeptPeople=new Map();
      rows.forEach(r=>{
        const set = byDeptPeople.get(r.dept) || new Set(); set.add(r.emp); byDeptPeople.set(r.dept,set);
      });

      const labels=Object.keys(headcountByDept).sort();
      const data=labels.map(d=>{
        const tot=headcountByDept[d]||0, outs=(byDeptPeople.get(d)||new Set()).size;
        return tot>0 ? Math.round((1 - outs/tot)*100) : 100;
      });
      window._deptBarChart = new Chart(deptChart, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Coverage %', data }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' } } } }
      });
    }
  }

  function isoWeek(d) {
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    return Math.ceil(((date - yearStart) / MS_DAY + 1)/7);
  }
  const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  function renderHeatmap(rows, rs, re){
    heatmap.innerHTML=''; heatmapLegend.innerHTML='';
    const perDay=[]; let max=0;

    const pad = rs.getDay();
    for(let i=0;i<pad;i++){
      const c=document.createElement('div'); c.className='heatcell'; c.style.visibility='hidden'; heatmap.appendChild(c);
    }

    for(let d=new Date(rs); d<=re; d=addDays(d,1)){
      const d0 = dayStart(d);
      const count = rows.reduce((acc,r)=> acc + ( (dayStart(r.s)<=d0 && dayStart(r.e)>=d0) ? (r.sh||r.eh?0.5:1) : 0 ), 0);
      perDay.push({d:new Date(d0), count}); max=Math.max(max,count);
    }
    const scale = c => {
      if(max<=0) return '#fafafa';
      const t = c/max;
      const a = Math.max(0.08, 0.15 + 0.55*t);
      return `rgba(16,185,129,${a})`;
    };
    heatmapLegend.innerHTML = `<span class="muted">Load:</span>
      <span class="pill" style="border-color:#e5e7eb;background:#fafafa;">0</span>
      <span class="swatch" style="display:inline-block;width:18px;height:12px;border:1px solid #e5e7eb;background:${scale(max*0.33)}"></span>
      <span class="swatch" style="display:inline-block;width:18px;height:12px;border:1px solid #e5e7eb;background:${scale(max*0.66)}"></span>
      <span class="swatch" style="display:inline-block;width:18px;height:12px;border:1px solid #e5e7eb;background:${scale(max)}"></span>
      <span class="muted" style="margin-left:8px;">Sundays show ISO week # ‚Ä¢ First of month has a badge & border.</span>`;

    perDay.forEach(({d,count})=>{
      const cell=document.createElement('div'); cell.className='heatcell';
      cell.style.background=scale(count);
      const firstOfMonth = d.getDate()===1;
      if(firstOfMonth) cell.classList.add('monthTop');
      const isSunday = d.getDay()===0;
      if(isSunday){
        const wk=document.createElement('div'); wk.className='wk'; wk.textContent='W'+isoWeek(d);
        cell.appendChild(wk);
      }
      if(firstOfMonth){
        const mb=document.createElement('div'); mb.className='mo'; mb.textContent=MONTH_NAMES[d.getMonth()];
        cell.appendChild(mb);
      }
      const numberWrap = document.createElement('div');
      numberWrap.innerHTML = `<div class="d" style="margin-top:${isSunday?12:0}px">${d.getDate()}</div><div class="muted" style="font-size:12px;">${count||0}</div>`;
      cell.appendChild(numberWrap);
      heatmap.appendChild(cell);
    });
    heatmapNote.textContent = `${fmt(rs)} ‚Üí ${fmt(re)} ‚Ä¢ Max daily load: ${max}`;
  }

  function renderGantt(rows, rs, re){
    ganttRange.textContent = `${fmt(rs)} ‚Üí ${fmt(re)}`;
    const MAX=150, span=Math.max(1, Math.floor((dayStart(re)-dayStart(rs))/MS_DAY)+1);
    ganttGrid.innerHTML='';
    rows
      .filter(r=>employeeIsIncluded(r.status))
      .slice(0,MAX)
      .sort((a,b)=> a.emp.localeCompare(b.emp) || (a.s-b.s))
      .forEach(r=>{
        const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.borderBottom='1px dashed #eee'; row.style.padding='6px 0'; row.style.height='28px';
        const name=document.createElement('div'); name.style.width='180px'; name.style.flex='0 0 180px'; name.style.fontSize='13px'; name.style.whiteSpace='nowrap'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis'; name.textContent=r.emp;
        const lane=document.createElement('div'); lane.style.position='relative'; lane.style.height='8px'; lane.style.flex='1'; lane.style.background='linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px) 0 0/14px 100% no-repeat'; lane.style.borderRadius='8px';
        const start = dayStart(r.s)<dayStart(rs) ? rs : r.s;
        const end   = dayStart(r.e)>dayStart(re) ? re : r.e;
        const offset = Math.max(0, Math.floor((dayStart(start)-dayStart(rs))/MS_DAY));
        const len = Math.max(0.2, overlapDays(r, rs, re));
        const leftPct = (offset/span)*100, widthPct=(len/span)*100;
        const bar=document.createElement('div'); bar.style.position='absolute'; bar.style.top='-2px'; bar.style.height='12px'; bar.style.borderRadius='8px';
        bar.style.background='#d1fae5'; bar.style.border='1px solid #10b981'; bar.style.left=leftPct+'%'; bar.style.width=widthPct+'%';
        bar.title = `${r.emp} ‚Ä¢ ${r.type} ‚Ä¢ ${fmt(dayStart(r.s))} ‚Üí ${fmt(dayStart(r.e))} (${r.overlapDays}d)`;
        lane.appendChild(bar);
        row.appendChild(name); row.appendChild(lane); ganttGrid.appendChild(row);
      });
  }

  function renderRosterTable(){
    balTableBody.innerHTML='';
    const rows=[];
    ROSTER.forEach(r=>{ if(employeeIsIncluded(r.Status)) rows.push(r); });
    rows.sort((a,b)=> (a.Name||'').localeCompare(b.Name||''));
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.Name||r.EmpID||r.Email||r.key}</td>
        <td>${r.Department||''}</td>
        <td>${r.Manager||''}</td>
        <td>${r.Status||''}</td>
        <td>${r.VacAvail||''}</td>
        <td>${(r.DaysSinceAny??'')!==''?r.DaysSinceAny:''}</td>
        <td>${r.Risk||''}</td>`;
      balTableBody.appendChild(tr);
    });
  }

  function renderBurnout(){
    const today = dayStart(new Date());
    const last14 = addDays(today, -14);
    const byKey = new Map();
    function ensure(key, name){
      if(!byKey.has(key)) byKey.set(key, {name, lastAny:null, lastVac:null, sick14:0, vac14:0, status: (ROSTER.get(key)||{}).Status||''});
      return byKey.get(key);
    }
    REQ.forEach(r=>{
      if(!employeeIsIncluded(r.status)) return;
      const s = ensure(r.key, r.emp);
      if(!s.lastAny || r.s > s.lastAny) s.lastAny = r.s;
      if(r.type!=='Sick'){ if(!s.lastVac || r.s > s.lastVac) s.lastVac = r.s; }
      if(r.s>=last14 && r.s<=today){
        if(r.type==='Sick') s.sick14++; else s.vac14++;
      }
    });
    const allKeys = [];
    ROSTER.forEach((rec,k)=>{ if(employeeIsIncluded(rec.Status)) allKeys.push(k); });
    const items=[];
    allKeys.forEach(k=>{
      const rec = ROSTER.get(k)||{};
      const s = byKey.get(k)||{name:(rec.Name||k), lastAny:null, lastVac:null, sick14:0, vac14:0};
      const daysSinceAny = s.lastAny ? Math.floor((today - dayStart(s.lastAny))/MS_DAY) : (rec.DaysSinceAny!=null? rec.DaysSinceAny : null);
      const daysSinceVac = s.lastVac ? Math.floor((today - dayStart(s.lastVac))/MS_DAY) : null;
      const anyCut=12, vacCut=45;
      let risk='OK';
      if((daysSinceAny??999) >= anyCut || (daysSinceVac??999) >= vacCut) risk='Watch';
      if((daysSinceAny??999) >= anyCut && (daysSinceVac??999) >= vacCut) risk='High';
      items.push({ name: s.name, dept: rec.Department||'', mgr: rec.Manager||'', sick14: s.sick14, vac14: s.vac14, daysSinceAny, daysSinceVac, risk });
    });
    items.sort((a,b)=> ({High:0,Watch:1,OK:2}[a.risk]-({High:0,Watch:1,OK:2}[b.risk]) || (b.daysSinceVac??-1)-(a.daysSinceVac??-1));
    const ul=document.getElementById('burnoutList');
    ul.innerHTML='';
    items.forEach(x=>{
      const cls = x.risk==='High'?'bad':(x.risk==='Watch'?'warn':'ok');
      const li=document.createElement('li');
      li.innerHTML = `<div>${x.name} ‚Ä¢ <span class="pill">${x.dept||''}</span> <span class="muted">${x.mgr||''}</span></div>
                      <div><span class="pill">Any: ${x.daysSinceAny==null?'‚Äî':x.daysSinceAny}d</span>
                           <span class="pill">Vac: ${x.daysSinceVac==null?'‚Äî':x.daysSinceVac}d</span>
                           <span class="pill">Sick14: ${x.sick14}</span>
                           <span class="pill">Vac14: ${x.vac14}</span>
                           <span class="pill status ${cls}">${x.risk}</span></div>`;
      ul.appendChild(li);
    });
    document.getElementById('burnoutCount').textContent = items.filter(i=>i.risk!=='OK').length;
  }

  function renderDiagnostics(){
    const colsReq = Object.keys(REQ_RAW?.[0]||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
    const colsEmp = Object.keys(EMP_REF_RAW?.[0]||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
    const colsInfo= Object.keys(PTO_INFO_RAW?.[0]||{}).map(c=>c.replace(/\uFEFF/g,'').trim());
    colInspector.textContent = `Detected columns ‚Äî PTO Requests: [${colsReq.join(', ')}] ‚Ä¢ Employee Reference: [${colsEmp.join(', ')}] ‚Ä¢ PTO Employee Info: [${colsInfo.join(', ')}]`;
    badRowsBox.innerHTML = badRows.length ? badRows.slice(0,150).map(b=>{
      const sample = JSON.stringify(b.raw);
      return `<div class="badrow">Row#${b.idx+1} ‚Ä¢ ${b.why}\n${sample}</div>`;
    }).join('') : '<div class="muted">No skipped rows üéâ</div>';
    if(badRows.length>150){
      const more=document.createElement('div'); more.className='muted'; more.textContent=`+ ${badRows.length-150} more‚Ä¶`; badRowsBox.appendChild(more);
    }
  }

  // ===== INIT =====
  async function init(){
    const t=new Date();
    // Always seed inputs with valid strings before any render calls
    dateFrom.value = fmt(dayStart(t));
    dateTo.value   = fmt(dayStart(addDays(t,7)));
    asOf.textContent = new Date().toLocaleString();

    try{
      [REQ_RAW, EMP_REF_RAW, PTO_INFO_RAW] = await Promise.all([
        loadCSV(REQUESTS_CSV), loadCSV(EMP_REF_CSV), loadCSV(PTO_INFO_CSV)
      ]);
    }catch(e){
      console.error(e);
    }

    ROSTER.clear();
    harvestEmpRows(EMP_REF_RAW||[]);
    harvestEmpRows(PTO_INFO_RAW||[]);

    normalizeRequests();
    buildFilterOptions();
    renderAll();
  }

  // Events
  refreshBtn.addEventListener('click', init);
  [dateFrom,dateTo,fDept,fMgr,fType,fStatus,chartMode].forEach(el=> el.addEventListener('change', renderAll));
  fSearch.addEventListener('input', renderAll);

  // Quick ranges (use fmt() always)
  rngToday.addEventListener('click', ()=>{ const t=dayStart(new Date()); setRange(t,t); });
  rng7.addEventListener('click', ()=>{ const t=dayStart(new Date()); setRange(t, addDays(t,7)); });
  rng14.addEventListener('click', ()=>{ const t=dayStart(new Date()); setRange(t, addDays(t,14)); });
  rng30.addEventListener('click', ()=>{ const t=dayStart(new Date()); setRange(t, addDays(t,30)); });
  rngMonth.addEventListener('click', ()=>{
    const t=new Date();
    const start=new Date(t.getFullYear(), t.getMonth(), 1);
    const end=new Date(t.getFullYear(), t.getMonth()+1, 0);
    setRange(start,end);
  });

  // Defer init until the page is fully loaded to avoid any race
  window.addEventListener('load', init);
</script>
</body>
</html>
